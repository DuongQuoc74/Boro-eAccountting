@page "/hoadonbanhangkiemphieuxuatkho/create"
@using Blazored.LocalStorage
@using System.ComponentModel.DataAnnotations
@using Syncfusion.Blazor.Data
@using Volo.Abp.ObjectMapping
@using tamkhoatech.ACWeb.Blazor.Pages.Common
@using tamkhoatech.ACWeb.Constants
@using tamkhoatech.ACWeb.Dto
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.DropDowns
@using tamkhoatech.ACWeb.IService
@using tamkhoatech.ACWeb.IService.IQuanLyBanHang
@using tamkhoatech.ACWeb.IService.IQuanLyHeThong
@using tamkhoatech.ACWeb.IService.IUtilities

@inject IJSRuntime JSRunTime
@inject ILocalStorageService _localStorage
@inject IObjectMapper _objectMapper
@inject NavigationManager NavigationManager
@inject IPhieuXuatService _phieuXuat
@inject IChiNhanhService _chiNhanh
@inject IKhachHangService _khachHang
@inject IQuyenSoService _quyenSo
@inject ITaiKhoanService _taiKhoan
@inject INgoaiTeService _ngoaiTe
@inject IVatTuService _vatTu
@inject IKhoService _kho
@inject IVuViecService _vuViec
@inject IDmMaPhiService _dmMaPhi
@inject ICongTrinhService _congTrinh
@inject IThueSuatService _thueSuat
@inject IThamSoHeThongService _thamSo
@inject ICommonService _common
@inject tamkhoatech.ACWeb.IService.IQuanLyKho.ICommonService _commonKho
@inject IBoPhanService _boPhan

<link rel="stylesheet" href="/Css/them-sua-phieu.css">
@if (hasRefreshed)
{
    <div @onkeyup="@OnKeyUp" @onblur="FocusOnInput">
        <div class="row title">
            <div class="text-center">
                <div class="row align-items-start">
                    <h4><strong>Thêm mới hóa đơn bán hàng kiêm phiếu xuất kho</strong></h4>
                </div>
            </div>
        </div>
        <EditForm Model="SelectPhieuXuat" Context="EditFormHDA" OnValidSubmit="@SaveAsync">
            <DataAnnotationsValidator />
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <div class="row">
                            <div class="col-sm-4 ">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="ChiNhanhId" class="form-label">Mã chi nhánh <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="d-flex align-items-center">
                                                <SfComboBox @ref="ddCN" @bind-Value="@SelectPhieuXuat.ChiNhanhId" DataSource="@ChiNhanhDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="700" PopupHeight="300">
                                                    <ComboBoxEvents TValue="int?" TItem="ChiNhanhDto" Filtering="OnFilteringChiNhanh" ValueChange="OnValueChangeChiNhanh"></ComboBoxEvents>
                                                    <ComboBoxFieldSettings Value="Id" Text="ChiNhanhUd" />
                                                    <ComboBoxTemplates TItem="ChiNhanhDto">
                                                        <HeaderTemplate>
                                                            <table class="header-combo">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width:150px">Mã chi nhánh</th>
                                                                        <th>Tên chi nhánh</th>
                                                                        <th>Tên 2</th>
                                                                    </tr>
                                                                </thead>
                                                            </table>
                                                        </HeaderTemplate>
                                                        <ItemTemplate Context="itemContext">
                                                            <table>
                                                                <tbody>
                                                                    <tr>
                                                                        <td style="width:150px"><span>@((itemContext as ChiNhanhDto).ChiNhanhUd)</span></td>
                                                                        <td><span>@((itemContext as ChiNhanhDto).ChiNhanhNm)</span></td>
                                                                        <td><span>@((itemContext as ChiNhanhDto).ChiNhanhNm2)</span></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </ItemTemplate>
                                                    </ComboBoxTemplates>
                                                </SfComboBox>
                                                <SfTooltip ID="TaoCN" Target="#target" Content="Thêm chi nhánh" Position="Position.RightTop" OpensOn="Hover">
                                                    <button id="target" type="button" class="btn-them-nhanh" @onclick="TaoChiNhanh" disabled="@IsDisabled">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                        </svg>
                                                    </button>
                                                </SfTooltip>
                                            </div>
                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="ChiNhanhNm" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.ChiNhanhNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="KhachHangId" class="form-label">Mã khách hàng <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                                <div class="d-flex align-items-center">
                                                    <SfComboBox @ref="ddKH" @bind-Value="@SelectPhieuXuat.KhachHangId" DataSource="@KhachHangDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="1000" PopupHeight="300">
                                                    <ComboBoxEvents TValue="int?" TItem="KhachHangDto" Filtering="OnFilteringKhachHang" ValueChange="OnValueChangeKhachHang"></ComboBoxEvents>
                                                        <ComboBoxFieldSettings Text="KhachHangUd" Value="Id"></ComboBoxFieldSettings>
                                                        <ComboBoxTemplates TItem="KhachHangDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <tr>
                                                                        <th style="width:150px">Mã khách hàng</th>
                                                                        <th>Tên khách</th>
                                                                        <th style="width:150px">Mã số thuế</th>
                                                                        <th style="width:150px">Số dư</th>
                                                                        <th>Địa chỉ</th>
                                                                    </tr>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).KhachHangUd)</span></td>
                                                                            <td><span>@((itemContext as KhachHangDto).KhachHangNm)</span></td>
                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).MaSoThue)</span></td>
                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).Sodu?.ToString("N0"))</span></td>
                                                                            <td><span>@((itemContext as KhachHangDto).DiaChi)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                    <SfTooltip ID="TaoKH" Target="#target" Content="Thêm khách hàng" Position="Position.RightTop" OpensOn="Hover">
                                                        <button id="target" type="button" class="btn-them-nhanh" @onclick="TaoKhachHang" disabled="@IsDisabled">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                            </svg>
                                                        </button>
                                                    </SfTooltip>
                                                </div>

                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="KhachHangNm" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.KhachHangNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="DiaChi" class="form-label">Địa chỉ</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="DiaChi" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.DiaChi)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="MaSoThue" class="form-label">Mã số thuế</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="MaSoThue" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.MaSoThue)" Enabled="false"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="Sodu" class="form-label">Số dư</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfNumericTextBox ShowSpinButton="false" ID="Sodu" Format="N0" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.SoDu)" Enabled="false"></SfNumericTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="NguoiGiaoHang" class="form-label">Người mua hàng</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="NguoiGiaoHang" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.NguoiMuaHang)" Enabled="!IsDisabled"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="QuyenSo" class="form-label">Quyển sổ</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <div class="d-flex align-items-center">
                                                        <SfComboBox @ref="ddQS" @bind-Value="@SelectPhieuXuat.QuyenSo" DataSource="@QuyenSoDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="700" PopupHeight="300">
                                                            <ComboBoxEvents TValue="string" TItem="QuyenSoDto" Filtering="OnFilteringQuyenSo" ValueChange="OnValueChangeQuyenSo"></ComboBoxEvents>
                                                            <ComboBoxFieldSettings Text="SoQuyen" Value="SoQuyen"></ComboBoxFieldSettings>
                                                            <ComboBoxTemplates TItem="QuyenSoDto">
                                                                <HeaderTemplate>
                                                                    <table class="header-combo">
                                                                        <tr>
                                                                            <th>Mã ct</th>
                                                                            <th>Số quyển</th>
                                                                            <th>Số ct hiện tại</th>
                                                                            <th>Sử dụng</th>
                                                                        </tr>
                                                                    </table>
                                                                </HeaderTemplate>
                                                                <ItemTemplate Context="itemContext">
                                                                    <table>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td><span>@((itemContext as QuyenSoDto).MaCt)</span></td>
                                                                                <td><span>@((itemContext as QuyenSoDto).SoQuyen)</span></td>
                                                                                <td><span>@((itemContext as QuyenSoDto).SoCtHienTai)</span></td>
                                                                                <td><span>@((itemContext as QuyenSoDto).IsUser)</span></td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ItemTemplate>
                                                            </ComboBoxTemplates>
                                                        </SfComboBox>
                                                        <SfTooltip ID="TaoQS" Target="#target" Content="Thêm quyển sổ" Position="Position.RightTop" OpensOn="Hover">
                                                            <button id="target" type="button" class="btn-them-nhanh" disabled="@IsDisabled">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                                </svg>
                                                            </button>
                                                        </SfTooltip>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="SoCt" class="form-label">Số chứng từ</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="SoCt" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.SoCt)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>                                      
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgayHt" class="form-label">Ngày hạch toán <span class="text-danger">*</span></label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfDatePicker TValue="DateTime?" CssClass="e-small" ShowClearButton="true" @bind-Value="@(SelectPhieuXuat.NgayHt)" Format="dd/MM/yyyy" FullScreen="true" Enabled="!IsDisabled">
                                                        <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayht"></DatePickerEvents>
                                                    </SfDatePicker>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgayLap" class="form-label">Ngày lập</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfDatePicker ID="NgayLap" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.NgayLap)" Format="dd/MM/yyyy" Enabled="false"></SfDatePicker>
                                                </div>
                                            </div>
                                        </div>                                        
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="GhiChu" class="form-label">Ghi chú hóa đơn</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="GhiChu" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.GhiChu)" Enabled="!IsDisabled"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="GhiNoTk" class="form-label">Ghi nợ tài khoản <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfComboBox @ref="ddTK" @bind-Value="@SelectPhieuXuat.GhiNoTk" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="800" PopupHeight="300">
                                                <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTaiKhoan" ValueChange="OnValueChangeTaiKhoan"></ComboBoxEvents>
                                                <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                <ComboBoxTemplates TItem="TaiKhoanDto">
                                                    <HeaderTemplate>
                                                        <table class="header-combo">
                                                            <tr>
                                                                <th style="width:150px">Mã tài khoản</th>
                                                                <th>Tên tài khoản</th>
                                                                <th>Tên 2</th>
                                                            </tr>
                                                        </table>
                                                    </HeaderTemplate>
                                                    <ItemTemplate Context="itemContext">
                                                        <table>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                    <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                    <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </ItemTemplate>
                                                </ComboBoxTemplates>
                                            </SfComboBox>
                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="GhiCoTkNm" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.GhiNoTkNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="DienGiai" class="form-label">Diễn giải</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="DienGiai" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.DienGiai)" Enabled="!IsDisabled"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="KyHieuMauHD" class="form-label">Ký hiệu mẫu hóa đơn</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="KyHieuMauHD" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.KyHieuMauHD)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="SoSeri" class="form-label">Ký hiệu hóa đơn</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="SoSeri" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.SoSeri)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="SoHd" class="form-label">Số hóa đơn</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="SoHd" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.SoHd)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="HinhThucTt" class="form-label">Hình thức thanh toán</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="HinhThucTt" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.HinhThucTt)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="BoPhanId" class="form-label">Bộ phận kinh doanh</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="d-flex align-items-center">
                                                <SfComboBox @ref="ddBP" @bind-Value="@SelectPhieuXuat.BoPhanId" DataSource="@BoPhanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="700" PopupHeight="300">
                                                    <ComboBoxEvents TValue="int?" TItem="BoPhanDto" Filtering="OnFilteringBoPhan" ValueChange="OnValueChangeBoPhan"></ComboBoxEvents>
                                                    <ComboBoxFieldSettings Value="Id" Text="BoPhanUd" />
                                                    <ComboBoxTemplates TItem="BoPhanDto">
                                                        <HeaderTemplate>
                                                            <table class="header-combo">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Mã bộ phận</th>
                                                                        <th style="width:300px">Tên bộ phận</th>
                                                                        <th>Tên 2</th>
                                                                    </tr>
                                                                </thead>
                                                            </table>
                                                        </HeaderTemplate>
                                                        <ItemTemplate Context="itemContext">
                                                            <table>
                                                                <tbody>
                                                                    <tr>
                                                                        <td><span>@((itemContext as BoPhanDto).BoPhanUd)</span></td>
                                                                        <td style="width:300px"><span>@((itemContext as BoPhanDto).BoPhanNm)</span></td>
                                                                        <td><span>@((itemContext as BoPhanDto).BoPhanNm2)</span></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </ItemTemplate>
                                                    </ComboBoxTemplates>
                                                </SfComboBox>
                                            </div>
                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="BoPhanNm" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.BoPhanNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="NgoaiTeId" class="form-label">Tỷ giá <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="d-flex align-items-center">
                                                <SfComboBox @ref="ddNT" @bind-Value="@SelectPhieuXuat.NgoaiTeId" DataSource="@NgoaiTeDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="350" PopupHeight="300">
                                                    <ComboBoxEvents TValue="int?" TItem="NgoaiTeDto" Filtering="OnFilteringNgoaiTe" ValueChange="OnValueChangeNgoaiTe"></ComboBoxEvents>
                                                    <ComboBoxFieldSettings Text="NgoaiTeUd" Value="Id"></ComboBoxFieldSettings>
                                                    <ComboBoxTemplates TItem="NgoaiTeDto">
                                                        <HeaderTemplate>
                                                            <table class="header-combo">
                                                                <tr>
                                                                    <th>Mã ngoại tệ</th>
                                                                    <th>Tên ngoại tệ</th>
                                                                    <th>Tên 2</th>
                                                                </tr>
                                                            </table>
                                                        </HeaderTemplate>
                                                        <ItemTemplate Context="itemContext">
                                                            <table>
                                                                <tbody>
                                                                    <tr>
                                                                        <td><span>@((itemContext as NgoaiTeDto).NgoaiTeUd)</span></td>
                                                                        <td><span>@((itemContext as NgoaiTeDto).NgoaiTeNm)</span></td>
                                                                        <td><span>@((itemContext as NgoaiTeDto).NgoaiTeNm2)</span></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </ItemTemplate>
                                                    </ComboBoxTemplates>
                                                </SfComboBox>
                                                <SfTooltip ID="TaoTG" Target="#target" Content="Thêm tỷ giá" Position="Position.RightTop" OpensOn="Hover">
                                                    <button id="target" type="button" class="btn-them-nhanh" disabled="@IsDisabled">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                        </svg>
                                                    </button>
                                                </SfTooltip>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TyGia" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.TiGia)" Format="N2" Enabled="!IsCheckNgoaiTe ? IsCheckNgoaiTe : !IsDisabled"></SfNumericTextBox>
                                        </div>
                                        <div class="col-sm-4">
                                            <button style="width: 100%;" type="button" class="btn btn-sm btn-them-xoa" disabled="@(!IsDisabled)" @onclick="TaoPhieuThuAsync"> <strong>Tạo phiếu thu</strong></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfCheckBox Label="Xuất theo giá vốn đích danh cho vật tư giá trung bình" @bind-Checked="SelectPhieuXuat.IsGiaVonDD" @onchange="OnValueChangeXuatGiaDD" Disabled="IsDisabled"></SfCheckBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfCheckBox Label="Sửa tiền thuế" @bind-Checked="SelectPhieuXuat.IsSuaTienThue" @onchange="OnValueChangeSuaTienThue" Disabled="IsDisabled"></SfCheckBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfCheckBox Label="Sửa tiền" @bind-Checked="SelectPhieuXuat.IsSuaTien" @onchange="OnValueChangeSuaTien" Disabled="IsDisabled"></SfCheckBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <SfTab>
                            <TabItems>
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Chi tiết hạch toán"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <SfGrid @ref="SfGridPhieuXuatCt" @attributes="@GridAttributes" DataSource="@PhieuXuatCtRequests" AllowSorting="true" AllowResizing="true" Height="200">
                                            <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom"></GridEditSettings>
                                            <GridEvents Created="CreatedPhieuXuatCt" OnActionBegin="ActionBeginPhieuXuatDcKhoCt" OnActionComplete="ActionCompletedPhieuXuatDcKhoCt" RowUpdating="RowUpdatingHandler" OnRecordDoubleClick="RecordDoubleClickHandler" TValue="PhieuXuatCtRequest"></GridEvents>
                                            <GridColumns>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Left" Width="60"></GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.VatTuId) TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                       Mã vật tư <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddVTCt" @bind-Value="@(item.VatTuId)" DataSource="@VatTuDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1100" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="VatTuDto" Created="CreatedVatTuCtHandler" Filtering="OnFilteringVatTuCt" ValueChange="OnValueChangeVatTuCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="VatTuUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="VatTuDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th >Mã vt</th>
                                                                                    <th style="width:300px">Tên vt</th>
                                                                                    <th>Đơn vị tính</th>
                                                                                    <th>Tk vật tư</th>                    
                                                                                    <th>Tk giá vốn</th>                    
                                                                                    <th>Tk doanh thu</th>                    
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td><span>@((itemContext as VatTuDto).VatTuUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as VatTuDto).VatTuNm)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).DonViTinh)</span></td>                         
                                                                                        <td><span>@((itemContext as VatTuDto).TkKhoUd)</span></td>                                                                       
                                                                                        <td><span>@((itemContext as VatTuDto).TkGiaVonUd)</span></td>                                                                       
                                                                                        <td><span>@((itemContext as VatTuDto).TkDoanhThuUd)</span></td>                                                                       
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            <div>@item?.VatTuUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.VatTuNm) HeaderText="Tên vật tư" TextAlign="TextAlign.Left" Width="300">
                                                    <EditTemplate>
                                                        <SfTextBox Value="@TempChiTiet.VatTuNm" Enabled="false"></SfTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.DonViTinh) HeaderText="Đơn vị tính" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        <SfTextBox Value="@TempChiTiet.DonViTinh" Enabled="false"></SfTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.KhoId)  TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Mã kho <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddKCt" @bind-Value="@(item.KhoId)" DataSource="@KhoDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="KhoDto" Filtering="OnFilteringKhoCt" ValueChange="OnValueChangeKhoCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="KhoUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="KhoDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th>Mã kho</th>
                                                                                    <th style="width:300px">Tên kho</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td><span>@((itemContext as KhoDto).KhoUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as KhoDto).KhoNm)</span></td>
                                                                                        <td><span>@((itemContext as KhoDto).KhoNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            <div>@item?.KhoUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.SoLuong) HeaderText="Số lượng" TextAlign="TextAlign.Right" Format="N0" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.SoLuong" @onchange="OnValueChangeSoLuong" Format="N0"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.Gia) HeaderText="Đơn giá ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.Gia" @onchange="OnValueChangeGia" Enabled="@(SelectPhieuXuat.IsSuaTien == true ? false : true)" Format="N2"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.GiaVND) HeaderText="Đơn giá" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.GiaVND" @onchange="OnValueChangeGiaVND" Enabled="@(IsCheckNgoaiTe ? false : (SelectPhieuXuat.IsSuaTien == true ? false : true))" Format="N2"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.Tien) HeaderText="Thành tiền ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.Tien"  @onchange="OnValueChangeTienVND"  Enabled="@(SelectPhieuXuat.IsSuaTien == false ? false : true)" Format="N2"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienVND) HeaderText="Thành tiền" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienVND" @onchange="OnValueChangeTienVND" Enabled="@(SelectPhieuXuat.IsSuaTien == false ? false : (IsCheckNgoaiTe == true ? false : true))" Format="N2"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TyLeCk) HeaderText="Tỷ lệ chiết khấu" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TyLeCk" Format="N2" @onchange="OnValueChangeTyLeCk"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienCk) HeaderText="Thành tiền chiết khấu ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienCk"  Format="N2" Enabled="false"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienCkVND) HeaderText="Thành tiền chiết khấu" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienCkVND" Format="N2" Enabled="false" ></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TkChietKhau) TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Tài khoản chiết khấu 
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddTKCKCt" @bind-Value="@(item.TkChietKhau)" DataSource="@TaiKhoanDtos" Enabled="IsCheckTyLeCk" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTaiKhoanCkCt" ValueChange="OnValueChangeTaiKhoanCkCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã tài khoản</th>
                                                                                    <th>Tên tài khoản</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            <div>@item?.TkChietKhauUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.ThueSuatId) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Mã thuế <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddTSCt" @bind-Value="@(TempChiTiet.ThueSuatId)" DataSource="@ThueSuatDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="ThueSuatDto" Filtering="OnFilteringThueSuatCt" ValueChange="OnValueChangeThueSuatCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="ThueSuatUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="ThueSuatDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th>Mã thuế</th>
                                                                                    <th style="width:250px">Tên thuế</th>
                                                                                    <th>Tên 2</th>
                                                                                    <th>Thuế suất</th>
                                                                                    <th>Tk có</th>
                                                                                    <th>Tk nợ</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td><span>@((itemContext as ThueSuatDto).ThueSuatUd)</span></td>
                                                                                        <td style="width:250px"><span>@((itemContext as ThueSuatDto).ThueSuatNm)</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).ThueSuatNm2)</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).GiaTri?.ToString("N2"))</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).TkCoUd)</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).TkNoUd)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                item.ThueSuatId = TempChiTiet.ThueSuatId;
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            <div>@item?.ThueSuatUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.ThueSuat) HeaderText="Thuế suất" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.ThueSuat" Format="N2" Enabled="false"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.Thue) HeaderText="Tiền thuế ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.Thue" Format="N2" Enabled="SelectPhieuXuat.IsSuaTienThue == true" @onchange="OnValueChangeTienThue"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.ThueVND) HeaderText="Tiền thuế" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.ThueVND" Format="N2" @onchange="OnValueChangeTienThueVND" Enabled="@(SelectPhieuXuat.IsSuaTienThue == false  ? false : (!IsCheckNgoaiTe ? true : (TempChiTiet?.Thue == 0 ? true : false)))"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienSauThue) HeaderText="Tiền sau thuế ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienSauThue" Format="N2" Enabled="false"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienSauThueVND) HeaderText="Tiền sau thuế" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienSauThueVND" Format="N2" Enabled="false"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TkThue) TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Tài khoản thuế <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddTKTCt" @bind-Value="@(TempChiTiet.TkThue)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTkThueCt" ValueChange="OnValueChangeTkThueCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã tài khoản</th>
                                                                                    <th>Tên tài khoản</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            <div>@item?.TkThueUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TkDoanhThu) HeaderText="Tài khoản doanh thu" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        <SfComboBox @ref="ddTKDTCt" @bind-Value="@(TempChiTiet.TkDoanhThu)" DataSource="@TaiKhoanDtos" Enabled="false" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                            <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                            <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                <HeaderTemplate>
                                                                    <table class="header-combo">
                                                                        <tr>
                                                                            <th style="width:150px">Mã tài khoản</th>
                                                                            <th>Tên tài khoản</th>
                                                                            <th>Tên 2</th>
                                                                        </tr>
                                                                    </table>
                                                                </HeaderTemplate>
                                                                <ItemTemplate Context="itemContext">
                                                                    <table>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ItemTemplate>
                                                            </ComboBoxTemplates>
                                                        </SfComboBox>                                               
                                                    </EditTemplate>
                                                    <Template>
                                                            <div>@TempChiTiet?.TkDoanhThuUd</div>
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TkKho) HeaderText="Tài khoản kho" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>        
                                                        <SfComboBox @ref="ddTKKCt" @bind-Value="@(TempChiTiet.TkKho)" DataSource="@TaiKhoanDtos" Enabled="false" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                            <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                            <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                <HeaderTemplate>
                                                                    <table class="header-combo">
                                                                        <tr>
                                                                            <th style="width:150px">Mã tài khoản</th>
                                                                            <th>Tên tài khoản</th>
                                                                            <th>Tên 2</th>
                                                                        </tr>
                                                                    </table>
                                                                </HeaderTemplate>
                                                                <ItemTemplate Context="itemContext">
                                                                    <table>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ItemTemplate>
                                                            </ComboBoxTemplates>
                                                        </SfComboBox>
                                                    </EditTemplate>
                                                    <Template>
                                                            <div>@TempChiTiet?.TkKhoUd</div>
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TkGiaVon) HeaderText="Tài khoản giá vốn" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                 
                                                        <SfComboBox @ref="ddTKGVCt" @bind-Value="@(TempChiTiet.TkKho)" DataSource="@TaiKhoanDtos" Enabled="false" AllowFiltering ="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                            <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                            <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                <HeaderTemplate>
                                                                    <table class="header-combo">
                                                                        <tr>
                                                                            <th style="width:150px">Mã tài khoản</th>
                                                                            <th>Tên tài khoản</th>
                                                                            <th>Tên 2</th>
                                                                        </tr>
                                                                    </table>
                                                                </HeaderTemplate>
                                                                <ItemTemplate Context="itemContext">
                                                                    <table>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ItemTemplate>
                                                            </ComboBoxTemplates>
                                                        </SfComboBox>
                                                    
                                                    </EditTemplate>
                                                    <Template>
                                                        <div>@TempChiTiet?.TkGiaVonUd</div>
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.GiaVon) HeaderText="Đơn giá vốn ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.GiaVon" @onchange="OnValueChangeGiaVon" Format="N2" Enabled="@(SelectPhieuXuat.IsGiaVonDD == true)"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.GiaVonVND) HeaderText="Đơn giá vốn" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.GiaVonVND"  @onchange="OnValueChangeGiaVonVND" Format="N2" Enabled="@(SelectPhieuXuat.IsGiaVonDD == false ? false : (!IsCheckNgoaiTe ? true : (TempChiTiet?.GiaVon != 0 ? false : true)))"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienVon) HeaderText="Thành tiền vốn ngoại tệ" Visible="IsCheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienVon" Format="N2" Enabled="false"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.TienVonVND) HeaderText="Thành tiền vốn" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        <SfNumericTextBox ShowSpinButton="false" Value="TempChiTiet?.TienVonVND" Format="N2" Enabled="false"></SfNumericTextBox>
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuXuatCtRequest.VuViecId) HeaderText="Mã vụ việc" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddVVCt" @bind-Value="@(TempChiTiet.VuViecId)" DataSource="@VuViecDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="VuViecDto" Filtering="OnFilteringVuViecCt" ValueChange="OnValueChangeVuViecCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="VuViecUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="VuViecDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã vụ việc</th>
                                                                                    <th style="width:300px">Tên vụ việc</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as VuViecDto).VuViecUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as VuViecDto).VuViecNm)</span></td>
                                                                                        <td><span>@((itemContext as VuViecDto).VuViecNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuXuatCtRequest);
                                                            <div>@item?.VuViecUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                            </GridColumns>
                                        </SfGrid>
                                    </ContentTemplate>
                                </TabItem>
                            </TabItems>
                        </SfTab>
                        <div class="d-flex align-items-Left">
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="AddRowCtAsync" disabled="@IsDisabled">Thêm dòng <b>F4</b></button>
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="DeleteRowCtAsync" disabled="@IsDisabled">Xóa dòng <b>F8</b> </button>
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="CancelCtAsync" disabled="@IsDisabled">Hủy thao tác <b>F9</b></button>
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="XemPhieuNhap" disabled="@IsDisabled">Xem phiếu nhập <b>F5</b></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <div class="row">
                            <div class="col-sm-1">
                            </div>
                            <div class="col-sm-3">
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="SoLuong" class="form-label">Số lượng</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfNumericTextBox ShowSpinButton="false" ID="SoLuong" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.SoLuong)" Format="N0" Min="0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="ThueSuatUd" class="form-label">Mã thuế</label>
                                        </div>
                                        <div class="col-sm-6">
                                            <SfTextBox ID="ThueSuatUd" CssClass="e-small" @bind-Value="@(SelectPhieuXuat.ThueSuatUd)" Enabled="false"></SfTextBox>
                                        </div>
                                        <div class="col-sm-6">
                                            <SfNumericTextBox ShowSpinButton="false" ID="ThueSuat" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.ThueSuat)" Format="N2" Enabled="false"></SfNumericTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="TkThueVat" class="form-label">Tài khoản thuế</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfComboBox @bind-Value="@SelectPhieuXuat.TkThueVat" DataSource="@TaiKhoanDtos" Autofill="true" AllowCustom="false" Enabled="(IsDisabled ? false : (SelectPhieuXuat.IsSuaTkThue == true ? true : false))" CssClass="e-multi-column e-small" PopupWidth="800" PopupHeight="300">
                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <tr>
                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                        <th>Tên tài khoản</th>
                                                                        <th>Tên 2</th>
                                                                    </tr>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="TkThueVatDu" class="form-label">Tk thuế đ/ứng</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfComboBox @bind-Value="@SelectPhieuXuat.TkThueVatDu" DataSource="@TaiKhoanDtos" Autofill="true" AllowCustom="false" Enabled="(IsDisabled ? false : (SelectPhieuXuat.IsSuaTkThue == true ? true : false))" CssClass="e-multi-column e-small" PopupWidth="800" PopupHeight="300">
                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <tr>
                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                        <th>Tên tài khoản</th>
                                                                        <th>Tên 2</th>
                                                                    </tr>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="TienVonVND" class="form-label">Tiền vốn</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TienVonVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienVonVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="TienVon" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienVon)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="TienHangVND" class="form-label">Tiền hàng</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TienHangVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienHangVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="TienHang" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienHang)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="ThueVatVND" class="form-label">Tiền thuế</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="ThueVatVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.ThueVatVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="ThueVat" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.ThueVat)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="TienChietKhauVND" class="form-label">Tiền chiết khấu</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="ChiPhiVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienChietKhauVND)" Format="N0" Enabled="(IsDisabled ? false : (SelectPhieuXuat.IsSuaTienCk == true ? true : false))"@onchange="OnValueChangeTienChietKhauVND"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="TienChietKhau" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienChietKhau)" Format="N2" Enabled="(IsDisabled ? false : (SelectPhieuXuat.IsSuaTienCk == true ? true : false))" @onchange="OnValueChangeTienChietKhau"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="TienHangCkVND" class="form-label">Tiền hàng - Chiết khấu</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TienHangCkVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienHangCkVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="TienHangCk" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TienHangCk)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="ThueVatVND" class="form-label">Tiền thuế</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="ThueVatVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.ThueVatVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="ThueVat" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.ThueVat)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <label for="TongTienVND" class="form-label">Tổng thanh toán</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TongTienVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TongTienVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (IsCheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="TongTienVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuXuat.TongTien)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <FooterMenu IsSave="true" IsSaveDisabled="IsSaveDisabled" IsCancel="true" IsCancelDisabled="IsCancelDisabled" OnValidSubmitCancel="Cancel"
                        IsAdd="true" IsAddDisabled="IsAddDisabled" OnValidSubmitAdd="Add"
                        IsEdit="true" IsEditDisabled="IsEditDisabled" OnValidSubmitEdit="Edit"
                        IsDelete="true" IsDeleteDisabled="IsDeleteDisabled" OnValidSubmitDelete="Delete"
                        IsPrint="true" IsPrintDisabled="IsPrintDisabled"
                        IsCopy="true" IsCopyDisabled="IsCopyDisabled" OnValidSubmitCopy="Copy"
                        IsClose="true" IsCloseDisabled="IsCloseDisabled" OnValidSubmitClose="Close"
                        IsNextDisabled="IsNextDisabled" IsNext="true" OnValidSubmitFirst="FirstAsync" OnValidSubmitPrevious="PreviousAsync" OnValidSubmitNext="NextAsync" OnValidSubmitLast="LastAsync" />
        </EditForm>
        <br />
    </div>

    <!-- ModalCreate -->
    <SfDialog ID="modalCreateCN" @bind-Visible="ShowModalTaoMoiCN" Width="640px" AllowPrerender="true" IsModal="true">
        <DialogTemplates>
            <Header>
                <div>
                    <h1 class="modal-title fs-5">
                        <img src="/images/Button/Moi.png" alt="icon" width="16" height="16">
                        <strong>Thêm mới</strong>
                    </h1>
                </div>
            </Header>
            <Content>
                <TaoMoiChiNhanh OnValidSubmitModalCreate="CloseModal" />
            </Content>
        </DialogTemplates>
    </SfDialog>

    <SfDialog ID="modalCreateKH" @bind-Visible="ShowModalTaoMoiKH" Width="840px" AllowPrerender="true" IsModal="true">
        <DialogTemplates>
            <Header>
                <div>
                    <h1 class="modal-title fs-5">
                        <img src="/images/Button/Moi.png" alt="icon" width="16" height="16">
                        <strong>Thêm mới</strong>
                    </h1>
                </div>
            </Header>
            <Content>
                <TaoMoiKhachHang OnValidSubmitModalCreate="CloseModal" LoaiPhieu="@SystemConstants.LoaiPhieu.PhieuThu" />
            </Content>
        </DialogTemplates>
    </SfDialog>
    <!-- Modal xem phiếu nhâp -->
    <SfDialog ID="modal-xem-phieu-nhap" Width="95%" @bind-Visible="ShowModalPhieuNhap" AllowPrerender="true" IsModal="true">
        <DialogTemplates>
            <Header>
                <h1 class="thoiGianLamViec-title">
                    <img src="/images/TreeView/tamkhoa.ico" alt="icon" width="20" height="20">
                    <span style="text-align: center">
                        Xem phiếu nhập
                    </span>
                </h1>
            </Header>
            <Content>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="bordered-div">
                            <div class="row">
                                <SfGrid ID="grid-xem-phieu-nhap" @ref="SfGridPhieuNhap" DataSource="@PhieuNhapDtos" EnablePersistence="true" AllowSelection="true" AllowSorting="true" AllowResizing="true" AllowReordering="true" Width="auto" Height="360">
                                    <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="false"></GridEditSettings>
                                    <GridPageSettings PageSize="10"></GridPageSettings>
                                    <GridColumns>
                                        <GridColumn Field=@nameof(GiaTri.Stt) HeaderText="#" Format="N0" TextAlign="TextAlign.Left" Width="20"></GridColumn>
                                        <GridColumn Field=@nameof(GiaTri.NgayCt) HeaderText="Ngày chứng từ" Format="dd/MM/yyyy" TextAlign="TextAlign.Left" Width="120"></GridColumn>
                                        <GridColumn Field=@nameof(GiaTri.SoCt) HeaderText="Số chứng từ" TextAlign="TextAlign.Left" Width="120"></GridColumn>
                                        <GridColumn Field=@nameof(GiaTri.SoLuong) HeaderText="Số lượng" Format="N0" TextAlign="TextAlign.Right" Width="120"></GridColumn>
                                        <GridColumn Field=@nameof(GiaTri.GiaVND) HeaderText="Đơn giá" Format="N0" TextAlign="TextAlign.Right" Width="120"></GridColumn>
                                        <GridColumn Field=@nameof(GiaTri.TienVND) HeaderText="Thành Tiền" Format="N0" TextAlign="TextAlign.Right" Width="120"></GridColumn>
                                    </GridColumns>
                                </SfGrid>
                            </div>
                        </div>
                    </div>
                </div>
            </Content>
            <FooterTemplate>
                <button type="button" class="btn btn-sm btn-secondary" @onclick="CloseXemPhieuNhap">Hủy</button>
                <button type="button" class="btn btn-sm btn-primary" @onclick="ConfirmXemPhieuNhap">Nhận</button>
            </FooterTemplate>
        </DialogTemplates>
    </SfDialog>
    <ModalErrorMessage ShowModalMessage="@ShowModalMessage" CheckMessage="@CheckMessage" TextMessage="@TextMessage" IsDelete="@IsDeleteMessage"
                       OnCloseMessage="CloseModalMessage" OnConfirmDelele="ConfirmDeleleAsync" IsConfirm="@IsConfirmMessage" OnConfirm="ConfirmCancelAsync" />
   
}
else
{
    <h3>Vui lòng chờ....</h3>
}

@code {
    private bool hasRefreshed = false;
    private PhieuXuatRequest SelectPhieuXuat = new PhieuXuatRequest()
    {
        NgayHt = DateTime.Now,
        NgayLap = DateTime.Now,
        SoLuong =0,
        TienHang = 0,
        TienHangVND = 0,
        TienVon = 0,
        TienVonVND = 0,
        TienHangCk = 0,
        TienHangCkVND = 0,
        ThueVat = 0,
        ThueVatVND = 0,
        TienChietKhau = 0,
        TienChietKhauVND = 0,
        TongTien = 0,
        TongTienVND = 0,
        HinhThucTt ="TM/CK",
        IsSuaTien = false,
        IsSuaTienThue = false,
        IsGiaVonDD = false,
        TkChietKhau = 0
    };
    private bool IsCheckNgoaiTe = false;
    private bool ShowModalTaoMoiKH = false;
    private bool ShowModalTaoMoiCN = false;
    private List<SoCaiDto>? SoCaiDtos;
    private List<ChiNhanhDto>? ChiNhanhDtos;
    private SfComboBox<int?, ChiNhanhDto> ddCN = new SfComboBox<int?, ChiNhanhDto>();
    private List<KhachHangDto>? KhachHangDtos ;
    private SfComboBox<int?, KhachHangDto> ddKH = new SfComboBox<int?, KhachHangDto>();
    private List<QuyenSoDto>? QuyenSoDtos ;
    private SfComboBox<string?, QuyenSoDto> ddQS = new SfComboBox<string?, QuyenSoDto>();
    private List<TaiKhoanDto>? TaiKhoanDtos ;
    private SfComboBox<int?, TaiKhoanDto> ddTK = new SfComboBox<int?, TaiKhoanDto>();
    private List<NgoaiTeDto>? NgoaiTeDtos;
    private SfComboBox<int?, NgoaiTeDto> ddNT = new SfComboBox<int?, NgoaiTeDto>();
    private List<BoPhanDto>? BoPhanDtos;
    private SfComboBox<int?, BoPhanDto> ddBP = new SfComboBox<int?, BoPhanDto>();

    private List<PhieuXuatCtRequest> PhieuXuatCtRequests = new List<PhieuXuatCtRequest>();
    private SfGrid<PhieuXuatCtRequest> SfGridPhieuXuatCt = new SfGrid<PhieuXuatCtRequest>();
    private PhieuXuatCtRequest TempChiTiet = new PhieuXuatCtRequest();
    private bool IsCheckTyLeCk = false;
    private List<VatTuDto>? VatTuDtos;
    private SfComboBox<int?, VatTuDto> ddVTCt = new SfComboBox<int?, VatTuDto>();
    private List<KhoDto>? KhoDtos;
    private SfComboBox<int?, KhoDto> ddKCt = new SfComboBox<int?, KhoDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKCKCt = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKTCt = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKDTCt = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKKCt = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKGVCt = new SfComboBox<int?, TaiKhoanDto>();
    private List<DmMaPhiDto>? DmMaPhiDtos;
    private SfComboBox<int?, DmMaPhiDto> ddMPCt = new SfComboBox<int?, DmMaPhiDto>();
    private List<VuViecDto>? VuViecDtos;
    private SfComboBox<int?, VuViecDto> ddVVCt = new SfComboBox<int?, VuViecDto>();
    private List<CongTrinhDto>? CongTrinhDtos;
    private SfComboBox<int?, CongTrinhDto> ddCTCt = new SfComboBox<int?, CongTrinhDto>();
    private List<ThueSuatDto>? ThueSuatDtos;
    private SfComboBox<int?, ThueSuatDto> ddTSCt = new SfComboBox<int?, ThueSuatDto>();

    //Xem phiếu nhập
    private bool ShowModalPhieuNhap = false;
    private SfGrid<GiaTri> SfGridPhieuNhap = new SfGrid<GiaTri>();
    public List<GiaTri> PhieuNhapDtos = new List<GiaTri>();

    // Thông báo message
    private bool ShowModalMessage = false;
    private bool CheckMessage = false;
    private string? TextMessage { set; get; }
    private bool IsDeleteMessage { set; get; }
    private bool IsConfirmMessage { set; get; }
    // Thông báo message end

    //Footer menu
    public string? NewId { set; get; }
    public bool IsDisabled { set; get; } = false;
    public bool IsSaveDisabled { set; get; }
    public bool IsCancelDisabled { set; get; }
    public bool IsAddDisabled { set; get; } = true;
    public bool IsEditDisabled { set; get; } = true;
    public bool IsDeleteDisabled { set; get; } = true;
    public bool IsPrintDisabled { set; get; } = true;
    public bool IsCopyDisabled { set; get; } = true;
    public bool IsCloseDisabled { set; get; } = true;
    public bool IsNextDisabled { set; get; } = true;
    private Dictionary<string, object> GridAttributes { get; set; } = new Dictionary<string, object>();
    public List<PhieuXuatDto> PhieuXuatDtos = new List<PhieuXuatDto>();
    private int CurrentIndex = 0;
    //Footer menu end

    protected override async Task OnInitializedAsync()
    {
        if (!hasRefreshed)
        {
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);

            if (queryParams["copyId"] != null)
            {
                NewId = queryParams["copyId"];
            }
            if (NewId != null)
            {
                await RefreshAsync();
                await DefaultData(CurrentIndex, true);
                if (QuyenSoDtos != null)
                    this.DefaultValueQuyenSo(QuyenSoDtos);
            }
            else
            {
                ChiNhanhDtos = await _chiNhanh.GetListAsync();
                this.DefaultValueChiNhanh(ChiNhanhDtos);
                KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai0);
                QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.HoaDonBanHangKiemPhieuXuatKho);
                this.DefaultValueQuyenSo(QuyenSoDtos);
                TaiKhoanDtos = await _taiKhoan.GetListAsync();
                this.DefaultValueTkThueDu(TaiKhoanDtos);
                NgoaiTeDtos = await _ngoaiTe.GetListAsync();
                this.DefaultValueNgoaiTe(NgoaiTeDtos);
                VatTuDtos = await _vatTu.GetListAsync(string.Empty);
                KhoDtos = await _kho.GetListAsync();
                BoPhanDtos = await _boPhan.GetListAsync();
                ThueSuatDtos = await _thueSuat.GetListAsync();
                CongTrinhDtos = await _congTrinh.GetListAsync();
                VuViecDtos = await _vuViec.GetListAsync();
                DmMaPhiDtos = await _dmMaPhi.GetListAsync();

            }
            hasRefreshed = true;  
        }
    }
    private void DefaultValueChiNhanh(List<ChiNhanhDto> chiNhanhDtos)
    {
        var item = chiNhanhDtos.FirstOrDefault();
        SelectPhieuXuat.ChiNhanhId = item?.Id;
        SelectPhieuXuat.ChiNhanhNm = item?.ChiNhanhNm;
    }
    private void DefaultValueQuyenSo(List<QuyenSoDto> quyenSoDtos)
    {
        var item = new QuyenSoDto();
        item = quyenSoDtos.FirstOrDefault(x => x.IsUser == true);
        if (item == null)
        {
            item = quyenSoDtos.FirstOrDefault();
        }
        SelectPhieuXuat.QuyenSo = item?.SoQuyen;
        string sokiTu0 = item?.SoKyTu0.HasValue == true ? "D" + item.SoKyTu0.ToString() : "D0";
        SelectPhieuXuat.SoCt = item?.SoCtHienTai.HasValue == true ? (item.SoCtHienTai.Value + 1).ToString(sokiTu0) : "0";
    }
    private void DefaultValueTkThueDu(List<TaiKhoanDto> taiKhoanDtos)
    {
        var ck = taiKhoanDtos.FirstOrDefault(x=>x.TaiKhoanUd == "33311");
        SelectPhieuXuat.TkThueVatDu = ck?.Id;
    }

    private async void DefaultValueNgoaiTe(List<NgoaiTeDto> ngoaiTeDtos)
    {
        var ngoaiTe = ngoaiTeDtos.FirstOrDefault(x => x.NgoaiTeUd == "VND");
        if (ngoaiTe != null)
        {
            SelectPhieuXuat.NgoaiTeId = ngoaiTe.Id;
            var tyGiaNgoaiTe = await _ngoaiTe.GetByIdAsync(ngoaiTe.Id);
            SelectPhieuXuat.TiGia = tyGiaNgoaiTe.TyGiaNgoaiTeDtos?.First().TyGia;
            StateHasChanged();//cập nhật giao diện ngay tức thì
        }
    }
    private async Task OnKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "F4")
        {
            await this.SfGridPhieuXuatCt.AddRecordAsync();

        }
        else if (args.Key == "F9")
        {
            await this.SfGridPhieuXuatCt.CloseEditAsync();
            await ddKH.FocusAsync();
        }
        else if (args.Key == "F8")
        {
            await this.SfGridPhieuXuatCt.DeleteRecordAsync();
            await ddKH.FocusAsync();
        }
        else if (args.Key == "F5")
        {
            if (SelectPhieuXuat.IsGiaVonDD == true)
            {
                var result = await _commonKho.GetTonKhos(TempChiTiet.VatTuId, TempChiTiet.KhoId, SelectPhieuXuat.NgayHt, TempChiTiet.SoLuong);
                if (result.GiaTris.Count > 0)
                {
                    PhieuNhapDtos = result.GiaTris;
                }
                else
                {
                    PhieuNhapDtos = new List<GiaTri>();
                }
                ShowModalPhieuNhap = true;
            }
            else
            {
                TextMessage = "Tính năng chọn giá vốn từ phiếu nhập mua chi hiệu lực khi chon Xuất theo giá vốn đích danh cho Vật tư giá Trung bình!";
                CheckMessage = false;
                IsDeleteMessage = false;
                IsConfirmMessage = false;
                ShowModalMessage = true;
            }
        }
    }
    private async Task FocusOnInput()
    {
        await ddKH.FocusAsync();
    }
    private async Task SaveAsync()
    {
        if (!IsCheckNgoaiTe) //Reset các giá trị ngoại tệ về 0 khi Ngoại tệ đang là VND
        {
            PhieuXuatCtRequests.ForEach(x =>
            {
                x.Gia = 0;
                x.Tien = 0;
                x.TienCk = 0;
                x.Thue = 0;
                x.TienSauThue = 0;
                x.GiaVon = 0;
                x.TienVon = 0;
            });

        }      
        SelectPhieuXuat.LoaiPhieu = SystemConstants.LoaiPhieu.HoaDonBanHangKiemPhieuXuatKho;
        SelectPhieuXuat.PhieuXuatCtRequests = PhieuXuatCtRequests;
        var result = await _phieuXuat.CreateAsync(SelectPhieuXuat);
        if (result.Id.HasValue && result.Id > 0)
        {
            if (SelectPhieuXuat.QuyenSo != null && SelectPhieuXuat.SoCt != null)
            {
                await _quyenSo.UpdateSoCTAsync(SystemConstants.LoaiPhieu.HoaDonBanHangKiemPhieuXuatKho, SelectPhieuXuat.QuyenSo, SelectPhieuXuat.SoCt);
            }
            NewId = result.Id.ToString();
            if(SelectPhieuXuat.GhiNoTkUd != null && SelectPhieuXuat.GhiNoTkUd.Contains("111") && await _thamSo.TuDongTaoThuChiAsync() == 1)
            {
                await _common.TaoPhieuThuHDAAsync(int.Parse(NewId ?? "0"), SelectPhieuXuat);
            }
            ScreenDisable();

        }
        else
        {
            TextMessage = result.Message;
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }
    private async Task TaoPhieuThuAsync()
    {
        var result = await _common.TaoPhieuThuHDAAsync(int.Parse(NewId ?? "0"), SelectPhieuXuat);
        if (result.IsSuccessed)
        {
            TextMessage = result.Message;
            CheckMessage = true;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
        else
        {
            TextMessage = result.Message;
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }
    public async Task OnFilteringChiNhanh(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ChiNhanhUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ChiNhanhNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddCN.FilterAsync(ChiNhanhDtos, query);
    }
    private void OnValueChangeChiNhanh(ChangeEventArgs<int?, ChiNhanhDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuXuat.ChiNhanhNm = args.ItemData.ChiNhanhNm;
        }

    }
    public async Task OnFilteringBoPhan(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "BoPhanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "BoPhanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddBP.FilterAsync(BoPhanDtos, query);
    }
    private void OnValueChangeBoPhan(ChangeEventArgs<int?, BoPhanDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuXuat.BoPhanNm = args.ItemData.BoPhanNm;
        }

    }   
    private void OnValueChangeXuatGiaDD(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
    }
    private void OnValueChangeSuaTien(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
    }
    private void OnValueChangeSuaTienThue(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
    }
    public async Task OnFilteringKhachHang(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhachHangUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhachHangNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKH.FilterAsync(KhachHangDtos, query);
    }
    private void OnValueChangeKhachHang(ChangeEventArgs<int?, KhachHangDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuXuat.DiaChi = args.ItemData.DiaChi;
            SelectPhieuXuat.MaSoThue = args.ItemData.MaSoThue;
            SelectPhieuXuat.KhachHangUd = args.ItemData.KhachHangUd;
            SelectPhieuXuat.KhachHangNm = args.ItemData.KhachHangNm;
            SelectPhieuXuat.SoDu = args.ItemData.Sodu;
        }
    }
    public async Task OnFilteringTaiKhoan(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTK.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTaiKhoan(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuXuat.GhiNoTkNm = args.ItemData.TaiKhoanNm;
            SelectPhieuXuat.GhiNoTkUd = args.ItemData.TaiKhoanUd;
            SelectPhieuXuat.TkThueVat = args.ItemData.Id;
        }
    }
    public async Task OnFilteringQuyenSo(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "MaCt", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "SoQuyen", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddQS.FilterAsync(QuyenSoDtos, query);
    }
    private void OnValueChangeQuyenSo(ChangeEventArgs<string, QuyenSoDto> args)
    {
        if (args.ItemData != null)
        {
            string sokiTu0 = args.ItemData.SoKyTu0.HasValue ? "D" + args.ItemData.SoKyTu0.ToString() : "D0";
            SelectPhieuXuat.SoCt = args.ItemData.SoCtHienTai.HasValue ? (args.ItemData.SoCtHienTai.Value + 1).ToString(sokiTu0) : "0";
        }
    }

    private async Task OnValueChangeNgayht(ChangedEventArgs<DateTime?> args)
    {
        DateTime? tuNgay = await _localStorage.GetItemAsync<string>("TuNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("TuNgayLamViec")) : null;
        DateTime? denNgay = await _localStorage.GetItemAsync<string>("DenNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("DenNgayLamViec")).AddDays(1) : null;
        if (args.Value.HasValue && args.Value >= tuNgay && args.Value < denNgay)
        {
            SelectPhieuXuat.NgayLap = args.Value;
        }
        else
        {
            SelectPhieuXuat.NgayHt = null;
            TextMessage = "Ngày hạch toán phải nằm trong thời gian làm việc !";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }
    public async Task OnFilteringNgoaiTe(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "NgoaiTeUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "NgoaiTeNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddNT.FilterAsync(NgoaiTeDtos, query);
    }
    private async void OnValueChangeNgoaiTe(ChangeEventArgs<int?, NgoaiTeDto> args)
    {
        if (args.ItemData != null)
        {
            if (args.ItemData.NgoaiTeUd != "VND")
            {
                IsCheckNgoaiTe = true;
            }
            else
            {
                IsCheckNgoaiTe = false;
                SelectPhieuXuat.TienHang = 0;
                SelectPhieuXuat.ThueVat = 0;
                SelectPhieuXuat.TienChietKhau = 0;
                SelectPhieuXuat.TongTien = 0;
            }
            SelectPhieuXuat.NgoaiTeId = args.ItemData.Id;
            var ngoaiTe = await _ngoaiTe.GetByIdAsync(args.ItemData.Id);
            var item = ngoaiTe.TyGiaNgoaiTeDtos?.First();
            SelectPhieuXuat.TiGia = item?.TyGia;
            StateHasChanged();//cập nhật giao diện ngay tức thì
            await this.SfGridPhieuXuatCt.Refresh();
        }
    }
    public async Task CreatedPhieuXuatCt()
    {
        if (!SelectPhieuXuat.KhachHangId.HasValue)
            await ddKH.FocusAsync();
    }
    private void ActionBeginPhieuXuatDcKhoCt(ActionEventArgs<PhieuXuatCtRequest> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = PhieuXuatCtRequests?.Any() == true ? PhieuXuatCtRequests.Max(x => x.Stt) : 0;
            args.Data.Stt = maxId + 1; // Tăng giá trị Id lên 1
            TempChiTiet = new PhieuXuatCtRequest()
            {
                    SoLuong = 0,
                    Gia = 0,
                    GiaVND = 0,
                    Tien = 0,
                    TienVND = 0,
                    ThueSuat = 0,
                    TyLeCk = 0,
                    TienCk =0,
                    TienCkVND = 0,
                    Thue = 0,
                    ThueVND = 0,
                    TienSauThue =0,
                    TienSauThueVND =0,
                    GiaVon = 0,
                    GiaVonVND =0,
                    VatTuId = null,
                    VatTuUd = null,
                    VatTuNm = null,
                    DonViTinh = null,
                    TkDoanhThu = null,
                    TkDoanhThuUd = null,
                    TkGiaVon = null,
                    TkGiaVonUd = null,
                    TkKho = null,
                    TkKhoUd = null
            };

        }
    }
    private void ActionCompletedPhieuXuatDcKhoCt(ActionEventArgs<PhieuXuatCtRequest> args)
    {
        if (PhieuXuatCtRequests != null)
        {
            decimal? soLuong = 0; 
            decimal? tienVon = 0; 
            decimal? tienVonVND = 0;            
            decimal? tien = 0; 
            decimal? tienVND = 0; 
            decimal? tienCk = 0; 
            decimal? tienCkVND = 0;
            decimal? thue = 0; 
            decimal? thueVND = 0;

            foreach (var item in PhieuXuatCtRequests)
            {
                soLuong += item.SoLuong;
                tien += item.Tien;
                tienVon += item.TienVon;
                tienVonVND += item.TienVonVND;          
                tienVND += item.TienVND;
                tienCk += item.TienCk;
                tienCkVND += item.TienCkVND;
                thue += item.Thue;
                thueVND += item.ThueVND;
            }
            SelectPhieuXuat.SoLuong = soLuong;
            SelectPhieuXuat.TienVon = tienVon;
            SelectPhieuXuat.TienVonVND = tienVonVND;
            SelectPhieuXuat.TienHang = tien;
            SelectPhieuXuat.TienHangVND = tienVND;          
            SelectPhieuXuat.TienChietKhau = tienCk;          
            SelectPhieuXuat.TienChietKhauVND = tienCkVND;
            SelectPhieuXuat.TienHangCk = SelectPhieuXuat.TienHang - SelectPhieuXuat.TienChietKhau;
            SelectPhieuXuat.TienHangCkVND = SelectPhieuXuat.TienHangVND - SelectPhieuXuat.TienChietKhauVND;
            SelectPhieuXuat.ThueVat = thue;
            SelectPhieuXuat.ThueVatVND = thueVND;
            SelectPhieuXuat.TongTien = SelectPhieuXuat.TienHangCk + SelectPhieuXuat.ThueVat;
            SelectPhieuXuat.TongTienVND =  SelectPhieuXuat.TienHangCkVND + SelectPhieuXuat.ThueVatVND;
        }
        else
        {
            SelectPhieuXuat.SoLuong = 0;
            SelectPhieuXuat.TienVon = 0;
            SelectPhieuXuat.TienVonVND = 0;
            SelectPhieuXuat.TienHang = 0;
            SelectPhieuXuat.TienHangVND = 0;
            SelectPhieuXuat.TienChietKhau = 0;          
            SelectPhieuXuat.TienChietKhauVND = 0;
            SelectPhieuXuat.TienHangCk = 0;
            SelectPhieuXuat.TienHangCkVND = 0;
            SelectPhieuXuat.ThueVat = 0;
            SelectPhieuXuat.ThueVatVND = 0;
            SelectPhieuXuat.TongTien = 0;
            SelectPhieuXuat.TongTienVND = 0;
        }
    }
    public void RowUpdatingHandler(RowUpdatingEventArgs<PhieuXuatCtRequest> args)
    {
        args.Data.VatTuId = TempChiTiet.VatTuId;
        args.Data.VatTuUd = TempChiTiet.VatTuUd;
        args.Data.VatTuNm = TempChiTiet.VatTuNm;
        args.Data.DonViTinh = TempChiTiet.DonViTinh;
        args.Data.KhoId = TempChiTiet.KhoId;
        args.Data.KhoUd = TempChiTiet.KhoUd;
        args.Data.SoLuong = TempChiTiet.SoLuong;
        args.Data.Gia = TempChiTiet.Gia;
        args.Data.GiaVND = TempChiTiet.GiaVND;
        args.Data.Tien = TempChiTiet.Tien;
        args.Data.TienVND = TempChiTiet.TienVND;
        args.Data.TyLeCk = TempChiTiet.TyLeCk;
        args.Data.TienCk = TempChiTiet.TienCk;
        args.Data.TienCkVND = TempChiTiet.TienCkVND;
        args.Data.TkChietKhau = TempChiTiet.TkChietKhau;
        args.Data.TkChietKhauUd = TempChiTiet.TkChietKhauUd;
        args.Data.ThueSuatId = TempChiTiet.ThueSuatId;
        args.Data.ThueSuatUd = TempChiTiet.ThueSuatUd;
        args.Data.ThueSuat = TempChiTiet.ThueSuat;
        args.Data.Thue = TempChiTiet.Thue;
        args.Data.ThueVND = TempChiTiet.ThueVND;
        args.Data.TienSauThue = TempChiTiet.TienSauThue;
        args.Data.TienSauThueVND = TempChiTiet.TienSauThueVND;       
        args.Data.TkThue = TempChiTiet.TkThue;
        args.Data.TkThueUd = TempChiTiet.TkThueUd;
        args.Data.TkDoanhThu = TempChiTiet.TkDoanhThu;
        args.Data.TkDoanhThuUd = TempChiTiet.TkDoanhThuUd;
        args.Data.TkKho = TempChiTiet.TkKho;
        args.Data.TkKhoUd = TempChiTiet.TkKhoUd;
        args.Data.TkGiaVon = TempChiTiet.TkGiaVon;
        args.Data.TkGiaVonUd = TempChiTiet.TkGiaVonUd;
        args.Data.GiaVon = TempChiTiet.GiaVon;
        args.Data.GiaVonVND = TempChiTiet.GiaVonVND;
        args.Data.TienVon = TempChiTiet.TienVon;
        args.Data.TienVonVND = TempChiTiet.TienVonVND;
        args.Data.CongTrinhId = TempChiTiet.CongTrinhId;
        args.Data.VuViecId = TempChiTiet.VuViecId;
        args.Data.VuViecUd = TempChiTiet.VuViecUd;
        args.Data.MaPhiId = TempChiTiet.MaPhiId;
    }
    public void RecordDoubleClickHandler(RecordDoubleClickEventArgs<PhieuXuatCtRequest> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet = args.RowData;
    }
    private async Task CreatedVatTuCtHandler(Object args)
    {
        await ddVTCt.FocusAsync();
    }
    public async Task OnFilteringVatTuCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "VatTuUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "VatTuNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddVTCt.FilterAsync(VatTuDtos, query);
    }
    private void OnValueChangeVatTuCt(ChangeEventArgs<int?, VatTuDto> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.ItemData != null)
        {
            TempChiTiet.VatTuId = args.ItemData.Id;
            TempChiTiet.VatTuUd = args.ItemData.VatTuUd;
            TempChiTiet.VatTuNm = args.ItemData.VatTuNm;
            TempChiTiet.DonViTinh = args.ItemData.DonViTinh;
            TempChiTiet.TkDoanhThu = args.ItemData.TkDoanhThu;
            TempChiTiet.TkDoanhThuUd = args.ItemData.TkDoanhThuUd;      
            TempChiTiet.TkKho = args.ItemData.TkKho;
            TempChiTiet.TkKhoUd = args.ItemData.TkKhoUd;
            TempChiTiet.TkGiaVon = args.ItemData.TkGiaVon;
            TempChiTiet.TkGiaVonUd = args.ItemData.TkGiaVonUd;
        }
    }
    public async Task OnFilteringKhoCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhoUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhoNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKCt.FilterAsync(KhoDtos, query);
    }
    private void OnValueChangeKhoCt(ChangeEventArgs<int?, KhoDto> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.ItemData != null)
        {
            TempChiTiet.KhoId = args.ItemData.Id;
            TempChiTiet.KhoUd = args.ItemData.KhoUd;
        }
    }
    private void OnValueChangeSoLuong(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.SoLuong = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        TempChiTiet.TienVon = TempChiTiet.SoLuong * TempChiTiet.GiaVon;
        TempChiTiet.TienVonVND = TempChiTiet.SoLuong * TempChiTiet.GiaVonVND;
        this.UpdateThanhTien();
    }
    private void OnValueChangeGia(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.Gia = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        this.UpdateThanhTien();
    }
    private void OnValueChangeGiaVND(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.GiaVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        this.UpdateThanhTien();
    }
    private void OnValueChangeTienVND(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.TienVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        this.UpdateThanhTien();
    }
    private void OnValueChangeTien(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.Tien = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        this.UpdateThanhTien();
    }
    private void OnValueChangeTyLeCk(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.TyLeCk = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if (TempChiTiet.TyLeCk != 0)
            IsCheckTyLeCk = true;
        else
            IsCheckTyLeCk = false;
        this.UpdateThanhTien();
    }
    public async Task OnFilteringTaiKhoanCkCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKCKCt.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTaiKhoanCkCt(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.ItemData != null)
        {
            TempChiTiet.TkChietKhau = args.ItemData.Id;
            TempChiTiet.TkChietKhauUd = args.ItemData.TaiKhoanUd;
        }
    }
    public async Task OnFilteringThueSuatCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ThueSuatUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ThueSuatNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTSCt.FilterAsync(ThueSuatDtos, query);
    }
    private void OnValueChangeThueSuatCt(ChangeEventArgs<int?, ThueSuatDto> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.ItemData != null)
        {
            TempChiTiet.ThueSuatId = args.ItemData.Id;
            TempChiTiet.ThueSuatUd = args.ItemData.ThueSuatUd;
            TempChiTiet.TkThue = args.ItemData.TkNo;
            TempChiTiet.TkThueUd = args.ItemData.TkNoUd;
            TempChiTiet.ThueSuat = args.ItemData.GiaTri.HasValue ? args.ItemData.GiaTri : 0;
            SelectPhieuXuat.ThueSuatId = args.ItemData.Id;
            SelectPhieuXuat.ThueSuatUd = args.ItemData.ThueSuatUd;
            SelectPhieuXuat.ThueSuat = args.ItemData.GiaTri.HasValue ? args.ItemData.GiaTri : 0;
            this.UpdateThanhTien();
        }
    }
    private void OnValueChangeTienThue(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.Thue = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempChiTiet.Thue != 0)
            TempChiTiet.ThueVND = TempChiTiet.Thue * SelectPhieuXuat.TiGia;
        TempChiTiet.TienSauThue = TempChiTiet.Tien - TempChiTiet.TienCk + TempChiTiet.Thue;
        TempChiTiet.TienSauThueVND = TempChiTiet.TienVND - TempChiTiet.TienCkVND + TempChiTiet.ThueVND;
    }
    private void OnValueChangeTienThueVND(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.ThueVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        TempChiTiet.TienSauThue = TempChiTiet.Tien - TempChiTiet.TienCk + TempChiTiet.Thue;
        TempChiTiet.TienSauThueVND = TempChiTiet.TienVND - TempChiTiet.TienCkVND + TempChiTiet.ThueVND;
    }
    private void UpdateThanhTien()
    {
        if (!IsCheckNgoaiTe)
        {
            TempChiTiet.Gia = 0;
            TempChiTiet.Tien = 0;
        }
        if (SelectPhieuXuat.IsSuaTien == true)
        {
            if (IsCheckNgoaiTe)
                TempChiTiet.TienVND = TempChiTiet.Tien * SelectPhieuXuat.TiGia;
            if (TempChiTiet.SoLuong == 0)
            {
                TempChiTiet.Gia = 0;
                TempChiTiet.GiaVND = 0;
            }
            else
            {
                TempChiTiet.GiaVND = TempChiTiet.TienVND / TempChiTiet.SoLuong;
                TempChiTiet.Gia = TempChiTiet.Tien / TempChiTiet.SoLuong;
            }
        }
        else
        {
            if (IsCheckNgoaiTe)
                TempChiTiet.GiaVND = TempChiTiet.Gia * SelectPhieuXuat.TiGia;
            TempChiTiet.Tien = TempChiTiet.SoLuong * TempChiTiet.Gia;
            TempChiTiet.TienVND = TempChiTiet.SoLuong * TempChiTiet.GiaVND;
        }
        TempChiTiet.TienCk = TempChiTiet.Tien * TempChiTiet.TyLeCk / 100;
        TempChiTiet.TienCkVND = TempChiTiet.TienVND * TempChiTiet.TyLeCk / 100;
        if(SelectPhieuXuat.IsSuaTienThue == false)
        {
            TempChiTiet.Thue = (TempChiTiet.Tien - TempChiTiet.TienCk) * TempChiTiet.ThueSuat / 100;
            TempChiTiet.ThueVND = (TempChiTiet.TienVND - TempChiTiet.TienCkVND) * TempChiTiet.ThueSuat / 100;
        }
        TempChiTiet.TienSauThue = TempChiTiet.Tien - TempChiTiet.TienCk + TempChiTiet.Thue;
        TempChiTiet.TienSauThueVND = TempChiTiet.TienVND - TempChiTiet.TienCkVND + TempChiTiet.ThueVND;

    }
    public async Task OnFilteringTkThueCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKTCt.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTkThueCt(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.ItemData != null)
        {
            TempChiTiet.TkThue = args.ItemData.Id;
            TempChiTiet.TkThueUd = args.ItemData.TaiKhoanUd;
        }
    }
    private void OnValueChangeGiaVon(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        TempChiTiet.GiaVon = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        TempChiTiet.GiaVonVND = TempChiTiet.GiaVon * SelectPhieuXuat.TiGia;
        TempChiTiet.TienVon = TempChiTiet.SoLuong * TempChiTiet.GiaVon;
        TempChiTiet.TienVonVND = TempChiTiet.SoLuong * TempChiTiet.GiaVonVND;
    }
    private void OnValueChangeGiaVonVND(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if(TempChiTiet.GiaVon != 0)
            TempChiTiet.GiaVonVND = TempChiTiet.GiaVon * SelectPhieuXuat.TiGia;
        else
            TempChiTiet.GiaVonVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        TempChiTiet.TienVon = TempChiTiet.SoLuong * TempChiTiet.GiaVon;
        TempChiTiet.TienVonVND = TempChiTiet.SoLuong * TempChiTiet.GiaVonVND;
    }
    public async Task OnFilteringVuViecCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "VuViecUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "VuViecNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddVVCt.FilterAsync(VuViecDtos, query);
    }
    private void OnValueChangeVuViecCt(ChangeEventArgs<int?, VuViecDto> args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if (args.ItemData != null)
        {
            TempChiTiet.VuViecId = args.ItemData.Id;
            TempChiTiet.VuViecUd = args.ItemData.VuViecUd;
        }
        else
        {
            TempChiTiet.VuViecId = null;
            TempChiTiet.VuViecUd = null;
        }
    }
    private async Task AddRowCtAsync()
    {
        await this.SfGridPhieuXuatCt.AddRecordAsync();
    }
    private async Task DeleteRowCtAsync()
    {
        await this.SfGridPhieuXuatCt.DeleteRecordAsync();
    }
    private async Task CancelCtAsync()
    {
        await this.SfGridPhieuXuatCt.CloseEditAsync();
    }
    private async Task XemPhieuNhap()
    {
        if(SelectPhieuXuat.IsGiaVonDD == true)
        {
            var result = await _commonKho.GetTonKhos(TempChiTiet.VatTuId, TempChiTiet.KhoId, SelectPhieuXuat.NgayHt, TempChiTiet.SoLuong);
            if (result.GiaTris.Count > 0)
            {
                PhieuNhapDtos = result.GiaTris;
            }
            else
            {
                PhieuNhapDtos = new List<GiaTri>();
            }
            ShowModalPhieuNhap = true;
        }
        else
        {
            TextMessage = "Tính năng chọn giá vốn từ phiếu nhập mua chi hiệu lực khi chon Xuất theo giá vốn đích danh cho Vật tư giá Trung bình!";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }

    }
    private void CloseXemPhieuNhap()
    {
        ShowModalPhieuNhap = false;
    }
    private async Task ConfirmXemPhieuNhap()
    {
        var selectedRecords = await SfGridPhieuNhap.GetSelectedRecordsAsync();
        if (selectedRecords.Count > 0)
        {
            var data = selectedRecords.First();
            TempChiTiet.GiaVon = 0;
            TempChiTiet.GiaVonVND = data.GiaVND;
            TempChiTiet.TienVon = 0;
            TempChiTiet.TienVonVND = TempChiTiet.SoLuong * TempChiTiet.GiaVonVND;
            ShowModalPhieuNhap = false;
        }
        else
        {
            TextMessage = "Hãy chọn ít nhất 1 chứng từ!";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }
    private void OnValueChangeTienChietKhau(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        SelectPhieuXuat.TienChietKhau = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        SelectPhieuXuat.TienChietKhauVND = SelectPhieuXuat.TienChietKhau * SelectPhieuXuat.TiGia;
        SelectPhieuXuat.TongTien = SelectPhieuXuat.TienHang + SelectPhieuXuat.ThueVat - SelectPhieuXuat.TienChietKhau;
        SelectPhieuXuat.TongTienVND = SelectPhieuXuat.TienHangVND + SelectPhieuXuat.ThueVatVND - SelectPhieuXuat.TienChietKhauVND;
    }
    private void OnValueChangeTienChietKhauVND(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuXuatCt.PreventRender(false);
        if(SelectPhieuXuat.TienChietKhau == 0)
            SelectPhieuXuat.TienChietKhauVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        else
            SelectPhieuXuat.TienChietKhauVND = SelectPhieuXuat.TienChietKhau * SelectPhieuXuat.TiGia;           
        SelectPhieuXuat.TongTien = SelectPhieuXuat.TienHang + SelectPhieuXuat.ThueVat - SelectPhieuXuat.TienChietKhau;
        SelectPhieuXuat.TongTienVND = SelectPhieuXuat.TienHangVND + SelectPhieuXuat.ThueVatVND - SelectPhieuXuat.TienChietKhauVND;
    }
    public void TaoChiNhanh()
    {
        ShowModalTaoMoiCN = true;
    }
    public void TaoKhachHang()
    {
        ShowModalTaoMoiKH = true;
    }

    // ẩn màn hình
    private void ScreenDisable()
    {
        GridAttributes["disable"] = "yes";
        IsDisabled = true;
        IsSaveDisabled = true;
        IsCancelDisabled = true;
        IsAddDisabled = false;
        IsEditDisabled = false;
        IsDeleteDisabled = false;
        IsPrintDisabled = false;
        IsCopyDisabled = false;
        IsCloseDisabled = false;
        IsNextDisabled = false;
    }
    // Hiện màn hình
    private void ScreenEnabled()
    {
        GridAttributes["disable"] = "no";
        IsDisabled = false;
        IsSaveDisabled = false;
        IsCancelDisabled = false;
        IsAddDisabled = true;
        IsEditDisabled = true;
        IsDeleteDisabled = true;
        IsPrintDisabled = true;
        IsCopyDisabled = true;
        IsCloseDisabled = true;
        IsNextDisabled = true;
    }

    // footer menu
    private void Cancel()
    {

        IsDeleteMessage = false;
        IsConfirmMessage = true;
        CheckMessage = true;
        TextMessage = "Dữ liệu trên form chưa được lưu. Bạn muốn thoát không cần lưu?";
        ShowModalMessage = true;

    }
    private async Task ConfirmCancelAsync()
    {
        ScreenDisable();
        await RefreshAsync();
        if (PhieuXuatDtos.Count == 0)
            NavigationManager.NavigateTo($"{SystemConstants.UrlPath.HoaDonBanHangKiemPhieuXuatKho}", true);
        else
        {
            await DefaultData(CurrentIndex);
            ShowModalMessage = false;
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
        }
    }
    private void Close()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.HoaDonBanHangKiemPhieuXuatKho}", true);
    }
    private void Add()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.HoaDonBanHangKiemPhieuXuatKho}/create", true);
    }
    private void Edit()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.HoaDonBanHangKiemPhieuXuatKho}/edit/{NewId}", true);
    }
    private void Delete()
    {
        ShowModalMessage = true;
        IsDeleteMessage = true;
        IsConfirmMessage = false;
        TextMessage = $"Xác nhận xóa phiếu có số chứng từ  <span style='color:red'>{SelectPhieuXuat.SoCt}</span>";
    }
    private async Task ConfirmDeleleAsync()
    {
        var result = await _phieuXuat.DeleteAsync(int.Parse(NewId != null ? NewId : "0"));
        if (result.IsSuccessed)
        {
            await RefreshAsync();
            if (PhieuXuatDtos.Count == 0)
                NavigationManager.NavigateTo($"{SystemConstants.UrlPath.HoaDonBanHangKiemPhieuXuatKho}", true);
            else if (CurrentIndex > PhieuXuatDtos.Count - 1)
                CurrentIndex = PhieuXuatDtos.Count - 1;
            await DefaultData(CurrentIndex);
            ShowModalMessage = false;
        }
        else
        {
            ShowModalMessage = true;
            IsDeleteMessage = true;
            IsConfirmMessage = false;
            TextMessage = result.Message;
        }
    }
    private async Task Copy()
    {
        QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.HoaDonBanHangKiemPhieuXuatKho);
        if (QuyenSoDtos != null)
            this.DefaultValueQuyenSo(QuyenSoDtos);
        ScreenEnabled();
    }
    private async Task FirstAsync()
    {
        await RefreshAsync();
        CurrentIndex = 0;
        await DefaultData(CurrentIndex);
    }

    private async Task PreviousAsync()
    {
        if (CurrentIndex > 0)
        {
            await RefreshAsync();
            CurrentIndex--;
            await DefaultData(CurrentIndex);
        }
    }

    private async Task NextAsync()
    {
        await RefreshAsync();
        if (CurrentIndex < PhieuXuatDtos.Count - 1)
        {
            CurrentIndex++;
            await DefaultData(CurrentIndex);
        }
    }

    private async Task LastAsync()
    {
        await RefreshAsync();
        CurrentIndex = PhieuXuatDtos.Count - 1;
        await DefaultData(CurrentIndex);
    }
    // Footer menu end
    private async Task DefaultData(int currentIndex, bool isCheck = false)
    {
        if (currentIndex >= 0 && currentIndex < PhieuXuatDtos.Count)
        {
            var id = PhieuXuatDtos[currentIndex].Id;
            if (!isCheck)
            {
                NewId = id.ToString();
            }
            var item = await _phieuXuat.GetHDAByIdAsync(NewId != null ? int.Parse(NewId) : id);
            if (item.Id != null)
            {
                SelectPhieuXuat = _objectMapper.Map<PhieuXuatDto, PhieuXuatRequest>(item);
                if (NgoaiTeDtos != null && NgoaiTeDtos?.FirstOrDefault(x => x.Id == SelectPhieuXuat.NgoaiTeId)?.NgoaiTeUd != "VND")
                    IsCheckNgoaiTe = true;
                else
                    IsCheckNgoaiTe = false;
                if(item.PhieuXuatCtDtos != null)
                    PhieuXuatCtRequests = _objectMapper.Map<List<PhieuXuatCtDto>, List<PhieuXuatCtRequest>>(item.PhieuXuatCtDtos);
                SelectPhieuXuat.PhieuXuatCtRequests = PhieuXuatCtRequests;
            }
            else
            {
                NavigationManager.NavigateTo("error");
            }
        }
    }

    private async Task RefreshAsync()
    {
        DateTime? tuNgay = await _localStorage.GetItemAsync<string>("TuNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("TuNgayLamViec")) : null;
        DateTime? denNgay = await _localStorage.GetItemAsync<string>("DenNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("DenNgayLamViec")).AddDays(1) : null;
        if (tuNgay != null && denNgay != null)
        {
            PhieuXuatDtos = await _phieuXuat.GetListAsync(SystemConstants.LoaiPhieu.HoaDonBanHangKiemPhieuXuatKho, tuNgay, denNgay);
            ChiNhanhDtos = await _chiNhanh.GetListAsync();
            KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai0);
            QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.HoaDonBanHangKiemPhieuXuatKho);
            TaiKhoanDtos = await _taiKhoan.GetListAsync();
            NgoaiTeDtos = await _ngoaiTe.GetListAsync();
            ThueSuatDtos = await _thueSuat.GetListAsync();
            CongTrinhDtos = await _congTrinh.GetListAsync();
            VuViecDtos = await _vuViec.GetListAsync();
            DmMaPhiDtos = await _dmMaPhi.GetListAsync();
            VatTuDtos = await _vatTu.GetListAsync(string.Empty);
            KhoDtos = await _kho.GetListAsync();
            BoPhanDtos = await _boPhan.GetListAsync();
        }
        else
        {
            NavigationManager.NavigateTo(SystemConstants.UrlPath.ThoiGianLamViec, true);
        }
    }
    public async Task CloseModal()
    {
        switch (true)
        {
            case var _ when ShowModalTaoMoiCN:
                var chiNhanhUd = await _localStorage.GetItemAsync<string>("TaoMoiChiNhanhUd");
                if (!chiNhanhUd.IsNullOrEmpty())
                {
                    ChiNhanhDtos = await _chiNhanh.GetListAsync();
                    var item = ChiNhanhDtos.First(x => x.ChiNhanhUd == chiNhanhUd);
                    SelectPhieuXuat.ChiNhanhId = item.Id;
                    SelectPhieuXuat.ChiNhanhNm = item.ChiNhanhNm;
                    await _localStorage.RemoveItemAsync("TaoMoiChiNhanhUd");
                }
                ShowModalTaoMoiCN = false;
                break;
            case var _ when ShowModalTaoMoiKH:
                var khachHangUd = await _localStorage.GetItemAsync<string>("TaoMoiKhachHangUd");
                if (!khachHangUd.IsNullOrEmpty())
                {
                    KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai0);
                    var item = KhachHangDtos.First(x => x.KhachHangUd == khachHangUd);
                    SelectPhieuXuat.KhachHangId = item.Id;
                    SelectPhieuXuat.KhachHangNm = item.KhachHangNm;
                    SelectPhieuXuat.DiaChi = item.DiaChi;
                    await _localStorage.RemoveItemAsync("TaoMoiKhachHangUd");
                }
                ShowModalTaoMoiKH = false;
                break;
        }
        StateHasChanged();
    }
    private void CloseModalMessage()
    {
        ShowModalMessage = false;
    }
}
