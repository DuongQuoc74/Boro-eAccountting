@page "/giaybaono/create"
@using Blazored.LocalStorage
@using Syncfusion.Blazor.Data
@using Volo.Abp.ObjectMapping
@using tamkhoatech.ACWeb.Blazor.Pages.Common
@using tamkhoatech.ACWeb.Constants
@using tamkhoatech.ACWeb.DTO.QuanLyHeThong.ThamSoHeThong
@using tamkhoatech.ACWeb.Dto
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.DropDowns
@using tamkhoatech.ACWeb.IService
@using tamkhoatech.ACWeb.IService.IQuanLyHeThong
@using tamkhoatech.ACWeb.IService.IUtilities

@implements IAsyncDisposable
@inject IJSRuntime JSRunTime
@inject IObjectMapper _objectMapper
@inject ILocalStorageService _localStorage
@inject NavigationManager NavigationManager
@inject IChiNhanhService _chiNhanh
@inject IKhachHangService _khachHang
@inject IQuyenSoService _quyenSo
@inject ITaiKhoanService _taiKhoan
@inject INgoaiTeService _ngoaiTe
@inject IBoPhanHTService _boPhanHT
@inject IVatTuService _vatTu
@inject IVuViecService _vuViec
@inject IDmMaPhiService _dmMaPhi
@inject IDieuChinhThueTNDnService _dieuChinhThueTNDN
@inject IDmTruongTuDoService _dmTruongTuDo
@inject IDMChungService _dmChung
@inject IPhieuChiService _phieuChi
@inject ISoCaiService _soCai
@inject IPhieuNhapService _phieuNhap
@inject IThamSoHeThongService _thamSo
@inject IThueSuatService _thueSuat
@inject IUtilitiesService _utilities

<link rel="stylesheet" href="/Css/them-sua-phieu.css">
@if (hasRefreshed)
{
    <div>
        <div class="row title">
            <div class="text-center">
                <div class="row align-items-start">
                    <h4><strong>Thêm mới giấy báo nợ ngân hàng (chi)</strong></h4>
                </div>
            </div>
        </div>
        <EditForm Model="SelectPhieuChi" Context="EditFormPC" OnValidSubmit="@SaveAsync">
            <DataAnnotationsValidator />
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <div class="row">
                            <div class="col-sm-4 ">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="GiaoDichId" class="form-label">Mã giao dịch <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfComboBox ID="giaoDichId" @ref="ddGD" @bind-Value="@SelectPhieuChi.GiaoDichId" DataSource="@MaGiaoDichDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="CheckEnabledMaGiaoDich" CssClass="e-multi-column e-small" PopupWidth="400" PopupHeight="300">
                                                <ComboBoxEvents TValue="int?" TItem="DmChungDto" Filtering="OnFilteringMaGiaoDich" ValueChange="OnValueChangeMaGiaoDich"></ComboBoxEvents>
                                                <ComboBoxFieldSettings Value="Id" Text="DMChungUd" />
                                                <ComboBoxTemplates TItem="DmChungDto">
                                                    <HeaderTemplate>
                                                        <table class="header-combo">
                                                            <tr>
                                                                <th style="width:150px">Mã giao dịch</th>
                                                                <th>Tên giao dịch</th>
                                                            </tr>
                                                        </table>
                                                    </HeaderTemplate>
                                                    <ItemTemplate Context="itemContext">
                                                        <table>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="width:150px"><span>@((itemContext as DmChungDto).DMChungUd)</span></td>
                                                                    <td><span>@((itemContext as DmChungDto).DMChungNm)</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </ItemTemplate>
                                                </ComboBoxTemplates>
                                            </SfComboBox>
                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="MaGiaoDichNm" CssClass="e-small" @bind-Value="@(SelectPhieuChi.GiaoDichNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="ChiNhanhId" class="form-label">Mã chi nhánh <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="d-flex align-items-center">
                                                <SfComboBox ID="chiNhanhId" @ref="ddCN" @bind-Value="@SelectPhieuChi.ChiNhanhId" DataSource="@ChiNhanhDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="600" PopupHeight="300">
                                                    <ComboBoxEvents TValue="int?" TItem="ChiNhanhDto" Filtering="OnFilteringChiNhanh" ValueChange="OnValueChangeChiNhanh"></ComboBoxEvents>
                                                    <ComboBoxFieldSettings Value="Id" Text="ChiNhanhUd" />
                                                    <ComboBoxTemplates TItem="ChiNhanhDto">
                                                        <HeaderTemplate>
                                                            <table class="header-combo">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width:150px">Mã chi nhánh</th>
                                                                        <th>Tên chi nhánh</th>
                                                                        <th>Tên 2</th>
                                                                    </tr>
                                                                </thead>
                                                            </table>
                                                        </HeaderTemplate>
                                                        <ItemTemplate Context="itemContext">
                                                            <table>
                                                                <tbody>
                                                                    <tr>
                                                                        <td style="width:150px"><span>@((itemContext as ChiNhanhDto).ChiNhanhUd)</span></td>
                                                                        <td><span>@((itemContext as ChiNhanhDto).ChiNhanhNm)</span></td>
                                                                        <td><span>@((itemContext as ChiNhanhDto).ChiNhanhNm2)</span></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </ItemTemplate>
                                                    </ComboBoxTemplates>
                                                </SfComboBox>
                                                <SfTooltip ID="TaoCN" Target="#target" Content="Thêm chi nhánh" Position="Position.RightTop" OpensOn="Hover">
                                                    <button id="target" type="button" class="btn-them-nhanh" @onclick="TaoChiNhanh" disabled="@IsDisabled">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                        </svg>
                                                    </button>
                                                </SfTooltip>
                                            </div>
                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="ChiNhanhNm" CssClass="e-small" @bind-Value="@(SelectPhieuChi.ChiNhanhNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>                              
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="GhiCoTkId" class="form-label">Ghi có tài khoản <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfComboBox ID="ghiCoTkId" @ref="ddTK" @bind-Value="@SelectPhieuChi.GhiNoTkId" DataSource="@TaiKhoanDtos" AllowFiltering ="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="600" PopupHeight="300">
                                                <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTaiKhoan" ValueChange="OnValueChangeTaiKhoan"></ComboBoxEvents>
                                                <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                <ComboBoxTemplates TItem="TaiKhoanDto">
                                                    <HeaderTemplate>
                                                        <table class="header-combo">
                                                            <tr>
                                                                <th style="width:150px">Mã tài khoản</th>
                                                                <th>Tên tài khoản</th>
                                                                <th>Tên 2</th>
                                                            </tr>
                                                        </table>
                                                    </HeaderTemplate>
                                                    <ItemTemplate Context="itemContext">
                                                        <table>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                    <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                    <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </ItemTemplate>
                                                </ComboBoxTemplates>
                                            </SfComboBox>
                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="GhiNoTkNm" CssClass="e-small" @bind-Value="@(SelectPhieuChi.GhiNoTkNm)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="DienGiai" class="form-label">Diễn giải</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="dienGiai" CssClass="e-small" @bind-Value="@(SelectPhieuChi.DienGiai)" Enabled="!IsDisabled"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4 ">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="KhachHangId" class="form-label">Mã khách hàng <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            @if (!ShowScreenGiaoDich3)
                                            {
                                                <div class="d-flex align-items-center">
                                                    <SfComboBox ID="khachHangId" @ref="ddKH" @bind-Value="@SelectPhieuChi.KhachHangId" DataSource="@KhachHangDtos" AllowFiltering ="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="1000" PopupHeight="300">
                                                        <ComboBoxEvents TValue="int?" TItem="KhachHangDto" Filtering="OnFilteringKhachHang" ValueChange="OnValueChangeKhachHang"></ComboBoxEvents>
                                                        <ComboBoxFieldSettings Text="KhachHangUd" Value="Id"></ComboBoxFieldSettings>
                                                        <ComboBoxTemplates TItem="KhachHangDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <tr>
                                                                        <th style="width:150px">Mã khách hàng</th>
                                                                        <th>Tên khách</th>
                                                                        <th style="width:150px">Mã số thuế</th>
                                                                        <th style="width:150px">Số dư</th>
                                                                        <th>Địa chỉ</th>
                                                                    </tr>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).KhachHangUd)</span></td>
                                                                            <td><span>@((itemContext as KhachHangDto).KhachHangNm)</span></td>
                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).MaSoThue)</span></td>
                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).Sodu?.ToString("N0"))</span></td>
                                                                            <td><span>@((itemContext as KhachHangDto).DiaChi)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                    <SfTooltip ID="TaoKH" Target="#target" Content="Thêm khách hàng" Position="Position.RightTop" OpensOn="Hover">
                                                        <button id="target" type="button" class="btn-them-nhanh" @onclick="TaoKhachHang" disabled="@IsDisabled">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                            </svg>
                                                        </button>
                                                    </SfTooltip>
                                                </div>
                                            }
                                            else
                                            {
                                                <SfTextBox CssClass="e-small" Enabled="false"></SfTextBox>
                                            }

                                        </div>
                                        <div class="col-sm-8">
                                            <SfTextBox ID="TenKhachHang" CssClass="e-small" @bind-Value="@(SelectPhieuChi.TenKhachHang)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="DiaChi" class="form-label">Địa chỉ</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="DiaChi" CssClass="e-small" @bind-Value="@(SelectPhieuChi.DiaChi)" Enabled="false"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="MaSoThue" class="form-label">Mã số thuế</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="MaSoThue" CssClass="e-small" @bind-Value="@(SelectPhieuChi.MaSoThue)" Enabled="false"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="Sodu" class="form-label">Số dư</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfNumericTextBox ShowSpinButton="false" ID="Sodu" Format="N0" CssClass="e-small" @bind-Value="@(SelectPhieuChi.SoDu)" Enabled="false"></SfNumericTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="NguoiNhan" class="form-label">Người nhận tiền</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="nguoiNhan" CssClass="e-small" @bind-Value="@(SelectPhieuChi.NguoiNhan)" Enabled="!IsDisabled"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="QuyenSoId" class="form-label">Quyển sổ</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <div class="d-flex align-items-center">
                                                        <SfComboBox ID="quyenSoId" @ref="ddQS" @bind-Value="@SelectPhieuChi.QuyenSoId" DataSource="@QuyenSoDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="700" PopupHeight="300">
                                                            <ComboBoxEvents TValue="string" TItem="QuyenSoDto" Filtering="OnFilteringQuyenSo" ValueChange="OnValueChangeQuyenSo"></ComboBoxEvents>
                                                            <ComboBoxFieldSettings Text="SoQuyen" Value="SoQuyen"></ComboBoxFieldSettings>
                                                            <ComboBoxTemplates TItem="QuyenSoDto">
                                                                <HeaderTemplate>
                                                                    <table class="header-combo">
                                                                        <tr>
                                                                            <th>Mã ct</th>
                                                                            <th>Số quyển</th>
                                                                            <th>Số ct hiện tại</th>
                                                                            <th>Sử dụng</th>
                                                                        </tr>
                                                                    </table>
                                                                </HeaderTemplate>
                                                                <ItemTemplate Context="itemContext">
                                                                    <table>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td><span>@((itemContext as QuyenSoDto).MaCt)</span></td>
                                                                                <td><span>@((itemContext as QuyenSoDto).SoQuyen)</span></td>
                                                                                <td><span>@((itemContext as QuyenSoDto).SoCtHienTai)</span></td>
                                                                                <td><span>@((itemContext as QuyenSoDto).IsUser)</span></td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ItemTemplate>
                                                            </ComboBoxTemplates>
                                                        </SfComboBox>
                                                        <SfTooltip ID="TaoQS" Target="#target" Content="Thêm quyển sổ" Position="Position.RightTop" OpensOn="Hover">
                                                            <button id="target" type="button" class="btn-them-nhanh" disabled="@IsDisabled">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                                </svg>
                                                            </button>
                                                        </SfTooltip>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="SoPhieu" class="form-label">Số phiếu chi</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="soPhieu" CssClass="e-small" @bind-Value="@(SelectPhieuChi.SoPhieu)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgayHT" class="form-label">Ngày hạch toán <span class="text-danger">*</span></label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfDatePicker ID="ngayHT" TValue="DateTime?" CssClass="e-small" ShowClearButton="true" @bind-Value="@(SelectPhieuChi.NgayHT)" Format="dd/MM/yyyy" FullScreen="true" Enabled="!IsDisabled">
                                                        <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayht"></DatePickerEvents>
                                                    </SfDatePicker>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgayLap" class="form-label">Ngày lập phiếu chi</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfDatePicker ID="NgayLap" CssClass="e-small" @bind-Value="@(SelectPhieuChi.NgayLap)" Format="dd/MM/yyyy" Enabled="false"></SfDatePicker>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="ChungTu" class="form-label">Chứng từ kèm theo</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfTextBox ID="chungTu" CssClass="e-small" @bind-Value="@(SelectPhieuChi.ChungTu)" Enabled="!IsDisabled"></SfTextBox>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="ngoaiTeId" class="form-label">Tỷ giá <span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="d-flex align-items-center">
                                                <SfComboBox ID="ngoaiTeId" @ref="ddNT" @bind-Value="@SelectPhieuChi.NgoaiTeId" DataSource="@NgoaiTeDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="350" PopupHeight="300">
                                                    <ComboBoxEvents TValue="int?" TItem="NgoaiTeDto" Filtering="OnFilteringNgoaiTe" ValueChange="OnValueChangeNgoaiTe"></ComboBoxEvents>
                                                    <ComboBoxFieldSettings Text="NgoaiTeUd" Value="Id"></ComboBoxFieldSettings>
                                                    <ComboBoxTemplates TItem="NgoaiTeDto">
                                                        <HeaderTemplate>
                                                            <table class="header-combo">
                                                                <tr>
                                                                    <th>Mã ngoại tệ</th>
                                                                    <th>Tên ngoại tệ</th>
                                                                    <th>Tên 2</th>
                                                                </tr>
                                                            </table>
                                                        </HeaderTemplate>
                                                        <ItemTemplate Context="itemContext">
                                                            <table>
                                                                <tbody>
                                                                    <tr>
                                                                        <td><span>@((itemContext as NgoaiTeDto).NgoaiTeUd)</span></td>
                                                                        <td><span>@((itemContext as NgoaiTeDto).NgoaiTeNm)</span></td>
                                                                        <td><span>@((itemContext as NgoaiTeDto).NgoaiTeNm2)</span></td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </ItemTemplate>
                                                    </ComboBoxTemplates>
                                                </SfComboBox>
                                                <SfTooltip ID="TaoTG" Target="#target" Content="Thêm tỷ giá" Position="Position.RightTop" OpensOn="Hover">
                                                    <button id="target" type="button" class="btn-them-nhanh" disabled="@IsDisabled">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16" />
                                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                                                        </svg>
                                                    </button>
                                                </SfTooltip>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="tyGia" CssClass="e-small" @bind-Value="@(SelectPhieuChi.TyGia)" Format="N2" Enabled="!CheckNgoaiTe ? CheckNgoaiTe : !IsDisabled"></SfNumericTextBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        @if (ShowScreenGiaoDich1)
                        {
                            <SfTab>
                                <TabItems>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Chi tiết hạch toán"></TabHeader>
                                        </ChildContent>
                                        <ContentTemplate>
                                            <SfGrid ID="gridPhieuChiCt01" @ref="SfGridPhieuChiCt01" @attributes="@GridAttributes" DataSource="@PhieuChiCt01Requests" AllowSorting="true" AllowResizing="true" Height="200">
                                                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom" ></GridEditSettings>
                                                <GridEvents OnActionBegin="ActionBeginPhieuChiCt01" OnActionComplete="ActionCompletedPhieuChiCt01" RowUpdating="RowUpdatingPhieuChiCt01" OnRecordDoubleClick="RecordDoubleClickPhieuChiCt01" TValue="PhieuChiCt01Request"></GridEvents>
                                                <GridColumns>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Center" Width="60"></GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.SoHd) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Số hóa đơn <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt01Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="soHdCt01" @ref="ddSoHdCt01" @bind-Value="@(item.SoHd)" DataSource="@PhieuNhapDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1100" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="string?" TItem="PhieuNhapDto" Filtering="OnFilteringSoHdCt01" ValueChange="OnValueChangeSoHdCt01"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="SoHd" Value="SoHd"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="PhieuNhapDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:90px">Số hđ</th>
                                                                                        <th>Ngày hđ</th>
                                                                                        <th>Tổng tiền</th>
                                                                                        <th>Đã tt</th>
                                                                                        <th>Còn lại</th>
                                                                                        <th style="width:90px">Mã nt</th>
                                                                                        <th style="width:90px">Tỷ giá</th>
                                                                                        <th>Tổng tiền nt</th>
                                                                                        <th>Đã tt nt</th>
                                                                                        <th>Còn lại nt</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:90px"><span>@((itemContext as PhieuNhapDto).SoHd)</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).NgayHd?.ToString("dd/MM/yyyy"))</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).TienPhaiTtVND?.ToString("N0"))</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).TienTtVND?.ToString("N0"))</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).ConPhaiTtVND?.ToString("N0"))</span></td>
                                                                                            <td style="width:90px"><span>@((itemContext as PhieuNhapDto).NgoaiTeUd)</span></td>
                                                                                            <td style="width:90px"><span>@((itemContext as PhieuNhapDto).TiGia?.ToString("N2"))</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).TienPhaiTt?.ToString("N2"))</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).TienTt?.ToString("N2"))</span></td>
                                                                                            <td><span>@((itemContext as PhieuNhapDto).ConPhaiTt?.ToString("N2"))</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt01Request);
                                                                <div>@item?.SoHd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.NgayHd) HeaderText="Ngày hóa đơn" TextAlign="TextAlign.Left" EditType="EditType.DatePickerEdit" Format="dd/MM/yyyy" Width="150">
                                                        <EditTemplate>
                                                            <SfDatePicker Value="TempPhieuChiCt01.NgayHd" Format="dd/MM/yyyy" Enabled="false"></SfDatePicker>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.NgoaiTeUd) HeaderText="Mã ngoại tệ" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@TempPhieuChiCt01.NgoaiTeUd" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.GhiNoTkUd) HeaderText="Ghi nợ tài khoản" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@TempPhieuChiCt01.GhiNoTkUd" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.TienTrenHd) HeaderText="Tiền trên hóa đơn" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt01.TienTrenHd" Format="N0" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.DaTtVND) HeaderText="Đã thanh toán" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt01.DaTtVND" Format="N0" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.ConPhaiTtVND) HeaderText="Còn phải thanh toán" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt01.ConPhaiTtVND" Format="N0" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.ThanhToan) HeaderText="Thanh toán ngoại tệ" Visible="CheckNgoaiTe" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thanhToanCt01" ShowSpinButton="false" Value="@TempPhieuChiCt01.ThanhToan" Enabled="CheckNgoaiTe" Format="N2" @onchange="OnValueChangeThanhToanCt01"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.ThanhToanVND) HeaderText="Thanh toán" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thanhToanVNDCt01" ShowSpinButton="false" Value="@TempPhieuChiCt01.ThanhToanVND" Enabled="@(TempPhieuChiCt01.ThanhToan !=0 ? false : true)" Format="N0" @onchange="OnValueChangeThanhToanVNDCt01"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.ThanhToanQd) HeaderText="Thanh toán quy đổi" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt01.ThanhToanQd" Format="N0" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt01Request.DienGiai) HeaderText="Diễn giải" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox ID="dienGiaiCt01" Value="@TempPhieuChiCt01.DienGiai" @onchange="OnValueChangeDienGiaiCt01"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </ContentTemplate>
                                    </TabItem>
                                </TabItems>
                            </SfTab>
                        }
                        @if (ShowScreenGiaoDich2)
                        {
                            <SfTab>
                                <TabItems>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Chi tiết hạch toán"></TabHeader>
                                        </ChildContent>
                                        <ContentTemplate>
                                            <SfGrid ID="gridPhieuChiCt02" @ref="SfGridPhieuChiCt02" @attributes="@GridAttributes" DataSource="@PhieuChiCt02Requests" AllowSorting="true" AllowResizing="true" Height="200">
                                                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom" ></GridEditSettings>
                                                <GridEvents OnActionBegin="ActionBeginPhieuChiCt02" OnActionComplete="ActionCompletedPhieuChiCt02" RowUpdating="RowUpdatingPhieuChiCt02" OnRecordDoubleClick="RecordDoubleClickPhieuChiCt02" TValue="PhieuChiCt02Request"></GridEvents>
                                                <GridColumns>
                                                    <GridColumn Field=@nameof(PhieuChiCt02Request.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Center" Width="60"></GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt02Request.GhiNoTk) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Ghi nợ tài khoản <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt02Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="ghiNoTkCt02" @ref="@ddTKCt02" @bind-Value="@(item.GhiNoTk)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTaiKhoanCt02" ValueChange="OnValueChangeTaiKhoanCt02"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                                        <th>Tên tài khoản</th>
                                                                                        <th>Tên 2</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt02Request);
                                                                <div>@item?.GhiNoTkUd</div>
                                                            }
                                                        </Template>
                                                        </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt02Request.GhiNoTkNm) HeaderText="Tên tài khoản" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@TempPhieuChiCt02.GhiNoTkNm" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt02Request.PsNo) HeaderText="Phát sinh nợ ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="psNoCt02" ShowSpinButton="false" Enabled="CheckNgoaiTe" Value="@TempPhieuChiCt02.PsNo" Format="N2" @onchange="OnValueChangePsNoCt02"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt02Request.PsNoVND) HeaderText="Phát nợ" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="psNoVNDCt02" ShowSpinButton="false" Value="@TempPhieuChiCt02.PsNoVND" Enabled="@(TempPhieuChiCt02.PsNo !=0 ? false : true)" Format="N0" @onchange="OnValueChangePsNoVNDCt02"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt02Request.DienGiai) HeaderText="Diễn giải" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox ID="dienGiaiCt02" Value="@TempPhieuChiCt02.DienGiai" @onchange="OnValueChangeDienGiaiCt02"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </ContentTemplate>
                                    </TabItem>
                                </TabItems>
                            </SfTab>
                        }
                        @if (ShowScreenGiaoDich3)
                        {
                            <SfTab @bind-SelectedItem="@SelectedTab">
                                <TabItems>
                                    <TabEvents Selected="OnSelectTabAsync"></TabEvents>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Chi tiết hạch toán"></TabHeader>
                                        </ChildContent>
                                        <ContentTemplate>
                                            <SfGrid ID="gridPhieuChiCt03" @attributes="@GridAttributes" @ref="SfGridPhieuChiCt03" DataSource="@PhieuChiCt03Requests" AllowSorting="true" AllowResizing="true" Height="200">
                                                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom" ></GridEditSettings>
                                                <GridEvents OnActionBegin="ActionBeginPhieuChiCt03" OnActionComplete="ActionCompletedPhieuChiCt03" RowCreating="RowCreatingPhieuChiCt03" RowUpdating="RowUpdatingPhieuChiCt03" OnRecordDoubleClick="RecordDoubleClickPhieuChiCt03" TValue="PhieuChiCt03Request"></GridEvents>
                                                <GridColumns>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Center" Width="60"></GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.GhiNoTk) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Ghi nợ tài khoản <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt03Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="ghiNoTkCt03" @ref="@ddTKCt03" @bind-Value="@(item.GhiNoTk)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTaiKhoanCt03" ValueChange="OnValueChangeTaiKhoanCt03"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                                        <th>Tên tài khoản</th>
                                                                                        <th>Tên 2</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt03Request);
                                                                <div>@item?.GhiNoTkUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.GhiNoTkNm) HeaderText="Tên tài khoản" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@TempPhieuChiCt03.GhiNoTkNm" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.KhachHangId) HeaderText="Mã khách" EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Mã khách <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt03Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="khachHangCt03" @ref="ddKHCt03" @bind-Value="@(item.KhachHangId)" DataSource="@KhachHangDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1000" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="KhachHangDto" Filtering="OnFilteringKhachHangCt03" ValueChange="OnValueChangeKhachHangCt03"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="KhachHangUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="KhachHangDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã khách hàng</th>
                                                                                        <th>Tên khách</th>
                                                                                        <th style="width:150px">Mã số thuế</th>
                                                                                        <th style="width:150px">Số dư</th>
                                                                                        <th>Địa chỉ</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).KhachHangUd)</span></td>
                                                                                            <td><span>@((itemContext as KhachHangDto).KhachHangNm)</span></td>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).MaSoThue)</span></td>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).Sodu?.ToString("N0"))</span></td>
                                                                                            <td><span>@((itemContext as KhachHangDto).DiaChi)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt03Request);
                                                                <div>@item?.KhachHangUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.KhachHangNm) HeaderText="Tên khách" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@TempPhieuChiCt03.KhachHangNm" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.PsNo) HeaderText="Phát sinh có ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="psNoCt03" ShowSpinButton="false" Value="@TempPhieuChiCt03.PsNo" Enabled="CheckNgoaiTe" Format="N2" @onchange="OnValueChangePsNoCt03"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.PsNoVND) HeaderText="Phát sinh có" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="psNoVNDCt03" ShowSpinButton="false" Value="@TempPhieuChiCt03.PsNoVND" Enabled="@(TempPhieuChiCt03.PsNo != 0 ? false : true)" Format="N0" @onchange="OnValueChangePsNoVNDCt03"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.DienGiai) HeaderText="Diễn giải" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox ID="dienGiaiCt03" Value="@TempPhieuChiCt03.DienGiai" @onchange="OnValueChangeDienGiaiCt03"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.LoaiThue) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Loại thuế <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt03Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="loaiThueCt03" @ref="ddLTCt03" @bind-Value="@(item.LoaiThue)" DataSource="@DMChungDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="DmChungDto" Filtering="OnFilteringLoaiThueCt03" ValueChange="OnValueChangeLoaiThueCt03"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="DMChungUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="DmChungDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:100px">Mã mẫu</th>
                                                                                        <th>Tên mẫu</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:100px"><span>@((itemContext as DmChungDto).DMChungUd)</span></td>
                                                                                            <td><span>@((itemContext as DmChungDto).DMChungNm)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt03Request);
                                                                <div>@item?.LoaiThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.MaThue) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Mã thuế
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuChiCt03Request);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox ID="maThueCt03" @ref="ddTSCt03" @bind-Value="@(item.MaThue)" DataSource="@ThueSuatDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="ThueSuatDto" Filtering="OnFilteringThueSuatCt03" ValueChange="OnValueChangeThueSuatCt03"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="ThueSuatUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="ThueSuatDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th>Mã thuế</th>
                                                                                    <th style="width:250px">Tên thuế</th>
                                                                                    <th>Tên 2</th>
                                                                                    <th>Thuế suất</th>
                                                                                    <th>Tk có</th>
                                                                                    <th>Tk nợ</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td><span>@((itemContext as ThueSuatDto).ThueSuatUd)</span></td>
                                                                                        <td style="width:250px"><span>@((itemContext as ThueSuatDto).ThueSuatNm)</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).ThueSuatNm2)</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).GiaTri?.ToString("N2"))</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).TkCoUd)</span></td>
                                                                                        <td><span>@((itemContext as ThueSuatDto).TkNoUd)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                                var item = (context as PhieuChiCt03Request);
                                                            <div>@item?.MaThueUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.ThueSuat) HeaderText="Thuế suất(%)" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt03.ThueSuat" Format="N2" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.Thue) HeaderText="Tiền thuế ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueCt03" ShowSpinButton="false" Enabled="CheckNgoaiTe" Value="@TempPhieuChiCt03.Thue" Format="N2" @onchange="OnValueChangeThueCt03"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.ThueVND) HeaderText="Tiền thuế" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueVNDCt03" ShowSpinButton="false" Value="@TempPhieuChiCt03.ThueVND" Format="N2" @onchange="OnValueChangeThueVNDCt03"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.ThanhToan) HeaderText="Thanh toán ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt03.ThanhToan" Format="N2" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.ThanhToanVND) HeaderText="Thanh toán" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt03.ThanhToanVND" Format="N0" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.SoHd) HeaderText="Số hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="soHdCt03" Value="@TempPhieuChiCt03.SoHd" @onchange="OnValueChangeSoHdCt03"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.NgayHd) HeaderText="Ngày hóa đơn" Format="dd/MM/yyyy" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfDatePicker ID="ngayHdCt03" Value="@(TempPhieuChiCt03.NgayHd)" Format="dd/MM/yyyy">
                                                                 <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayHdCt03"></DatePickerEvents>
                                                            </SfDatePicker>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt03Request.SoSeri) HeaderText="Kí hiệu hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="soSeriCt03" Value="@TempPhieuChiCt03.SoSeri" @onchange="OnValueChangeKyHieuHdCt03"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </ContentTemplate>
                                    </TabItem>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Hóa Đơn GTGT"></TabHeader>
                                        </ChildContent>
                                        <ContentTemplate>
                                            <SfGrid ID="gridHoaDonGtgt" @ref="SfGridHoaDonGTGT" @attributes="@GridAttributes" DataSource="@HoaDonRequests" AllowSorting="true" AllowResizing="true" Height="200">
                                                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom"></GridEditSettings>
                                                <GridEvents TValue="HoaDonRequest" OnActionBegin="ActionBeginHoaDonGTGT" OnActionComplete="ActionCompletedHoaDonGTGT" RowCreating="RowCreatingHoaDonGTGT" RowUpdating="RowUpdatingHoaDonGTGT" OnRecordDoubleClick="RecordDoubleClickHoaDonGTGT"></GridEvents>
                                                <GridColumns>
                                                    <GridColumn Field=@nameof(HoaDonRequest.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Center" Width="60"></GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.LoaiThue) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Loại thuế <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="loaiThueGtgt" @ref="ddLTGtgt" @bind-Value="@(item.LoaiThue)" DataSource="@DMChungDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="DmChungDto" Filtering="OnFilteringLoaiThueGTGT" ValueChange="OnValueChangeLoaiThueGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="DMChungUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="DmChungDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã mẫu</th>
                                                                                        <th>Tên mẫu</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as DmChungDto).DMChungUd)</span></td>
                                                                                            <td><span>@((itemContext as DmChungDto).DMChungNm)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.LoaiThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.SoCt0) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Số hóa đơn <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfTextBox ID="soHdGtgt" @bind-Value="@(item.SoCt0)" @onchange="OnValueChangeSoHdGTGT"></SfTextBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.NgayCt0) Format="dd/MM/yyyy" EditType="EditType.DatePickerEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Ngày hóa đơn <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfDatePicker ID="ngayHdGtgt" @bind-Value="@(item.NgayCt0)" Format="dd/MM/yyyy">
                                                                        <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayHdGTGT"></DatePickerEvents>
                                                                    </SfDatePicker>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.SoSeri0) HeaderText="Kí hiệu hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="kyHieuGtgt" Value="@TempHoaDonCt.SoSeri0" @onchange="OnValueChangeKyHieuHdGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.KyHieuMauHD) HeaderText="Kí hiệu mẫu hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="kyHieuMauGtgt" Value="@TempHoaDonCt.KyHieuMauHD" @onchange="OnValueChangeKyHieuMauHdGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.KhachHangId) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Mã khách <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="khachHangGtgt" @ref="ddKHGtgt" @bind-Value="@(item.KhachHangId)" DataSource="@KhachHangDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1000" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="KhachHangDto" Filtering="OnFilteringKhachHangGTGT" ValueChange="OnValueChangeKhachHangGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="KhachHangUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="KhachHangDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã khách hàng</th>
                                                                                        <th>Tên khách</th>
                                                                                        <th style="width:150px">Mã số thuế</th>
                                                                                        <th style="width:150px">Số dư</th>
                                                                                        <th>Địa chỉ</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).KhachHangUd)</span></td>
                                                                                            <td><span>@((itemContext as KhachHangDto).KhachHangNm)</span></td>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).MaSoThue)</span></td>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).Sodu?.ToString("N0"))</span></td>
                                                                                            <td><span>@((itemContext as KhachHangDto).DiaChi)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.KhachHangUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.KhachHangNm) HeaderText="Tên khách" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@(TempHoaDonCt.KhachHangNm)" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.DiaChi) HeaderText="Địa chỉ" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@(TempHoaDonCt.DiaChi)" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.MaSoThue) HeaderText="Mã số thuế" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@(TempHoaDonCt.MaSoThue)" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.VatTu) HeaderText="Tên hàng hóa, dịch vụ" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="vatTuGtgt" Value="@TempHoaDonCt.VatTu" @onchange="OnValueChangeVatTuGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.Tien) HeaderText="Thành tiền ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Center" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="tienGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.Tien" Enabled="CheckNgoaiTe" @onchange="OnValueChangeTienGTGT" Format="N2"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.TienVND) HeaderText="Thành tiền" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="tienVNDGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.TienVND" @onchange="OnValueChangeTienVNDGTGT" Format="N0"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.MaThue) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Mã thuế
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="maThueGtgt" @ref="ddTSGtgt" @bind-Value="@(item.MaThue)" DataSource="@ThueSuatDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="ThueSuatDto" Filtering="OnFilteringThueSuatGTGT" ValueChange="OnValueChangeThueSuatGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="ThueSuatUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="ThueSuatDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th>Mã thuế</th>
                                                                                        <th style="width:250px">Tên thuế</th>
                                                                                        <th>Tên 2</th>
                                                                                        <th>Thuế suất</th>
                                                                                        <th>Tk có</th>
                                                                                        <th>Tk nợ</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td><span>@((itemContext as ThueSuatDto).ThueSuatUd)</span></td>
                                                                                            <td style="width:250px"><span>@((itemContext as ThueSuatDto).ThueSuatNm)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).ThueSuatNm2)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).GiaTri?.ToString("N2"))</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).TkCoUd)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).TkNoUd)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.MaThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.ThueSuat) HeaderText="Thuế suất(%)" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempHoaDonCt.ThueSuat" Enabled="false" Format="N2"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.Thue) HeaderText="Tiền thuế ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.Thue" Enabled="CheckNgoaiTe" @onchange="OnValueChangeThueGTGT" Format="N2"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.ThueVND) HeaderText="Tiền thuế" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueVNDGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.ThueVND" @onchange="OnValueChangeThueVNDGTGT" Format="N0"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.TkThue) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Tài khoản thuế <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="tkThueGtgt" @ref="ddTKTGtgt" @bind-Value="@(item.TkThue)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTKThueGTGT" ValueChange="OnValueChangeTKThueGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                                        <th>Tên tài khoản</th>
                                                                                        <th>Tên 2</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.TkThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.GhiChu) HeaderText="Ghi chú" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox ID="ghiChuGtgt" Value="@TempHoaDonCt.GhiChu" @onchange="OnValueChangeGhiChuGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </ContentTemplate>
                                    </TabItem>
                                </TabItems>
                            </SfTab>
                        }
                        @if (ShowScreenGiaoDich4)
                        {
                            <SfTab @bind-SelectedItem="@SelectedTab">
                                <TabItems>
                                    <TabEvents Selected="OnSelectTabAsync"></TabEvents>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Chi tiết hạch toán"></TabHeader>
                                        </ChildContent>
                                        <ContentTemplate>
                                            <SfGrid ID="gridPhieuChiCt04"  @ref="SfGridPhieuChiCt04" @attributes="@GridAttributes" DataSource="@PhieuChiCt04Requests" AllowSorting="true" AllowResizing="true" Height="200">
                                                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom" ></GridEditSettings>
                                                <GridEvents OnActionBegin="ActionBeginPhieuChiCt04" OnActionComplete="ActionCompletedPhieuChiCt04" RowCreating="RowCreatingPhieuChiCt04" RowUpdating="RowUpdatingPhieuChiCt04" OnRecordDoubleClick="RecordDoubleClickPhieuChiCt04" TValue="PhieuChiCt04Request"></GridEvents>
                                                <GridColumns>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Center" Width="60"></GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.GhiNoTk) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Ghi nợ tài khoản <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt04Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="ghiNoTkCt04" @ref="@ddTKCt04" @bind-Value="@(item.GhiNoTk)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTaiKhoanCt04" ValueChange="OnValueChangeTaiKhoanCt04"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                                        <th>Tên tài khoản</th>
                                                                                        <th>Tên 2</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt04Request);
                                                                <div>@item?.GhiNoTkUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.GhiNoTkNm) HeaderText="Tên tài khoản" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@TempPhieuChiCt04.GhiNoTkNm" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.PsNo) HeaderText="Phát sinh có ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="psNoCt04" ShowSpinButton="false" Value="@TempPhieuChiCt04.PsNo" Format="N2" Enabled="CheckNgoaiTe" @onchange="OnValueChangePsNoCt04"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.PsNoVND) HeaderText="Phát sinh có" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="psNoVNDCt04" ShowSpinButton="false" Value="@TempPhieuChiCt04.PsNoVND" Enabled="@(TempPhieuChiCt04.PsNo !=0 ? false : true)" Format="N0" @onchange="OnValueChangePsNoVNDCt04"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.DienGiai) HeaderText="Diễn giải" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox ID="dienGiaiCt04" Value="@TempPhieuChiCt04.DienGiai" @onchange="OnValueChangeDienGiaiCt04"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.LoaiThue) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Loại thuế <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt04Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="loaiThueCt04" @ref="ddLTCt04" @bind-Value="@(item.LoaiThue)" DataSource="@DMChungDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="DmChungDto" Filtering="OnFilteringLoaiThueCt04" ValueChange="OnValueChangeLoaiThueCt04"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="DMChungUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="DmChungDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:100px">Mã mẫu</th>
                                                                                        <th>Tên mẫu</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:100px"><span>@((itemContext as DmChungDto).DMChungUd)</span></td>
                                                                                            <td><span>@((itemContext as DmChungDto).DMChungNm)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt04Request);
                                                                <div>@item?.LoaiThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.MaThue) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Mã thuế
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as PhieuChiCt04Request);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="maThueCt04" @ref="ddTSCt04" @bind-Value="@(item.MaThue)" DataSource="@ThueSuatDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="ThueSuatDto" Filtering="OnFilteringThueSuatCt04" ValueChange="OnValueChangeThueSuatCt04"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="ThueSuatUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="ThueSuatDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th>Mã thuế</th>
                                                                                        <th style="width:250px">Tên thuế</th>
                                                                                        <th>Tên 2</th>
                                                                                        <th>Thuế suất</th>
                                                                                        <th>Tk có</th>
                                                                                        <th>Tk nợ</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td><span>@((itemContext as ThueSuatDto).ThueSuatUd)</span></td>
                                                                                            <td style="width:250px"><span>@((itemContext as ThueSuatDto).ThueSuatNm)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).ThueSuatNm2)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).GiaTri?.ToString("N2"))</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).TkCoUd)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).TkNoUd)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as PhieuChiCt04Request);
                                                                <div>@item?.MaThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.ThueSuat) HeaderText="Thuế suất(%)" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt04.ThueSuat" Format="N2" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.Thue) HeaderText="Tiền thuế ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueCt04" ShowSpinButton="false" Value="@TempPhieuChiCt04.Thue" Enabled="CheckNgoaiTe" Format="N2" @onchange="OnValueChangeThueCt04"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.ThueVND) HeaderText="Tiền thuế" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueVNDCt04" ShowSpinButton="false" Value="@TempPhieuChiCt04.ThueVND" Format="N2" @onchange="OnValueChangeThueVNDCt04"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.ThanhToan) HeaderText="Thanh toán ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt04.ThanhToan" Format="N2" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.ThanhToanVND) HeaderText="Thanh toán" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempPhieuChiCt04.ThanhToanVND" Format="N0" Enabled="false"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.SoHd) HeaderText="Số hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="soHdCt04" Value="@TempPhieuChiCt04.SoHd" @onchange="OnValueChangeSoHdCt04"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.NgayHd) HeaderText="Ngày hóa đơn" EditType="EditType.DatePickerEdit" Format="dd/MM/yyyy" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfDatePicker ID="ngayHdCt04" Value="@(TempPhieuChiCt04.NgayHd)" Format="dd/MM/yyyy">
                                                                 <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayHdCt04"></DatePickerEvents>
                                                            </SfDatePicker>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(PhieuChiCt04Request.SoSeri) HeaderText="Kí hiệu hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="soSeriCt04" Value="@TempPhieuChiCt04.SoSeri" @onchange="OnValueChangeKyHieuHdCt04"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </ContentTemplate>
                                    </TabItem>
                                    <TabItem>
                                        <ChildContent>
                                            <TabHeader Text="Hóa Đơn GTGT"></TabHeader>
                                        </ChildContent>
                                        <ContentTemplate>
                                            <SfGrid ID="gridHoaDonGtgt" @ref="SfGridHoaDonGTGT" @attributes="@GridAttributes" DataSource="@HoaDonRequests" AllowSorting="true" AllowResizing="true" Height="200">
                                                <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom"></GridEditSettings>
                                                <GridEvents TValue="HoaDonRequest" OnActionBegin="ActionBeginHoaDonGTGT" OnActionComplete="ActionCompletedHoaDonGTGT" RowCreating="RowCreatingHoaDonGTGT" RowUpdating="RowUpdatingHoaDonGTGT" OnRecordDoubleClick="RecordDoubleClickHoaDonGTGT"></GridEvents>
                                                <GridColumns>
                                                    <GridColumn Field=@nameof(HoaDonRequest.Stt) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Center" Width="60"></GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.LoaiThue) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Loại thuế <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="loaiThueGtgt" @ref="ddLTGtgt" @bind-Value="@(item.LoaiThue)" DataSource="@DMChungDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="600" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="DmChungDto" Filtering="OnFilteringLoaiThueGTGT" ValueChange="OnValueChangeLoaiThueGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="DMChungUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="DmChungDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã mẫu</th>
                                                                                        <th>Tên mẫu</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as DmChungDto).DMChungUd)</span></td>
                                                                                            <td><span>@((itemContext as DmChungDto).DMChungNm)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.LoaiThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.SoCt0) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Số hóa đơn <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfTextBox ID="soHdGtgt" @bind-Value="@(item.SoCt0)" @onchange="OnValueChangeSoHdGTGT"></SfTextBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.NgayCt0) Format="dd/MM/yyyy" EditType="EditType.DatePickerEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Ngày hóa đơn <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfDatePicker ID="ngayHdGtgt" @bind-Value="@(item.NgayCt0)" Format="dd/MM/yyyy">
                                                                        <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayHdGTGT"></DatePickerEvents>
                                                                    </SfDatePicker>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.SoSeri0) HeaderText="Kí hiệu hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="kyHieuGtgt" Value="@TempHoaDonCt.SoSeri0" @onchange="OnValueChangeKyHieuHdGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.KyHieuMauHD) HeaderText="Kí hiệu mẫu hóa đơn" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="kyHieuMauGtgt" Value="@TempHoaDonCt.KyHieuMauHD" @onchange="OnValueChangeKyHieuMauHdGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.KhachHangId) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Mã khách <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="khachHangGtgt" @ref="ddKHGtgt" @bind-Value="@(item.KhachHangId)" DataSource="@KhachHangDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1000" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="KhachHangDto" Filtering="OnFilteringKhachHangGTGT" ValueChange="OnValueChangeKhachHangGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="KhachHangUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="KhachHangDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã khách hàng</th>
                                                                                        <th>Tên khách</th>
                                                                                        <th style="width:150px">Mã số thuế</th>
                                                                                        <th style="width:150px">Số dư</th>
                                                                                        <th>Địa chỉ</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).KhachHangUd)</span></td>
                                                                                            <td><span>@((itemContext as KhachHangDto).KhachHangNm)</span></td>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).MaSoThue)</span></td>
                                                                                            <td style="width:130px"><span>@((itemContext as KhachHangDto).Sodu?.ToString("N0"))</span></td>
                                                                                            <td><span>@((itemContext as KhachHangDto).DiaChi)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.KhachHangUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.KhachHangNm) HeaderText="Tên khách" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@(TempHoaDonCt.KhachHangNm)" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.DiaChi) HeaderText="Địa chỉ" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@(TempHoaDonCt.DiaChi)" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.MaSoThue) HeaderText="Mã số thuế" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox Value="@(TempHoaDonCt.MaSoThue)" Enabled="false"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.VatTu) HeaderText="Tên hàng hóa, dịch vụ" TextAlign="TextAlign.Left" Width="150">
                                                        <EditTemplate>
                                                            <SfTextBox ID="vatTuGtgt" Value="@TempHoaDonCt.VatTu" @onchange="OnValueChangeVatTuGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.Tien) HeaderText="Thành tiền ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Center" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="tienGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.Tien" Enabled="CheckNgoaiTe" @onchange="OnValueChangeTienGTGT" Format="N2"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.TienVND) HeaderText="Thành tiền" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="tienVNDGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.TienVND" @onchange="OnValueChangeTienVNDGTGT" Format="N0"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.MaThue) EditType="EditType.DropDownEdit" TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Mã thuế
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="maThueGtgt" @ref="ddTSGtgt" @bind-Value="@(item.MaThue)" DataSource="@ThueSuatDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="ThueSuatDto" Filtering="OnFilteringThueSuatGTGT" ValueChange="OnValueChangeThueSuatGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="ThueSuatUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="ThueSuatDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th>Mã thuế</th>
                                                                                        <th style="width:250px">Tên thuế</th>
                                                                                        <th>Tên 2</th>
                                                                                        <th>Thuế suất</th>
                                                                                        <th>Tk có</th>
                                                                                        <th>Tk nợ</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td><span>@((itemContext as ThueSuatDto).ThueSuatUd)</span></td>
                                                                                            <td style="width:250px"><span>@((itemContext as ThueSuatDto).ThueSuatNm)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).ThueSuatNm2)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).GiaTri?.ToString("N2"))</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).TkCoUd)</span></td>
                                                                                            <td><span>@((itemContext as ThueSuatDto).TkNoUd)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.MaThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.ThueSuat) HeaderText="Thuế suất(%)" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ShowSpinButton="false" Value="@TempHoaDonCt.ThueSuat" Enabled="false" Format="N2"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.Thue) HeaderText="Tiền thuế ngoại tệ" Visible="CheckNgoaiTe" EditType="EditType.NumericEdit" Format="N2" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.Thue" Enabled="CheckNgoaiTe" @onchange="OnValueChangeThueGTGT" Format="N2"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.ThueVND) HeaderText="Tiền thuế" EditType="EditType.NumericEdit" Format="N0" TextAlign="TextAlign.Right" Width="150">
                                                        <EditTemplate>
                                                            <SfNumericTextBox ID="thueVNDGtgt" ShowSpinButton="false" Value="@TempHoaDonCt.ThueVND" @onchange="OnValueChangeThueVNDGTGT" Format="N0"></SfNumericTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.TkThue) TextAlign="TextAlign.Left" Width="150">
                                                        <HeaderTemplate>
                                                            Tài khoản thuế <span style="color:red">*</span>
                                                        </HeaderTemplate>
                                                        <EditTemplate>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                if (item != null)
                                                                {
                                                                    <SfComboBox ID="tkThueGtgt" @ref="ddTKTGtgt" @bind-Value="@(item.TkThue)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                        <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringTKThueGTGT" ValueChange="OnValueChangeTKThueGTGT"></ComboBoxEvents>
                                                                        <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                        <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                            <HeaderTemplate>
                                                                                <table class="header-combo">
                                                                                    <tr>
                                                                                        <th style="width:150px">Mã tài khoản</th>
                                                                                        <th>Tên tài khoản</th>
                                                                                        <th>Tên 2</th>
                                                                                    </tr>
                                                                                </table>
                                                                            </HeaderTemplate>
                                                                            <ItemTemplate Context="itemContext">
                                                                                <table>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                            <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                            </ItemTemplate>
                                                                        </ComboBoxTemplates>
                                                                    </SfComboBox>
                                                                }
                                                            }
                                                        </EditTemplate>
                                                        <Template>
                                                            @{
                                                                var item = (context as HoaDonRequest);
                                                                <div>@item?.TkThueUd</div>
                                                            }
                                                        </Template>
                                                    </GridColumn>
                                                    <GridColumn Field=@nameof(HoaDonRequest.GhiChu) HeaderText="Ghi chú" TextAlign="TextAlign.Left" Width="300">
                                                        <EditTemplate>
                                                            <SfTextBox ID="ghiChuGtgt" Value="@TempHoaDonCt.GhiChu" @onchange="OnValueChangeGhiChuGTGT"></SfTextBox>
                                                        </EditTemplate>
                                                    </GridColumn>
                                                </GridColumns>
                                            </SfGrid>
                                        </ContentTemplate>
                                    </TabItem>
                                </TabItems>
                            </SfTab>
                        }
                        <div class="d-flex align-items-Left">
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="AddRowCtAsync" disabled="@IsDisabled">Thêm dòng <b>F4</b></button>
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="DeleteRowCtAsync" disabled="@IsDisabled">Xóa dòng <b>F8</b> </button>
                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="CancelCtAsync" disabled="@IsDisabled">Hủy thao tác <b>F10</b></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <div class="row">
                            <div class="col-sm-2">
                                <label for="HoaDonGTGT" class="form-label">Số lượng hóa đơn</label>
                            </div>
                            <div class="col-sm-2">
                                <div class="d-flex align-items-center">
                                    <SfNumericTextBox @ref="SfHoaDonGtgt" ShowSpinButton="false" ID="HoaDonGTGT" CssClass="e-small" TValue="int?" @bind-Value="@(SelectPhieuChi.HoaDonGTGT)" Min="0" @onblur="SoLuongHoaDonGTGTValueChangeAsync" Enabled="!CheckShowSoLuongHD ? CheckShowSoLuongHD : !IsDisabled"></SfNumericTextBox>
                                </div>
                            </div>
                            <div class="col-sm-1">
                                <label for="TkThueUd" class="form-label">Tk thuế</label>
                            </div>
                            <div class="col-sm-2">
                                <SfTextBox ID="TkThueUd" CssClass="e-small" @bind-Value="@(SelectPhieuChi.TkThueUd)" Enabled="false"></SfTextBox>
                            </div>
                            <div class="col-sm-5">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <label for="Tien" class="form-label">Tiền hàng</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" CssClass="e-small" ID="TienVND" @bind-Value="@(SelectPhieuChi.TienVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (CheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" CssClass="e-small" ID="Tien" @bind-Value="@(SelectPhieuChi.Tien)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <label for="TienThue" class="form-label">Tiền thuế</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" CssClass="e-small" ID="TienThueVND" @bind-Value="@(SelectPhieuChi.TienThueVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (CheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" CssClass="e-small" ID="TienThue" @bind-Value="@(SelectPhieuChi.TienThue)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <label for="TongTien" class="form-label">Tổng tiền</label>
                                        </div>
                                        <div class="col-sm-4">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TongTienVND" CssClass="e-small" @bind-Value="@(SelectPhieuChi.TongTienVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        @if (CheckNgoaiTe)
                                        {
                                            <div class="col-sm-4">
                                                <SfNumericTextBox ShowSpinButton="false" ID="TongTien" CssClass="e-small" @bind-Value="@(SelectPhieuChi.TongTien)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <br />
            <FooterMenu IsSave="true" IsSaveDisabled="IsSaveDisabled" IsCancel="true" IsCancelDisabled="IsCancelDisabled" OnValidSubmitCancel="Cancel"
                        IsAdd="true" IsAddDisabled="IsAddDisabled" OnValidSubmitAdd="Add"
                        IsEdit="true" IsEditDisabled="IsEditDisabled" OnValidSubmitEdit="Edit"
                        IsDelete="true" IsDeleteDisabled="IsDeleteDisabled" OnValidSubmitDelete="Delete"
                        IsPrint="true" IsPrintDisabled="IsPrintDisabled"
                        IsCopy="true" IsCopyDisabled="IsCopyDisabled" OnValidSubmitCopy="Copy"
                        IsClose="true" IsCloseDisabled="IsCloseDisabled" OnValidSubmitClose="Close"
                        IsNextDisabled="IsNextDisabled" IsNext="true" OnValidSubmitFirst="FirstAsync" OnValidSubmitPrevious="PreviousAsync" OnValidSubmitNext="NextAsync" OnValidSubmitLast="LastAsync" />
        </EditForm>
    </div>

    <!-- ModalCreate -->
    <SfDialog ID="modalCreateCN" @bind-Visible="ShowModalTaoMoiCN" Width="640px" AllowPrerender="true" IsModal="true">
        <DialogTemplates>
            <Header>
                <div>
                    <h1 class="modal-title fs-5">
                        <img src="/images/Button/Moi.png" alt="icon" width="16" height="16">
                        <strong>Thêm mới</strong>
                    </h1>
                </div>
            </Header>
            <Content>
                <TaoMoiChiNhanh OnValidSubmitModalCreate="CloseModal" />
            </Content>
        </DialogTemplates>
    </SfDialog>


    <SfDialog ID="modalCreateKH" @bind-Visible="ShowModalTaoMoiKH" Width="840px" AllowPrerender="true" IsModal="true">
        <DialogTemplates>
            <Header>
                <div>
                    <h1 class="modal-title fs-5">
                        <img src="/images/Button/Moi.png" alt="icon" width="16" height="16">
                        <strong>Thêm mới</strong>
                    </h1>
                </div>
            </Header>
            <Content>
                <TaoMoiKhachHang OnValidSubmitModalCreate="CloseModal" LoaiPhieu="@SystemConstants.LoaiPhieu.GiayBaoNo" />
            </Content>
        </DialogTemplates>
    </SfDialog>

    <ModalErrorMessage ShowModalMessage="@ShowModalMessage" CheckMessage="@CheckMessage" TextMessage="@TextMessage" IsDelete="@IsDeleteMessage"
                       OnCloseMessage="CloseModalMessage" OnConfirmDelele="ConfirmDeleleAsync" IsConfirm="@IsConfirmMessage" OnConfirm="ConfirmCancelAsync" />

}
else
{
    <h3>Vui lòng chờ....</h3>
}

@code {

    private GiaTriThamSoHeThongDto ThamSoHeThong = new GiaTriThamSoHeThongDto();
    private PhieuChiRequest SelectPhieuChi = new PhieuChiRequest()
        {
            TienVND = 0,
            TienThueVND = 0,
            TongTienVND = 0,
            Tien = 0,
            TienThue = 0,
            TongTien = 0,
            HoaDonGTGT = 0
        };
    private SfNumericTextBox<int?> SfHoaDonGtgt = new SfNumericTextBox<int?>();
    private List<ChiNhanhDto> ChiNhanhDtos = new List<ChiNhanhDto>();
    private SfComboBox<int?, ChiNhanhDto> ddCN = new SfComboBox<int?, ChiNhanhDto>();
    private List<DmChungDto> MaGiaoDichDtos = new List<DmChungDto>();
    private SfComboBox<int?, DmChungDto> ddGD = new SfComboBox<int?, DmChungDto>();
    private List<KhachHangDto> KhachHangDtos = new List<KhachHangDto>();
    private SfComboBox<int?, KhachHangDto> ddKH = new SfComboBox<int?, KhachHangDto>();
    private SfComboBox<int?, KhachHangDto> ddKHCt03 = new SfComboBox<int?, KhachHangDto>();
    private SfComboBox<int?, KhachHangDto> ddKHGtgt = new SfComboBox<int?, KhachHangDto>();
    private List<QuyenSoDto> QuyenSoDtos = new List<QuyenSoDto>();
    private SfComboBox<string?, QuyenSoDto> ddQS = new SfComboBox<string?, QuyenSoDto>();
    private List<TaiKhoanDto> TaiKhoanDtos = new List<TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTK = new SfComboBox<int?, TaiKhoanDto>();
    private List<NgoaiTeDto> NgoaiTeDtos = new List<NgoaiTeDto>();
    private SfComboBox<int?, NgoaiTeDto> ddNT = new SfComboBox<int?, NgoaiTeDto>();

    private SfComboBox<int?, TaiKhoanDto> ddTKCt02 = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKCt03 = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKTGtgt = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKCt04 = new SfComboBox<int?, TaiKhoanDto>();
    private List<DmChungDto> DMChungDtos = new List<DmChungDto>();
    private SfComboBox<int?, DmChungDto> ddLTCt03 = new SfComboBox<int?, DmChungDto>();
    private SfComboBox<int?, DmChungDto> ddLTCt04 = new SfComboBox<int?, DmChungDto>();
    private SfComboBox<int?, DmChungDto> ddLTGtgt = new SfComboBox<int?, DmChungDto>();
    private List<BoPhanHTDto> BoPhanHTDtos = new List<BoPhanHTDto>();
    private List<VatTuDto> VatTuDtos = new List<VatTuDto>();
    private List<VuViecDto> VuViecDtos = new List<VuViecDto>();
    private List<DmMaPhiDto> DmMaPhiDtos = new List<DmMaPhiDto>();
    private List<DieuChinhThueTNDnDto> DieuChinhThueTNDnDtos = new List<DieuChinhThueTNDnDto>();
    private List<DmTruongTuDoDto> DmTruongTuDo1Dtos = new List<DmTruongTuDoDto>();
    private List<DmTruongTuDoDto> DmTruongTuDo2Dtos = new List<DmTruongTuDoDto>();
    private List<DmTruongTuDoDto> DmTruongTuDo3Dtos = new List<DmTruongTuDoDto>();
    private List<ThueSuatDto>? ThueSuatDtos;
    private SfComboBox<int?, ThueSuatDto> ddTSCt03 = new SfComboBox<int?, ThueSuatDto>();
    private SfComboBox<int?, ThueSuatDto> ddTSCt04 = new SfComboBox<int?, ThueSuatDto>();
    private SfComboBox<int?, ThueSuatDto> ddTSGtgt = new SfComboBox<int?, ThueSuatDto>();
    private List<PhieuNhapDto> PhieuNhapDtos = new List<PhieuNhapDto>();
    private SfComboBox<string?, PhieuNhapDto> ddSoHdCt01 = new SfComboBox<string?, PhieuNhapDto>();

    private List<HoaDonRequest> HoaDonRequests = new List<HoaDonRequest>();
    private SfGrid<HoaDonRequest> SfGridHoaDonGTGT = new SfGrid<HoaDonRequest>();
    private HoaDonRequest TempHoaDonCt = new HoaDonRequest();

    private List<PhieuChiCTRequest> PhieuChiCtRequests = new List<PhieuChiCTRequest>();
    private bool ShowScreenGiaoDich1 = false;
    private List<PhieuChiCt01Request> PhieuChiCt01Requests = new List<PhieuChiCt01Request>();
    private SfGrid<PhieuChiCt01Request> SfGridPhieuChiCt01 = new SfGrid<PhieuChiCt01Request>();
    private PhieuChiCt01Request TempPhieuChiCt01 = new PhieuChiCt01Request();
    private bool ShowScreenGiaoDich2 = false;
    private List<PhieuChiCt02Request> PhieuChiCt02Requests = new List<PhieuChiCt02Request>();
    private SfGrid<PhieuChiCt02Request> SfGridPhieuChiCt02 = new SfGrid<PhieuChiCt02Request>();
    private PhieuChiCt02Request TempPhieuChiCt02 = new PhieuChiCt02Request();
    private bool ShowScreenGiaoDich3 = false;
    private List<PhieuChiCt03Request> PhieuChiCt03Requests = new List<PhieuChiCt03Request>();
    private SfGrid<PhieuChiCt03Request> SfGridPhieuChiCt03 = new SfGrid<PhieuChiCt03Request>();
    private PhieuChiCt03Request TempPhieuChiCt03 = new PhieuChiCt03Request();
    private bool ShowScreenGiaoDich4 = true;
    private List<PhieuChiCt04Request> PhieuChiCt04Requests = new List<PhieuChiCt04Request>();
    private SfGrid<PhieuChiCt04Request> SfGridPhieuChiCt04 = new SfGrid<PhieuChiCt04Request>();
    private PhieuChiCt04Request TempPhieuChiCt04 = new PhieuChiCt04Request();
    private bool CheckShowSoLuongHD = true;
    private bool hasRefreshed = false;
    //Thời gian làm việc
    DateTime? TuNgay;
    DateTime? DenNgay;
    //Thời gian làm việc end
    //Thông báo message
    private bool ShowModalMessage = false;
    private bool CheckMessage = false;
    private string? TextMessage { set; get; }
    private bool IsDeleteMessage { set; get; }
    private bool IsConfirmMessage { set; get; }
    //Thông báo message end

    private bool CheckNgoaiTe = false;
    private bool CheckEnabledMaGiaoDich = true;
    private int SelectedTab { get; set; } = 0;

    private bool ShowModalTaoMoiCN = false;
    private bool ShowModalTaoMoiKH = false;

    //Footer menu
    public string? NewId { set; get; }
    public bool IsDisabled { set; get; } = false;
    public bool IsSaveDisabled { set; get; }
    public bool IsCancelDisabled { set; get; }
    public bool IsAddDisabled { set; get; } = true;
    public bool IsEditDisabled { set; get; } = true;
    public bool IsDeleteDisabled { set; get; } = true;
    public bool IsPrintDisabled { set; get; } = true;
    public bool IsCopyDisabled { set; get; } = true;
    public bool IsCloseDisabled { set; get; } = true;
    public bool IsNextDisabled { set; get; } = true;
    private Dictionary<string, object> GridAttributes { get; set; } = new Dictionary<string, object>();
    public List<PhieuChiDto> PhieuChiDtos = new List<PhieuChiDto>();
    private int CurrentIndex = 0;
    //Footer menu end

    //Include js
    private IJSObjectReference? jsModule; // module chứa file js được khai báo
    private string FileNameJS = "phieu-chi.js";
    private string[] InputCommonIds = new string[12] { "giaoDichId", "chiNhanhId", "khachHangId", "nguoiNhan", "ghiCoTkId", "dienGiai", "quyenSoId", "soPhieu", "chungTu", "ngayHT", "ngoaiTeId", "tyGia"};
    private string[] InputCt01Ids = new string[4] { "soHdCt01", "thanhToanCt01", "thanhToanVNDCt01", "dienGiaiCt01"};
    private string[] InputCt02Ids = new string[4] { "ghiNoTkCt02", "psNoCt02", "psNoVNDCt02", "dienGiaiCt02"};
    private string[] InputCt03Ids = new string[12] { "ghiNoTkCt03", "khachHangCt03", "psNoCt03", "psNoVNDCt03", "dienGiaiCt03", "loaiThueCt03", "maThueCt03", "thueCt03", "thueVNDCt03", "soHdCt03", "ngayHdCt03", "soSeriCt03" };
    private string[] InputCt04Ids = new string[11] { "ghiNoTkCt04", "psNoCt04", "psNoVNDCt04", "dienGiaiCt04", "loaiThueCt04", "maThueCt04", "thueCt04", "thueVNDCt04", "soHdCt04", "ngayHdCt04", "soSeriCt04" };
    private string[] InputHoaDonGtgtIds = new string[14] { "loaiThueGtgt", "soHdGtgt", "ngayHdGtgt", "kyHieuGtgt", "kyHieuMauGtgt", "khachHangGtgt", "vatTuGtgt", "tienGtgt", "tienVNDGtgt", "maThueGtgt", "thueGtgt", "thueVNDGtgt", "tkThueGtgt", "ghiChuGtgt"};
    private string[] GridIds = new string[5] { "gridPhieuChiCt01", "gridPhieuChiCt02", "gridPhieuChiCt03", "gridPhieuChiCt04", "gridHoaDonGtgt"};
    //Include js end

    protected override async Task OnInitializedAsync()
    {
        if (!hasRefreshed)
        {
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);

            if (queryParams["copyId"] != null)
            {
                NewId = queryParams["copyId"];
            }
            if (NewId != null)
            {
                await RefreshAsync();
                await DefaultData(CurrentIndex, true);
                if (QuyenSoDtos.Count > 0)
                    this.DefaultValueQuyenSo(QuyenSoDtos);
            }
            else
            {
                TuNgay = await _localStorage.GetItemAsync<string>("TuNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("TuNgayLamViec")) : null;
                DenNgay = await _localStorage.GetItemAsync<string>("DenNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("DenNgayLamViec")): null;
                SelectPhieuChi.NgayHT = await _utilities.DefultNgayHt(TuNgay, DenNgay);
                SelectPhieuChi.NgayLap = SelectPhieuChi.NgayHT;
                ChiNhanhDtos = await _chiNhanh.GetListAsync();
                if (ChiNhanhDtos.Count > 0)
                    this.DefaultValueChiNhanh(ChiNhanhDtos);
                MaGiaoDichDtos = await _dmChung.GetListAsync(SystemConstants.DmChung.GiaoDichNo);
                if (MaGiaoDichDtos.Count > 0)
                    this.DefaultValueMaGiaDich(MaGiaoDichDtos);
                KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai2);
                QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.GiayBaoNo);
                if (QuyenSoDtos.Count > 0)
                    this.DefaultValueQuyenSo(QuyenSoDtos);
                TaiKhoanDtos = await _taiKhoan.GetListAsync();
                if (TaiKhoanDtos.Count > 0)
                    this.DefaultValueGhiCoTaiKhoan(TaiKhoanDtos);
                NgoaiTeDtos = await _ngoaiTe.GetListAsync();
                if (NgoaiTeDtos.Count > 0)
                    await this.DefaultValueNgoaiTe(NgoaiTeDtos);
                DMChungDtos = await _dmChung.GetListAsync(SystemConstants.DmChung.LoaiThue);
                ThueSuatDtos = await _thueSuat.GetListAsync();
                BoPhanHTDtos = await _boPhanHT.GetListAsync();
                //VatTuDtos = await _vatTu.GetListAsync();
                VuViecDtos = await _vuViec.GetListAsync();
                DmMaPhiDtos = await _dmMaPhi.GetListAsync();
                DieuChinhThueTNDnDtos = await _dieuChinhThueTNDN.GetListAsync();
                DmTruongTuDo1Dtos = await _dmTruongTuDo.GetListLoai1Async();
                DmTruongTuDo2Dtos = await _dmTruongTuDo.GetListLoai2Async();
                DmTruongTuDo3Dtos = await _dmTruongTuDo.GetListLoai3Async();
                await this.GetDataThamHoHeThongAsync();
            }
            hasRefreshed = true;
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRunTime.InvokeVoidAsync("getDotNetObjectReference", DotNetObjectReference.Create(this));
            jsModule = await JSRunTime.InvokeAsync<IJSObjectReference>("import", $"./js/{FileNameJS}");
            await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt04Ids, GridIds[3]);
        }
    }
    private async Task GetDataThamHoHeThongAsync()
    {
        ThamSoHeThong = await _phieuChi.GetGiaTriThamSoAsync();
        SelectPhieuChi.TkThue = ThamSoHeThong.TkThue;
        SelectPhieuChi.TkThueUd = ThamSoHeThong.TkThueUd;
    }
    public async Task OnFilteringChiNhanh(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ChiNhanhUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ChiNhanhNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddCN.FilterAsync(ChiNhanhDtos, query);
    }
    private void OnValueChangeChiNhanh(ChangeEventArgs<int?, ChiNhanhDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuChi.ChiNhanhNm = args.ItemData.ChiNhanhNm;
        }

    }
    public async Task OnFilteringMaGiaoDich(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "DMChungUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "DMChungNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddGD.FilterAsync(MaGiaoDichDtos, query);
    }
    private async Task OnValueChangeMaGiaoDich(ChangeEventArgs<int?, DmChungDto> args)
    {
        if (args.ItemData != null)
        {
            HoaDonRequests = new List<HoaDonRequest>();
            SelectPhieuChi.GiaoDichNm = args.ItemData.DMChungNm;
            switch (args.ItemData.DMChungUd)
            {
                case "1":
                    ShowScreenGiaoDich1 = true;
                    ShowScreenGiaoDich2 = false;
                    ShowScreenGiaoDich3 = false;
                    ShowScreenGiaoDich4 = false;
                    CheckShowSoLuongHD = false;
                    PhieuChiCt01Requests = new List<PhieuChiCt01Request>();
                    if(jsModule != null){
                        await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt01Ids, GridIds[0]);
                    }
                    break;

                case "2":
                    ShowScreenGiaoDich1 = false;
                    ShowScreenGiaoDich2 = true;
                    ShowScreenGiaoDich3 = false;
                    ShowScreenGiaoDich4 = false;
                    CheckShowSoLuongHD = false;
                    PhieuChiCt02Requests = new List<PhieuChiCt02Request>();
                    if(jsModule != null){
                        await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt02Ids, GridIds[1]);
                    }
                    break;

                case "3":
                    ShowScreenGiaoDich1 = false;
                    ShowScreenGiaoDich2 = false;
                    ShowScreenGiaoDich3 = true;
                    ShowScreenGiaoDich4 = false;
                    CheckShowSoLuongHD = true;
                    PhieuChiCt03Requests = new List<PhieuChiCt03Request>();
                    SelectPhieuChi.KhachHangId = 0;
                    SelectPhieuChi.KhachHangUd = null;
                    SelectPhieuChi.TenKhachHang = null;
                    SelectPhieuChi.MaSoThue = null;
                    SelectPhieuChi.DiaChi = null;
                    SelectPhieuChi.SoDu = null;
                    if(jsModule != null){
                        await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt03Ids, GridIds[2]);
                    }
                    break;

                case "4":
                    ShowScreenGiaoDich1 = false;
                    ShowScreenGiaoDich2 = false;
                    ShowScreenGiaoDich3 = false;
                    ShowScreenGiaoDich4 = true;
                    CheckShowSoLuongHD = true;
                    PhieuChiCt04Requests = new List<PhieuChiCt04Request>();
                    if(jsModule != null){
                        await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt04Ids, GridIds[3]);
                    }
                    break;
                default:
                    break;
            }

        }
    }
    private void OnValueChangeNgayht(ChangedEventArgs<DateTime?> args)
    {
        if (args.Value.HasValue && args.Value >= TuNgay && args.Value < DenNgay)
        {
            SelectPhieuChi.NgayHT = args.Value;
            SelectPhieuChi.NgayLap = args.Value;
        }
        else
        {
            SelectPhieuChi.NgayHT = null;
            TextMessage = $"Ngày hạch toán phải nằm trong thời gian làm việc từ ngày {TuNgay?.ToString("dd/MM/yyyy")} đến {DenNgay?.ToString("dd/MM/yyyy")} !";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }
    public async Task OnFilteringKhachHang(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhachHangUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhachHangNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKH.FilterAsync(KhachHangDtos, query);
    }
    private async void OnValueChangeKhachHang(ChangeEventArgs<int?, KhachHangDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuChi.DiaChi = args.ItemData.DiaChi;
            SelectPhieuChi.MaSoThue = args.ItemData.MaSoThue;
            SelectPhieuChi.TenKhachHang = args.ItemData.KhachHangNm;
            SelectPhieuChi.SoDu = args.ItemData.Sodu;
            SelectPhieuChi.KhachHangUd = args.ItemData.KhachHangUd;
            PhieuNhapDtos = await _phieuNhap.GetListByKhachHangIdAsync(args.ItemData.Id);   
            foreach(var item in PhieuNhapDtos)
            {
                var nt = await _ngoaiTe.GetByIdAsync(item.NgoaiTeId);
                var tk = await _taiKhoan.GetByIdAsync(item.GhiCoTk);
                item.NgoaiTeUd = nt.NgoaiTeUd;
                item.GhiCoTkUd = tk.TaiKhoanUd;                
            }
            if(ShowScreenGiaoDich1)
                this.SfGridPhieuChiCt01?.Refresh();

        }
    }
    public async Task OnFilteringQuyenSo(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "MaCt", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "SoQuyen", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddQS.FilterAsync(QuyenSoDtos, query);
    }
    private void OnValueChangeQuyenSo(ChangeEventArgs<string, QuyenSoDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuChi.SoPhieu = args.ItemData.SoCtHienTai.HasValue ? (args.ItemData.SoCtHienTai.Value + 1).ToString("D6") : "0";
        }
    }
    public async Task OnFilteringTaiKhoan(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTK.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTaiKhoan(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuChi.GhiNoTkNm = args.ItemData.TaiKhoanNm;
        }
    }
    public async Task OnFilteringNgoaiTe(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "NgoaiTeUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "NgoaiTeNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddNT.FilterAsync(NgoaiTeDtos, query);
    }
    private async void OnValueChangeNgoaiTe(ChangeEventArgs<int?, NgoaiTeDto> args)
    {
        if (args.ItemData != null)
        {
            if (args.ItemData.NgoaiTeUd != "VND")
            {
                CheckNgoaiTe = true;
            }
            else
            {
                CheckNgoaiTe = false;
            }
            SelectPhieuChi.NgoaiTeId = args.ItemData.Id;
            var ngoaiTe = await _ngoaiTe.GetByIdAsync(args.ItemData.Id);
            var item = ngoaiTe.TyGiaNgoaiTeDtos?.First();
            SelectPhieuChi.TyGia = item?.TyGia;
            StateHasChanged();//cập nhật giao diện ngay tức thì
            await this.SfGridPhieuChiCtRefresh();
        }
    }

    private async Task SfGridPhieuChiCtRefresh()
    {
        if (ShowScreenGiaoDich1)
        {
            await this.SfGridPhieuChiCt01.Refresh();
        }
        else if (ShowScreenGiaoDich2)
        {
            await this.SfGridPhieuChiCt02.Refresh();
        }
        else if (ShowScreenGiaoDich3)
        {
            await this.SfGridPhieuChiCt03.Refresh();
        }
        else if (ShowScreenGiaoDich4)
        {
            await this.SfGridPhieuChiCt04.Refresh();
        }

    }
    private async Task SfGridPhieuChiCtAddRecordAsync()
    {
        if (ShowScreenGiaoDich1)
        {
            await this.SfGridPhieuChiCt01.AddRecordAsync();
        }
        else if (ShowScreenGiaoDich2)
        {
            await this.SfGridPhieuChiCt02.AddRecordAsync();
        }
        else if (ShowScreenGiaoDich3)
        {
            await this.SfGridPhieuChiCt03.AddRecordAsync();
        }
        else if (ShowScreenGiaoDich4)
        {
            await this.SfGridPhieuChiCt04.AddRecordAsync();
        }

    }
    private async Task SfGridPhieuChiCtDeleteRecordAsync()
    {
        if (ShowScreenGiaoDich1)
        {
            await this.SfGridPhieuChiCt01.DeleteRecordAsync();
        }
        else if (ShowScreenGiaoDich2)
        {
            await this.SfGridPhieuChiCt02.DeleteRecordAsync();
        }
        else if (ShowScreenGiaoDich3)
        {
            await this.SfGridPhieuChiCt03.DeleteRecordAsync();
        }
        else if (ShowScreenGiaoDich4)
        {
            await this.SfGridPhieuChiCt04.DeleteRecordAsync();
        }

    }
    private async Task SfGridPhieuChiCtCloseEditAsync()
    {
        if (ShowScreenGiaoDich1)
        {
            await this.SfGridPhieuChiCt01.CloseEditAsync();
        }
        else if (ShowScreenGiaoDich2)
        {
            await this.SfGridPhieuChiCt02.CloseEditAsync();
        }
        else if (ShowScreenGiaoDich3)
        {
            await this.SfGridPhieuChiCt03.CloseEditAsync();
            await this.SfHoaDonGtgt.FocusAsync();
        }
        else if (ShowScreenGiaoDich4)
        {
            await this.SfGridPhieuChiCt04.CloseEditAsync();
            await this.SfHoaDonGtgt.FocusAsync();
        }

    }

    [JSInvokable("IsEditSfGridCt")]
    public bool IsEditSfGridPhieuChiCt()
    {   
        if(SelectedTab == 0){
            if (ShowScreenGiaoDich1)
            {
                return this.SfGridPhieuChiCt01.IsEdit;
            }
            else if (ShowScreenGiaoDich2)
            {
                return this.SfGridPhieuChiCt02.IsEdit;
            }
            else if (ShowScreenGiaoDich3)
            {
                return this.SfGridPhieuChiCt03.IsEdit;
            }
            else
            {
                return this.SfGridPhieuChiCt04.IsEdit;
            }
        }
        else
        {
            return this.SfGridHoaDonGTGT.IsEdit;
        }
    }
    [JSInvokable("SfGridCtAddRecordAsync")]
    public async Task AddRowCtAsync()
    {
        if (!SelectPhieuChi.KhachHangId.HasValue && !ShowScreenGiaoDich3)
        {
            TextMessage = "Hãy nhập mã khách hàng !";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
            await ddKH.FocusAsync();
        }
        else
        {
            if(SelectedTab == 0)
                await this.SfGridPhieuChiCtAddRecordAsync();
            else
                await this.SfGridHoaDonGTGT.AddRecordAsync();
        }
        StateHasChanged();
    }
    [JSInvokable("SfGridCtDeleteRecordAsync")]
    public async Task DeleteRowCtAsync()
    {
        if (SelectedTab == 0)
            await this.SfGridPhieuChiCtDeleteRecordAsync();
        else
            await this.SfGridHoaDonGTGT.DeleteRecordAsync();
        if(jsModule != null)
            await jsModule.InvokeVoidAsync("turnOffMessageDefault");
    }
    [JSInvokable("SfGridCtCancelRecordAsync")]
    public async Task CancelCtAsync()
    {
        if (SelectedTab == 0){
            await this.SfGridPhieuChiCtCloseEditAsync();
        }
        else
            await this.SfGridHoaDonGTGT.CloseEditAsync();
    }
        [JSInvokable("SfGridCtEndEditAsync")]
    public async Task IsEndEditSfGridCt()
    {
        if(SelectedTab == 0){

            if (ShowScreenGiaoDich1 && this.SfGridPhieuChiCt01.IsEdit)
            {
                await this.SfGridPhieuChiCt01.EndEditAsync();
            }
            else if (ShowScreenGiaoDich2 && this.SfGridPhieuChiCt02.IsEdit)
            {
                await this.SfGridPhieuChiCt02.EndEditAsync();
            }
            else if (ShowScreenGiaoDich3 && this.SfGridPhieuChiCt03.IsEdit)
            {
                await this.SfGridPhieuChiCt03.EndEditAsync();
            }
            else if (ShowScreenGiaoDich4 && this.SfGridPhieuChiCt04.IsEdit)
            {
                await this.SfGridPhieuChiCt04.EndEditAsync();
            }
        }
        else
        {
            if( this.SfGridHoaDonGTGT.IsEdit)
            {
                await this.SfGridHoaDonGTGT.EndEditAsync();
            }
        }
    }
    [JSInvokable("SfGridCtSelectRowAsync")]
    public async Task IsSelectRowSfGridCt()
    {
        if(SelectedTab == 0){

            if (ShowScreenGiaoDich1 && PhieuChiCt01Requests.Count > 0)
            {
                await this.SfGridPhieuChiCt01.SelectRowAsync(0);
            }
            else if (ShowScreenGiaoDich2 && PhieuChiCt02Requests.Count > 0)
            {
                await this.SfGridPhieuChiCt02.SelectRowAsync(0);
            }
            else if (ShowScreenGiaoDich3 && PhieuChiCt03Requests.Count > 0)
            {
                await this.SfGridPhieuChiCt03.SelectRowAsync(0);
            }
            else if (ShowScreenGiaoDich4 && PhieuChiCt04Requests.Count > 0)
            {
                await this.SfGridPhieuChiCt04.SelectRowAsync(0);
            }
        }
        else
        {
            if( HoaDonRequests.Count > 0)
            {
                await this.SfGridHoaDonGTGT.SelectRowAsync(0);
            }
        }
    }
    //Màn hình chi tiết(Giao dịch 1)
    private void ActionBeginPhieuChiCt01(ActionEventArgs<PhieuChiCt01Request> args)
    {
        this.SfGridPhieuChiCt01.PreventRender(false);
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = PhieuChiCt01Requests?.Any() == true ? PhieuChiCt01Requests.Max(x => x.Stt) : 0;
            args.Data.Stt = maxId + 1; // Tăng giá trị Id lên 1
            TempPhieuChiCt01 = new PhieuChiCt01Request()
                {
                    SoHd = null,
                    NgayHd = null,
                    NgoaiTeId = null,
                    NgoaiTeUd = null,
                    TyGia = null,
                    GhiNoTk = null,
                    GhiNoTkUd = null, 
                    GhiNoTkNm = null,
                    TienTrenHd = 0,
                    DaTt = 0,
                    ConPhaiTt = 0,
                    ThanhToan = 0,
                    ThanhToanVND = 0,
                    DienGiai = null,
                };
        }
    }
    public void ActionCompletedPhieuChiCt01(ActionEventArgs<PhieuChiCt01Request> args)
    {
        if (PhieuChiCt01Requests.Count > 0)
        {
            decimal? tienVND = 0; decimal? tienThueVND = 0; decimal? tongTienVND = 0;
            decimal? tien = 0; decimal? tienThue = 0; decimal? tongTien = 0;
            CheckEnabledMaGiaoDich = false;
            foreach (var item in PhieuChiCt01Requests)
            {

                tienVND += item.PsNoVND;
                tienThueVND += item.ThueVND;
                tongTienVND += item.ThanhToanVND;
                if (item.PsNo == null)
                {
                    item.PsNo = 0;
                    item.Thue = 0;
                    item.ThanhToan = 0;
                }
                tien += item.PsNo;
                tienThue += item.Thue;
                tongTien += item.ThanhToan;
            }
            SelectPhieuChi.TienVND = tongTienVND;
            SelectPhieuChi.TienThueVND = 0;
            SelectPhieuChi.TongTienVND = tongTienVND;
            SelectPhieuChi.Tien = tongTien;
            SelectPhieuChi.TienThue = 0;
            SelectPhieuChi.TongTien = tongTien;
        }
        else
        {
            SelectPhieuChi.TienVND = 0;
            SelectPhieuChi.TienThueVND = 0;
            SelectPhieuChi.TongTienVND = 0;
            SelectPhieuChi.Tien = 0;
            SelectPhieuChi.TienThue = 0;
            SelectPhieuChi.TongTien = 0;
            CheckEnabledMaGiaoDich = true;
        }
    }
    public void RowUpdatingPhieuChiCt01(RowUpdatingEventArgs<PhieuChiCt01Request> args)
    {
        args.Data.SoHd = TempPhieuChiCt01.SoHd;
        args.Data.NgayHd = TempPhieuChiCt01.NgayHd;
        args.Data.NgoaiTeId = TempPhieuChiCt01.NgoaiTeId;
        args.Data.NgoaiTeUd = TempPhieuChiCt01.NgoaiTeUd;
        args.Data.TyGia = TempPhieuChiCt01.TyGia;
        args.Data.GhiNoTk = TempPhieuChiCt01.GhiNoTk;
        args.Data.GhiNoTkUd = TempPhieuChiCt01.GhiNoTkUd;
        args.Data.GhiNoTkNm = TempPhieuChiCt01.GhiNoTkNm;
        args.Data.TienTrenHd = TempPhieuChiCt01.TienTrenHd;
        args.Data.DaTt = TempPhieuChiCt01.DaTt;
        args.Data.ConPhaiTt = TempPhieuChiCt01.ConPhaiTt;
        args.Data.ThanhToan = TempPhieuChiCt01.ThanhToan;
        args.Data.ThanhToanVND = TempPhieuChiCt01.ThanhToanVND;
        args.Data.DienGiai = TempPhieuChiCt01.DienGiai;
    }
    public void RecordDoubleClickPhieuChiCt01(RecordDoubleClickEventArgs<PhieuChiCt01Request> args)
    {
        this.SfGridPhieuChiCt01.PreventRender(false);
        TempPhieuChiCt01 = args.RowData;
    }
    public async Task OnFilteringSoHdCt01(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "SoHd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "NgayHd", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddSoHdCt01.FilterAsync(PhieuNhapDtos, query);
    }
    private void OnValueChangeSoHdCt01(ChangeEventArgs<string, PhieuNhapDto> args)
    {
        this.SfGridPhieuChiCt01.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt01.SoHd = args.ItemData.SoHd;
            TempPhieuChiCt01.NgayHd = args.ItemData.NgayLap;
            TempPhieuChiCt01.NgoaiTeId = args.ItemData.NgoaiTeId;
            TempPhieuChiCt01.NgoaiTeUd = args.ItemData.NgoaiTeUd;
            TempPhieuChiCt01.TyGia = args.ItemData.TiGia;
            TempPhieuChiCt01.GhiNoTk = args.ItemData.GhiCoTk;
            TempPhieuChiCt01.GhiNoTkUd = args.ItemData.GhiCoTkUd;
            TempPhieuChiCt01.GhiNoTkNm = args.ItemData.GhiCoTkNm;
            TempPhieuChiCt01.TienTrenHd = args.ItemData.TienPhaiTtVND;
            TempPhieuChiCt01.DaTt = args.ItemData.TienTt;
            TempPhieuChiCt01.ConPhaiTt = args.ItemData.ConPhaiTt;
        }
    }
    private void OnValueChangeThanhToanCt01(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt01.PreventRender(false);
        TempPhieuChiCt01.ThanhToan = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if (TempPhieuChiCt01.ThanhToan != 0)
            TempPhieuChiCt01.ThanhToanVND = TempPhieuChiCt01.ThanhToan * SelectPhieuChi.TyGia;
    }
    private void OnValueChangeThanhToanVNDCt01(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt01.PreventRender(false);
        TempPhieuChiCt01.ThanhToanVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
    }
    private void OnValueChangeDienGiaiCt01(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt01.PreventRender(false);
        TempPhieuChiCt01.DienGiai = args.Value?.ToString();
    }
    //Màn hình chi tiết(Giao dịch 1) end
    //Màn hình chi tiết(Giao dịch 2)
    private void ActionBeginPhieuChiCt02(ActionEventArgs<PhieuChiCt02Request> args)
    {
        this.SfGridPhieuChiCt02.PreventRender(false);
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = PhieuChiCt02Requests?.Any() == true ? PhieuChiCt02Requests.Max(x => x.Stt) : 0;
            args.Data.Stt = maxId + 1; // Tăng giá trị Id lên 1
            TempPhieuChiCt02 = new PhieuChiCt02Request()
            {
                PsNo = 0,
                PsNoVND = 0
            };
        }
    }

    public void ActionCompletedPhieuChiCt02(ActionEventArgs<PhieuChiCt02Request> args)
    {
        if (PhieuChiCt02Requests.Count > 0)
        {
            CheckEnabledMaGiaoDich = false;
            decimal? tienVND = PhieuChiCt02Requests.Sum(x => x.PsNoVND);
            decimal? tien = PhieuChiCt02Requests.Sum(x=>x.PsNo);
            SelectPhieuChi.TienVND = tienVND;
            SelectPhieuChi.TienThueVND = 0;
            SelectPhieuChi.TongTienVND = SelectPhieuChi.TienVND + SelectPhieuChi.TienThueVND;
            SelectPhieuChi.Tien = tien;
            SelectPhieuChi.TienThue = 0;
            SelectPhieuChi.TongTien = SelectPhieuChi.Tien + SelectPhieuChi.TienThue;
        }
        else
        {
            SelectPhieuChi.TienVND = 0;
            SelectPhieuChi.TienThueVND = 0;
            SelectPhieuChi.TongTienVND = 0;
            SelectPhieuChi.Tien = 0;
            SelectPhieuChi.TienThue = 0;
            SelectPhieuChi.TongTien = 0;
            CheckEnabledMaGiaoDich = true;
        }
    }
    public void RowUpdatingPhieuChiCt02(RowUpdatingEventArgs<PhieuChiCt02Request> args)
    {
        args.Data.GhiNoTk = TempPhieuChiCt02.GhiNoTk;
        args.Data.GhiNoTkUd = TempPhieuChiCt02.GhiNoTkUd;
        args.Data.GhiNoTkNm = TempPhieuChiCt02.GhiNoTkNm;
        args.Data.PsNo = TempPhieuChiCt02.PsNo;
        args.Data.PsNoVND = TempPhieuChiCt02.PsNoVND;
        args.Data.DienGiai = TempPhieuChiCt02.DienGiai;
    }
    public void RecordDoubleClickPhieuChiCt02(RecordDoubleClickEventArgs<PhieuChiCt02Request> args)
    {
        this.SfGridPhieuChiCt02.PreventRender(false);
        TempPhieuChiCt02 = args.RowData;
    }
    public async Task OnFilteringTaiKhoanCt02(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKCt02.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTaiKhoanCt02(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        this.SfGridPhieuChiCt02.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt02.GhiNoTk = args.ItemData.Id;
            TempPhieuChiCt02.GhiNoTkUd = args.ItemData.TaiKhoanUd;
            TempPhieuChiCt02.GhiNoTkNm = args.ItemData.TaiKhoanNm;
        }
    }
    private void OnValueChangePsNoCt02(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt02.PreventRender(false);
        TempPhieuChiCt02.PsNo = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if (TempPhieuChiCt02.PsNo != 0)
            TempPhieuChiCt02.PsNoVND = TempPhieuChiCt02.PsNo * SelectPhieuChi.TyGia;
    }
    private void OnValueChangePsNoVNDCt02(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt02.PreventRender(false);
        TempPhieuChiCt02.PsNoVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
    }
    private void OnValueChangeDienGiaiCt02(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt02.PreventRender(false);
        TempPhieuChiCt02.DienGiai = args.Value?.ToString();
    }
    //Màn hình chi tiết(Giao dịch 2) end

    //Màn hình chi tiết(Giao dịch 3)
    private void ActionBeginPhieuChiCt03(ActionEventArgs<PhieuChiCt03Request> args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = PhieuChiCt03Requests?.Any() == true ? PhieuChiCt03Requests.Max(x => x.Stt) : 0;
            args.Data.Stt = maxId + 1; // Tăng giá trị Id lên 1
            TempPhieuChiCt03 = new PhieuChiCt03Request()
                {
                    PsNo = 0,
                    PsNoVND = 0,
                    ThueSuat = 0,
                    Thue = 0,
                    ThueVND = 0,
                    ThanhToan = 0,
                    ThanhToanVND = 0,
                    ThanhToanQd = 0
                };
        }
    }

    public void ActionCompletedPhieuChiCt03(ActionEventArgs<PhieuChiCt03Request> args)
    {
        if (PhieuChiCt03Requests.Count > 0)
        {
            CheckEnabledMaGiaoDich = false;
            decimal? tienVND = PhieuChiCt03Requests.Sum(x => x.PsNoVND);
            decimal? tien = PhieuChiCt03Requests.Sum(x=>x.PsNo);
            decimal? thueVND = PhieuChiCt03Requests.Sum(x => x.ThueVND);
            decimal? thue = PhieuChiCt03Requests.Sum(x=>x.Thue);
            SelectPhieuChi.TienVND = tienVND;
            SelectPhieuChi.TienThueVND = thueVND;          
            SelectPhieuChi.Tien = tien;
            SelectPhieuChi.TienThue = thue;

        }
        else
        {
            SelectPhieuChi.TienVND = 0;
            SelectPhieuChi.TienThueVND = 0;
            SelectPhieuChi.Tien = 0;
            SelectPhieuChi.TienThue = 0;
            CheckEnabledMaGiaoDich = true;
        }
        SelectPhieuChi.TongTien = SelectPhieuChi.Tien + SelectPhieuChi.TienThue;
        SelectPhieuChi.TongTienVND = SelectPhieuChi.TienVND + SelectPhieuChi.TienThueVND;
    }
    public void RowCreatingPhieuChiCt03(RowCreatingEventArgs<PhieuChiCt03Request> args)
    {
        args.Data.LoaiThue = TempPhieuChiCt03.LoaiThue ?? ThamSoHeThong.LoaiThue;
        args.Data.LoaiThueUd = TempPhieuChiCt03.LoaiThueUd ?? ThamSoHeThong.LoaiThueUd;
    }
    public void RowUpdatingPhieuChiCt03(RowUpdatingEventArgs<PhieuChiCt03Request> args)
    {
        args.Data.GhiNoTk = TempPhieuChiCt03.GhiNoTk;
        args.Data.GhiNoTkUd = TempPhieuChiCt03.GhiNoTkUd;
        args.Data.GhiNoTkNm = TempPhieuChiCt03.GhiNoTkNm;
        args.Data.KhachHangId = TempPhieuChiCt03.KhachHangId;
        args.Data.KhachHangUd = TempPhieuChiCt03.KhachHangUd;
        args.Data.KhachHangNm = TempPhieuChiCt03.KhachHangNm;
        args.Data.DiaChi = TempPhieuChiCt03.DiaChi;
        args.Data.MaSoThue = TempPhieuChiCt03.MaSoThue;
        args.Data.PsNo = TempPhieuChiCt03.PsNo;
        args.Data.PsNoVND = TempPhieuChiCt03.PsNoVND;
        args.Data.DienGiai = TempPhieuChiCt03.DienGiai;
        args.Data.MaThue = TempPhieuChiCt03.MaThue;
        args.Data.MaThueUd = TempPhieuChiCt03.MaThueUd;
        args.Data.ThueSuat = TempPhieuChiCt03.ThueSuat;
        args.Data.Thue = TempPhieuChiCt03.Thue;
        args.Data.ThueVND = TempPhieuChiCt03.ThueVND;
        args.Data.ThanhToan = TempPhieuChiCt03.ThanhToan;
        args.Data.ThanhToanVND = TempPhieuChiCt03.ThanhToanVND;
        args.Data.SoHd = TempPhieuChiCt03.SoHd;
        args.Data.NgayHd = TempPhieuChiCt03.NgayHd;
        args.Data.SoSeri = TempPhieuChiCt03.SoSeri;
    }
    public void RecordDoubleClickPhieuChiCt03(RecordDoubleClickEventArgs<PhieuChiCt03Request> args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03 = args.RowData;
    }
    public async Task OnFilteringTaiKhoanCt03(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKCt03.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTaiKhoanCt03(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt03.GhiNoTk = args.ItemData.Id;
            TempPhieuChiCt03.GhiNoTkUd = args.ItemData.TaiKhoanUd;
            TempPhieuChiCt03.GhiNoTkNm = args.ItemData.TaiKhoanNm;
        }
    }
    public async Task OnFilteringKhachHangCt03(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhachHangUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhachHangNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKHCt03.FilterAsync(KhachHangDtos, query);
    }
    private void OnValueChangeKhachHangCt03(ChangeEventArgs<int?, KhachHangDto> args)
    {
        if (args.ItemData != null)
        {
            TempPhieuChiCt03.KhachHangId = args.ItemData.Id;
            TempPhieuChiCt03.KhachHangUd = args.ItemData.KhachHangUd;
            TempPhieuChiCt03.KhachHangNm = args.ItemData.KhachHangNm;
            TempPhieuChiCt03.DiaChi = args.ItemData.DiaChi;
            TempPhieuChiCt03.MaSoThue = args.ItemData.MaSoThue;
        }
    }
    private void OnValueChangePsNoCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.PsNo = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if (TempPhieuChiCt03.PsNo != 0)
            TempPhieuChiCt03.PsNoVND = TempPhieuChiCt03.PsNo * SelectPhieuChi.TyGia;
        if(TempPhieuChiCt03.Thue == 0)
            TempPhieuChiCt03.Thue = TempPhieuChiCt03.PsNo * TempPhieuChiCt03.ThueSuat / 100;
        if(TempPhieuChiCt03.ThueVND == 0)
            TempPhieuChiCt03.ThueVND = TempPhieuChiCt03.PsNoVND * TempPhieuChiCt03.ThueSuat / 100;
        TempPhieuChiCt03.ThanhToan = TempPhieuChiCt03.PsNo + TempPhieuChiCt03.Thue;
        TempPhieuChiCt03.ThanhToanVND = TempPhieuChiCt03.PsNoVND + TempPhieuChiCt03.ThueVND;
    }
    private void OnValueChangePsNoVNDCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.PsNoVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempPhieuChiCt03.Thue == 0)
            TempPhieuChiCt03.Thue = TempPhieuChiCt03.PsNo * TempPhieuChiCt03.ThueSuat / 100;
        if(TempPhieuChiCt03.ThueVND == 0)
            TempPhieuChiCt03.ThueVND = TempPhieuChiCt03.PsNoVND * TempPhieuChiCt03.ThueSuat / 100;
        TempPhieuChiCt03.ThanhToan = TempPhieuChiCt03.PsNo + TempPhieuChiCt03.Thue;
        TempPhieuChiCt03.ThanhToanVND = TempPhieuChiCt03.PsNoVND + TempPhieuChiCt03.ThueVND;
    }
    private void OnValueChangeDienGiaiCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.DienGiai = args.Value?.ToString();
    }
    public async Task OnFilteringLoaiThueCt03(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "DMChungUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "DMChungNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddLTCt03.FilterAsync(DMChungDtos, query);
    }
    private void OnValueChangeLoaiThueCt03(ChangeEventArgs<int?, DmChungDto> args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt03.LoaiThue = args.ItemData.Id;
            TempPhieuChiCt03.LoaiThueUd = args.ItemData.DMChungUd;
        }
    }
    public async Task OnFilteringThueSuatCt03(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ThueSuatUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ThueSuatNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTSCt03.FilterAsync(ThueSuatDtos, query);
    }
    private void OnValueChangeThueSuatCt03(ChangeEventArgs<int?, ThueSuatDto> args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt03.MaThue = args.ItemData.Id;
            TempPhieuChiCt03.MaThueUd = args.ItemData.ThueSuatUd;
            TempPhieuChiCt03.ThueSuat = args.ItemData.GiaTri.HasValue ? args.ItemData.GiaTri : 0;
        }
        else{
            TempPhieuChiCt03.MaThue = null;
            TempPhieuChiCt03.MaThueUd = null;
            TempPhieuChiCt03.ThueSuat = 0;
        }
        if (TempPhieuChiCt03.Thue == 0)
            TempPhieuChiCt03.Thue = TempPhieuChiCt03.PsNo * TempPhieuChiCt03.ThueSuat / 100;
        if (TempPhieuChiCt03.ThueVND == 0)
            TempPhieuChiCt03.ThueVND = TempPhieuChiCt03.PsNoVND * TempPhieuChiCt03.ThueSuat / 100;
        TempPhieuChiCt03.ThanhToan = TempPhieuChiCt03.PsNo + TempPhieuChiCt03.Thue;
        TempPhieuChiCt03.ThanhToanVND = TempPhieuChiCt03.PsNoVND + TempPhieuChiCt03.ThueVND;
    } 
    private void OnValueChangeThueCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.Thue = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempPhieuChiCt03.Thue == 0)
            TempPhieuChiCt03.Thue = TempPhieuChiCt03.PsNo * TempPhieuChiCt03.ThueSuat / 100;
        TempPhieuChiCt03.ThanhToan = TempPhieuChiCt03.PsNo + TempPhieuChiCt03.Thue;
    }
    private void OnValueChangeThueVNDCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.ThueVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempPhieuChiCt03.ThueVND == 0)
            TempPhieuChiCt03.ThueVND = TempPhieuChiCt03.PsNoVND * TempPhieuChiCt03.ThueSuat / 100;
        TempPhieuChiCt03.ThanhToanVND = TempPhieuChiCt03.PsNoVND + TempPhieuChiCt03.ThueVND;
    }
    private void OnValueChangeSoHdCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.SoHd = args.Value?.ToString();
    }
    private void OnValueChangeNgayHdCt03(ChangedEventArgs<DateTime?> args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        if (DateTime.TryParse(args.Value?.ToString(), out DateTime parsedDate))
        {
            TempPhieuChiCt03.NgayHd = parsedDate;
        }
        else
        {
            TempPhieuChiCt03.NgayHd = null;
        }
    }
    private void OnValueChangeKyHieuHdCt03(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt03.PreventRender(false);
        TempPhieuChiCt03.SoSeri = args.Value?.ToString();
    }
    //Màn hình chi tiết(Giao dịch 3) end

    //Màn hình chi tiết(Giao dịch 4)
    private void ActionBeginPhieuChiCt04(ActionEventArgs<PhieuChiCt04Request> args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = PhieuChiCt04Requests?.Any() == true ? PhieuChiCt04Requests.Max(x => x.Stt) : 0;
            args.Data.Stt = maxId + 1; // Tăng giá trị Id lên 1
            TempPhieuChiCt04 = new PhieuChiCt04Request()
            {
                PsNo = 0,
                PsNoVND = 0,
                ThueSuat = 0,
                Thue = 0,
                ThueVND = 0,
                ThanhToan = 0,
                ThanhToanVND = 0,
                ThanhToanQd = 0
            };
        }
    }
    public void ActionCompletedPhieuChiCt04(ActionEventArgs<PhieuChiCt04Request> args)
    {
        if (PhieuChiCt04Requests.Count > 0)
        {
            CheckEnabledMaGiaoDich = false;
            decimal? tienVND = PhieuChiCt04Requests.Sum(x => x.PsNoVND);
            decimal? tien = PhieuChiCt04Requests.Sum(x=>x.PsNo);
            decimal? thueVND = PhieuChiCt04Requests.Sum(x => x.ThueVND);
            decimal? thue = PhieuChiCt04Requests.Sum(x=>x.Thue);
            SelectPhieuChi.TienVND = tienVND;
            SelectPhieuChi.TienThueVND = thueVND;          
            SelectPhieuChi.Tien = tien;
            SelectPhieuChi.TienThue = thue;
            this.BindValueHoaDonGTGT();
        }
        else
        {
            SelectPhieuChi.TienVND = 0;
            SelectPhieuChi.TienThueVND = 0;
            SelectPhieuChi.Tien = 0;
            SelectPhieuChi.TienThue = 0;
            CheckEnabledMaGiaoDich = true;
        }
        SelectPhieuChi.TongTien = SelectPhieuChi.Tien + SelectPhieuChi.TienThue;
        SelectPhieuChi.TongTienVND = SelectPhieuChi.TienVND + SelectPhieuChi.TienThueVND;
    }
    public void RowCreatingPhieuChiCt04(RowCreatingEventArgs<PhieuChiCt04Request> args)
    {
        args.Data.LoaiThue = TempPhieuChiCt04.LoaiThue ?? ThamSoHeThong.LoaiThue;
        args.Data.LoaiThueUd = TempPhieuChiCt04.LoaiThueUd ?? ThamSoHeThong.LoaiThueUd;
    }
    public void RowUpdatingPhieuChiCt04(RowUpdatingEventArgs<PhieuChiCt04Request> args)
    {
        args.Data.GhiNoTk = TempPhieuChiCt04.GhiNoTk;
        args.Data.GhiNoTkUd = TempPhieuChiCt04.GhiNoTkUd;
        args.Data.GhiNoTkNm = TempPhieuChiCt04.GhiNoTkNm;
        args.Data.PsNo = TempPhieuChiCt04.PsNo;
        args.Data.PsNoVND = TempPhieuChiCt04.PsNoVND;
        args.Data.DienGiai = TempPhieuChiCt04.DienGiai;
        args.Data.MaThue = TempPhieuChiCt04.MaThue;
        args.Data.MaThueUd = TempPhieuChiCt04.MaThueUd;
        args.Data.ThueSuat = TempPhieuChiCt04.ThueSuat;
        args.Data.Thue = TempPhieuChiCt04.Thue;
        args.Data.ThueVND = TempPhieuChiCt04.ThueVND;
        args.Data.ThanhToan = TempPhieuChiCt04.ThanhToan;
        args.Data.ThanhToanVND = TempPhieuChiCt04.ThanhToanVND;
        args.Data.SoHd = TempPhieuChiCt04.SoHd;
        args.Data.NgayHd = TempPhieuChiCt04.NgayHd;
        args.Data.SoSeri = TempPhieuChiCt04.SoSeri;
    }
    public void RecordDoubleClickPhieuChiCt04(RecordDoubleClickEventArgs<PhieuChiCt04Request> args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04 = args.RowData;
    }
    public async Task OnFilteringTaiKhoanCt04(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKCt04.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTaiKhoanCt04(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt04.GhiNoTk = args.ItemData.Id;
            TempPhieuChiCt04.GhiNoTkUd = args.ItemData.TaiKhoanUd;
            TempPhieuChiCt04.GhiNoTkNm = args.ItemData.TaiKhoanNm;
        }
    }
    private void OnValueChangePsNoCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.PsNo = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if (TempPhieuChiCt04.PsNo != 0)
            TempPhieuChiCt04.PsNoVND = TempPhieuChiCt04.PsNo * SelectPhieuChi.TyGia;
        if(TempPhieuChiCt04.Thue == 0)
            TempPhieuChiCt04.Thue = TempPhieuChiCt04.PsNo * TempPhieuChiCt04.ThueSuat / 100;
        if(TempPhieuChiCt04.ThueVND == 0)
            TempPhieuChiCt04.ThueVND = TempPhieuChiCt04.PsNoVND * TempPhieuChiCt04.ThueSuat / 100;
        TempPhieuChiCt04.ThanhToan = TempPhieuChiCt04.PsNo + TempPhieuChiCt04.Thue;
        TempPhieuChiCt04.ThanhToanVND = TempPhieuChiCt04.PsNoVND + TempPhieuChiCt04.ThueVND;
    }
    private void OnValueChangePsNoVNDCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.PsNoVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempPhieuChiCt04.Thue == 0)
            TempPhieuChiCt04.Thue = TempPhieuChiCt04.PsNo * TempPhieuChiCt04.ThueSuat / 100;
        if(TempPhieuChiCt04.ThueVND == 0)
            TempPhieuChiCt04.ThueVND = TempPhieuChiCt04.PsNoVND * TempPhieuChiCt04.ThueSuat / 100;
        TempPhieuChiCt04.ThanhToan = TempPhieuChiCt04.PsNo + TempPhieuChiCt04.Thue;
        TempPhieuChiCt04.ThanhToanVND = TempPhieuChiCt04.PsNoVND + TempPhieuChiCt04.ThueVND;
    }
    private void OnValueChangeDienGiaiCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.DienGiai = args.Value?.ToString();
    }
    public async Task OnFilteringLoaiThueCt04(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "DMChungUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "DMChungNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddLTCt04.FilterAsync(DMChungDtos, query);
    }
    private void OnValueChangeLoaiThueCt04(ChangeEventArgs<int?, DmChungDto> args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt04.LoaiThue = args.ItemData.Id;
            TempPhieuChiCt04.LoaiThueUd = args.ItemData.DMChungUd;
        }
    }
    public async Task OnFilteringThueSuatCt04(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ThueSuatUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ThueSuatNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTSCt04.FilterAsync(ThueSuatDtos, query);
    }
    private void OnValueChangeThueSuatCt04(ChangeEventArgs<int?, ThueSuatDto> args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        if (args.ItemData != null)
        {
            TempPhieuChiCt04.MaThue = args.ItemData.Id;
            TempPhieuChiCt04.MaThueUd = args.ItemData.ThueSuatUd;
            TempPhieuChiCt04.ThueSuat = args.ItemData.GiaTri.HasValue ? args.ItemData.GiaTri : 0;
        }
        else{
            TempPhieuChiCt04.MaThue = null;
            TempPhieuChiCt04.MaThueUd = null;
            TempPhieuChiCt04.ThueSuat = 0;
        }
        if (TempPhieuChiCt04.Thue == 0)
            TempPhieuChiCt04.Thue = TempPhieuChiCt04.PsNo * TempPhieuChiCt04.ThueSuat / 100;
        if (TempPhieuChiCt04.ThueVND == 0)
            TempPhieuChiCt04.ThueVND = TempPhieuChiCt04.PsNoVND * TempPhieuChiCt04.ThueSuat / 100;
        TempPhieuChiCt04.ThanhToan = TempPhieuChiCt04.PsNo + TempPhieuChiCt04.Thue;
        TempPhieuChiCt04.ThanhToanVND = TempPhieuChiCt04.PsNoVND + TempPhieuChiCt04.ThueVND;
    }
    private void OnValueChangeThueCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.Thue = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempPhieuChiCt04.Thue == 0)
            TempPhieuChiCt04.Thue = TempPhieuChiCt04.PsNo * TempPhieuChiCt04.ThueSuat / 100;
        TempPhieuChiCt04.ThanhToan = TempPhieuChiCt04.PsNo + TempPhieuChiCt04.Thue;
    }
    private void OnValueChangeThueVNDCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.ThueVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempPhieuChiCt04.ThueVND == 0)
            TempPhieuChiCt04.ThueVND = TempPhieuChiCt04.PsNoVND * TempPhieuChiCt04.ThueSuat / 100;
        TempPhieuChiCt04.ThanhToanVND = TempPhieuChiCt04.PsNoVND + TempPhieuChiCt04.ThueVND;
    }
    private void OnValueChangeSoHdCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.SoHd = args.Value?.ToString();
    }
    private void OnValueChangeNgayHdCt04(ChangedEventArgs<DateTime?> args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        if (DateTime.TryParse(args.Value?.ToString(), out DateTime parsedDate))
        {
            TempPhieuChiCt04.NgayHd = parsedDate;
        }
        else
        {
            TempPhieuChiCt04.NgayHd = null;
        }
    }
    private void OnValueChangeKyHieuHdCt04(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridPhieuChiCt04.PreventRender(false);
        TempPhieuChiCt04.SoSeri = args.Value?.ToString();
    }

    //Màn hình chi tiết(Giao dịch 4) end
    private async Task OnSelectTabAsync()
    {
        if(SelectedTab == 1 )
        {
            if (jsModule !=null)
                await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputHoaDonGtgtIds, GridIds[4]);
            if(!IsDisabled){
                if ((ShowScreenGiaoDich3 && PhieuChiCt03Requests.Count > 0) || (ShowScreenGiaoDich4 && PhieuChiCt04Requests.Count > 0))
                {
                    if(HoaDonRequests.Count == 0)
                        this.BindValueHoaDonGTGT();
                }
                else
                {
                    SelectedTab = 0;
                    TextMessage = $"Hãy thêm chi tiết hạch toán!";
                    CheckMessage = false;
                    IsDeleteMessage = false;
                    IsConfirmMessage = false;
                    ShowModalMessage = true;
                }
                await this.SfGridHoaDonGTGT.Refresh();
            }
        }
        else if (SelectedTab == 0)
        {
            if (jsModule != null)
            {
                if (ShowScreenGiaoDich1)
                {
                    await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt01Ids, GridIds[0]);
                }
                else if (ShowScreenGiaoDich2)
                {
                    await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt02Ids, GridIds[1]);
                }
                else if (ShowScreenGiaoDich3)
                {
                    await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt03Ids, GridIds[2]);
                }
                else
                {
                    await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputCt04Ids, GridIds[3]);
                }
            }
        }
    }
    //Màn hình hóa đơn chi tiết
    private void ActionBeginHoaDonGTGT(ActionEventArgs<HoaDonRequest> arg)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        if (arg.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = HoaDonRequests?.Any() == true ? HoaDonRequests.Max(x => x.Stt) : 0;
            arg.Data.Stt = maxId + 1; // Tăng giá trị Id lên 1
            TempHoaDonCt = new HoaDonRequest()
            {
                KyHieuMauHD = TempHoaDonCt.KyHieuMauHD ?? ThamSoHeThong.KyHieuMauHD,
                KhachHangId = TempHoaDonCt.KhachHangId,
                KhachHangUd = TempHoaDonCt.KhachHangUd,
                KhachHangNm = TempHoaDonCt.KhachHangNm,
                MaSoThue = TempHoaDonCt.MaSoThue,
                DiaChi = TempHoaDonCt.DiaChi,
                Tien = 0,
                TienVND = 0,
                ThueSuat = 0,
                Thue = 0,
                ThueVND = 0,
                TkThue = TempHoaDonCt.TkThue,
                TkThueUd = TempHoaDonCt.TkThueUd,
            };
        }
    }
    public void ActionCompletedHoaDonGTGT(ActionEventArgs<HoaDonRequest> args)
    {
        if (ShowScreenGiaoDich3 || ShowScreenGiaoDich4)
        {
            SelectPhieuChi.HoaDonGTGT = HoaDonRequests.Count;
            var tienThue = HoaDonRequests.Sum(x => x.Thue);
            var tienThueVND = HoaDonRequests.Sum(x => x.ThueVND);
            SelectPhieuChi.TienThue = tienThue;
            SelectPhieuChi.TienThueVND = tienThueVND;
        }
        else
        {
            SelectPhieuChi.HoaDonGTGT = 0;
            SelectPhieuChi.TienThue = 0;
            SelectPhieuChi.TienThueVND = 0;
        }
        SelectPhieuChi.TongTien = SelectPhieuChi.Tien + SelectPhieuChi.TienThue;
        SelectPhieuChi.TongTienVND = SelectPhieuChi.TienVND + SelectPhieuChi.TienThueVND;
    }
    public void RowCreatingHoaDonGTGT(RowCreatingEventArgs<HoaDonRequest> args)
    {
        args.Data.LoaiThue =  TempHoaDonCt.LoaiThue ?? ThamSoHeThong.LoaiThue;
        args.Data.LoaiThueUd = TempHoaDonCt.LoaiThueUd ?? ThamSoHeThong.LoaiThueUd;
    }
    public void RowUpdatingHoaDonGTGT(RowUpdatingEventArgs<HoaDonRequest> args)
    {
        args.Data.SoCt0 = TempHoaDonCt.SoCt0;
        args.Data.NgayCt0 = TempHoaDonCt.NgayCt0;
        args.Data.SoSeri0 = TempHoaDonCt.SoSeri0;
        args.Data.KyHieuMauHD = TempHoaDonCt.KyHieuMauHD;
        args.Data.KhachHangId = TempHoaDonCt.KhachHangId;
        args.Data.KhachHangUd = TempHoaDonCt.KhachHangUd;
        args.Data.KhachHangNm = TempHoaDonCt.KhachHangNm;
        args.Data.DiaChi = TempHoaDonCt.DiaChi;
        args.Data.MaSoThue = TempHoaDonCt.MaSoThue;
        args.Data.VatTu = TempHoaDonCt.VatTu;
        args.Data.Tien = TempHoaDonCt.Tien;
        args.Data.TienVND = TempHoaDonCt.TienVND;
        args.Data.MaThue = TempHoaDonCt.MaThue;
        args.Data.MaThueUd = TempHoaDonCt.MaThueUd;
        args.Data.ThueSuat = TempHoaDonCt.ThueSuat;
        args.Data.Thue = TempHoaDonCt.Thue;
        args.Data.ThueVND = TempHoaDonCt.ThueVND;
        args.Data.TkThue = TempHoaDonCt.TkThue;
        args.Data.TkThueUd = TempHoaDonCt.TkThueUd;
        args.Data.GhiChu = TempHoaDonCt.GhiChu;

    }
    public void RecordDoubleClickHoaDonGTGT(RecordDoubleClickEventArgs<HoaDonRequest> args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt = args.RowData;
    }
    public async Task OnFilteringLoaiThueGTGT(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "DMChungUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "DMChungNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddLTGtgt.FilterAsync(DMChungDtos, query);
    }
    private void OnValueChangeLoaiThueGTGT(ChangeEventArgs<int?, DmChungDto> args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        if (args.ItemData != null)
        {
            TempHoaDonCt.LoaiThue = args.ItemData.Id;
            TempHoaDonCt.LoaiThueUd = args.ItemData.DMChungUd;
        }
    }
    private void OnValueChangeSoHdGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.SoCt0 = args.Value?.ToString();
    }
    private void OnValueChangeNgayHdGTGT(ChangedEventArgs<DateTime?> args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        if (DateTime.TryParse(args.Value?.ToString(), out DateTime parsedDate))
        {
            TempHoaDonCt.NgayCt0 = parsedDate;
        }
        else
        {
            TempHoaDonCt.NgayCt0 = null;
        }
    }
    private void OnValueChangeKyHieuHdGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.SoSeri0 = args.Value?.ToString();
    }
    private void OnValueChangeKyHieuMauHdGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.KyHieuMauHD = args.Value?.ToString();
    }
    public async Task OnFilteringKhachHangGTGT(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhachHangUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhachHangNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKHGtgt.FilterAsync(KhachHangDtos, query);
    }
    private void OnValueChangeKhachHangGTGT(ChangeEventArgs<int?, KhachHangDto> args)
    {
        if (args.ItemData != null)
        {
            TempHoaDonCt.KhachHangId = args.ItemData.Id;
            TempHoaDonCt.KhachHangUd = args.ItemData.KhachHangUd;
            TempHoaDonCt.KhachHangNm = args.ItemData.KhachHangNm;
            TempHoaDonCt.DiaChi = args.ItemData.DiaChi;
            TempHoaDonCt.MaSoThue = args.ItemData.MaSoThue;
        }
    }
    private void OnValueChangeVatTuGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.VatTu = args.Value?.ToString();
    }
    private void OnValueChangeTienGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.Tien = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if (TempHoaDonCt.Tien != 0)
            TempHoaDonCt.TienVND = TempHoaDonCt.Tien * SelectPhieuChi.TyGia;
    }
    private void OnValueChangeTienVNDGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.TienVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
    }
    public async Task OnFilteringThueSuatGTGT(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ThueSuatUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ThueSuatNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTSGtgt.FilterAsync(ThueSuatDtos, query);
    }
    private void OnValueChangeThueSuatGTGT(ChangeEventArgs<int?, ThueSuatDto> args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        if (args.ItemData != null)
        {
            TempHoaDonCt.MaThue = args.ItemData.Id;
            TempHoaDonCt.MaThueUd = args.ItemData.ThueSuatUd;
            TempHoaDonCt.ThueSuat = args.ItemData.GiaTri.HasValue ? args.ItemData.GiaTri : 0;
        }
        else
        {
            TempHoaDonCt.MaThue = null;
            TempHoaDonCt.MaThueUd = null;
            TempHoaDonCt.ThueSuat = 0;
        }
        if(TempHoaDonCt.Thue == 0)
            TempHoaDonCt.Thue = TempHoaDonCt.Tien * TempHoaDonCt.ThueSuat / 100;
        if(TempHoaDonCt.ThueVND == 0)
            TempHoaDonCt.ThueVND = TempHoaDonCt.TienVND * TempHoaDonCt.ThueSuat / 100;
    }
    private void OnValueChangeThueGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.Thue = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempHoaDonCt.Thue == 0)
            TempHoaDonCt.Thue = TempHoaDonCt.Tien * TempHoaDonCt.ThueSuat / 100;
    }
    private void OnValueChangeThueVNDGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.ThueVND = decimal.Parse(args.Value?.ToString() == "" ? "0" : args.Value?.ToString() ?? "0");
        if(TempHoaDonCt.ThueVND == 0)
            TempHoaDonCt.ThueVND = TempHoaDonCt.TienVND * TempHoaDonCt.ThueSuat / 100;
    }
    public async Task OnFilteringTKThueGTGT(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKTGtgt.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeTKThueGTGT(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        if (args.ItemData != null)
        {
            TempHoaDonCt.TkThue = args.ItemData.Id;
            TempHoaDonCt.TkThueUd = args.ItemData.TaiKhoanUd;
            SelectPhieuChi.TkThue = args.ItemData.Id;
            SelectPhieuChi.TkThueUd = args.ItemData.TaiKhoanUd;
        }
    }
    private void OnValueChangeGhiChuGTGT(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        this.SfGridHoaDonGTGT.PreventRender(false);
        TempHoaDonCt.GhiChu = args.Value?.ToString();
    }
    //Màn hình hóa đơn chi tiết end
    private async Task SoLuongHoaDonGTGTValueChangeAsync()
    {
        if((ShowScreenGiaoDich3 && PhieuChiCt03Requests.Count > 0) || (ShowScreenGiaoDich4 && PhieuChiCt04Requests.Count > 0))
        {
            if(HoaDonRequests.Count == 0){
                this.BindValueHoaDonGTGT();
            }
            if (jsModule != null)
            {
                await jsModule.InvokeVoidAsync("getInputIds", InputCommonIds, InputHoaDonGtgtIds, GridIds[4]);
            }
            SelectedTab = 1;
        }
        else
        {
            SelectedTab = 0;
            SelectPhieuChi.HoaDonGTGT = 0;
            TextMessage = "Hãy thêm chi tiết hạch toán !";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }

    private void MapPhieuChiCt()
    {
        if (ShowScreenGiaoDich1)
        {
           PhieuChiCt01Requests.ForEach(x => 
            {
                x.PsNo = x.ThanhToan;
                x.PsNoVND = x.ThanhToanVND;
            });
            PhieuChiCtRequests = _objectMapper.Map<List<PhieuChiCt01Request>, List<PhieuChiCTRequest>>(PhieuChiCt01Requests);
        }
        else if (ShowScreenGiaoDich2)
        {
            PhieuChiCtRequests = _objectMapper.Map<List<PhieuChiCt02Request>, List<PhieuChiCTRequest>>(PhieuChiCt02Requests);
        }
        else if (ShowScreenGiaoDich3)
        {
            PhieuChiCtRequests = _objectMapper.Map<List<PhieuChiCt03Request>, List<PhieuChiCTRequest>>(PhieuChiCt03Requests);
        }
        else if (ShowScreenGiaoDich4)
        {
            PhieuChiCtRequests = _objectMapper.Map<List<PhieuChiCt04Request>, List<PhieuChiCTRequest>>(PhieuChiCt04Requests);
        }

    }
    private async Task SaveAsync()
    {
        this.MapPhieuChiCt();
        if (!CheckNgoaiTe) //Reset các giá trị ngoại tệ về 0 khi Ngoại tệ đang là VND
        {
            PhieuChiCtRequests.ForEach(x =>
            {
                x.PsNo = 0;
                x.ThanhToan = 0;
                x.Thue = 0;
                x.ThanhToan = 0;
                x.ConPhaiTt = 0;
                x.DaTt = 0;
                x.TienTrenHd = 0;
            });
        }
        bool checkBreak = false;
        if (HoaDonRequests.Count > 0 && (ShowScreenGiaoDich3 || ShowScreenGiaoDich4))
        {
            foreach (var gtgt in HoaDonRequests)
            {
                if (gtgt.SoCt0 == null)
                {
                    TextMessage = $"Bạn chưa nhập Số hóa đơn trong Hóa đơn GTGT!";
                    CheckMessage = false;
                    IsDeleteMessage = false;
                    IsConfirmMessage = false;
                    ShowModalMessage = true;
                    checkBreak = true;
                    break;
                }
                else if (!gtgt.NgayCt0.HasValue)
                {
                    TextMessage = $"Bạn chưa nhập Ngày hóa đơn trong Hóa đơn GTGT!";
                    CheckMessage = false;
                    IsDeleteMessage = false;
                    IsConfirmMessage = false;
                    ShowModalMessage = true;
                    checkBreak = true;
                    break;
                }
                else if (!gtgt.KhachHangId.HasValue)
                {
                    TextMessage = $"Bạn chưa nhập Mã khách hàng trong Hóa đơn GTGT!";
                    CheckMessage = false;
                    IsDeleteMessage = false;
                    IsConfirmMessage = false;
                    ShowModalMessage = true;
                    checkBreak = true;
                    break;
                }
            }
            var tienCt = PhieuChiCtRequests.Sum(x => x.PsNoVND);
            var tienHd = HoaDonRequests.Sum(x => x.TienVND);
            if (tienCt != tienHd)
            {
                TextMessage = "Tiền trên chi tiết khác với tiền trên hóa đơn!";
                CheckMessage = true;
                IsDeleteMessage = false;
                IsConfirmMessage = false;
                ShowModalMessage = true;
            }
        }
        if (!checkBreak)
        {
            SelectPhieuChi.PhieuChiCTRequests = PhieuChiCtRequests;
            SelectPhieuChi.HoaDonRequests = HoaDonRequests;
            SelectPhieuChi.LoaiPhieu = SystemConstants.LoaiPhieu.GiayBaoNo;
            var result = await _phieuChi.CreateAsync(SelectPhieuChi);
            if (result.Id.HasValue && result.Id > 0)
            {
                if (SelectPhieuChi.QuyenSoId != null && SelectPhieuChi.SoPhieu != null)
                {
                    await _quyenSo.UpdateSoCTAsync(SystemConstants.LoaiPhieu.GiayBaoNo, SelectPhieuChi.QuyenSoId, SelectPhieuChi.SoPhieu);
                }
                NewId = result.Id.ToString();
                ScreenDisable();
            }
            else
            {
                TextMessage = result.Message;
                CheckMessage = false;
                IsDeleteMessage = false;
                IsConfirmMessage = false;
                ShowModalMessage = true;
            }
        }
    }

    private void CloseModalMessage()
    {
        ShowModalMessage = false;
    }

    private void BindValueHoaDonGTGT()
    {
        if (ShowScreenGiaoDich3)
        {
            HoaDonRequests = PhieuChiCt03Requests.Select(item =>
                new HoaDonRequest()
                {
                    Stt = item.Stt,
                    LoaiThue = item.LoaiThue,
                    LoaiThueUd = item.LoaiThueUd,
                    TkThue = ThamSoHeThong.TkThue,
                    TkThueUd = ThamSoHeThong.TkThueUd,
                    VuViecId = item.VuViecId,
                    MaPhiId = item.MaPhiId,
                    MaTD01 = item.MaTD01,
                    MaTD02 = item.MaTD02,
                    MaTD03 = item.MaTD03,
                    VuViecUd = item.VuViecUd,
                    MaPhiUd = item.MaPhiUd,
                    MaTD01Ud = item.MaTD01Ud,
                    MaTD02Ud = item.MaTD02Ud,
                    MaTD03Ud = item.MaTD03Ud,
                    SoCt0 = item.SoHd,
                    NgayCt0 = item.NgayHd,
                    SoSeri0 = item.SoSeri,
                    KyHieuMauHD = ThamSoHeThong.KyHieuMauHD,
                    KhachHangId = item.KhachHangId,
                    KhachHangUd = item.KhachHangUd,
                    KhachHangNm = item.KhachHangNm,
                    DiaChi = item.DiaChi,
                    MaSoThue = item.MaSoThue,
                    VatTu = item.DienGiai,
                    Tien = item.PsNo,
                    TienVND = item.PsNoVND,
                    MaThue = item.MaThue,
                    MaThueUd = item.MaThueUd,
                    ThueSuat = item.ThueSuat,
                    Thue = item.Thue,
                    ThueVND = item.ThueVND,
                    MaCt = SystemConstants.LoaiPhieu.GiayBaoNo,
                    MauBC =  SystemConstants.MauBC,
                    DieuChinhThueTNDNId = item.DieuChinhThueTNDNId

            }).ToList();
        }
        else if (ShowScreenGiaoDich4)
        {
            HoaDonRequests = PhieuChiCt04Requests.Select(item =>
                new HoaDonRequest()
                {
                    Stt = item.Stt,
                    TkThue = ThamSoHeThong.TkThue,
                    TkThueUd = ThamSoHeThong.TkThueUd,
                    VuViecId = item.VuViecId,
                    MaPhiId = item.MaPhiId,
                    MaTD01 = item.MaTD01,
                    MaTD02 = item.MaTD02,
                    MaTD03 = item.MaTD03,
                    LoaiThue = item.LoaiThue,
                    VuViecUd = item.VuViecUd,
                    MaPhiUd = item.MaPhiUd,
                    MaTD01Ud = item.MaTD01Ud,
                    MaTD02Ud = item.MaTD02Ud,
                    MaTD03Ud = item.MaTD03Ud,
                    LoaiThueUd = item.LoaiThueUd,
                    SoCt0 = item.SoHd,
                    NgayCt0 = item.NgayHd,
                    SoSeri0 = item.KiHieuMauHD,
                    KyHieuMauHD = ThamSoHeThong.KyHieuMauHD,
                    KhachHangId = SelectPhieuChi.KhachHangId,
                    KhachHangUd = SelectPhieuChi.KhachHangUd,
                    KhachHangNm = SelectPhieuChi.TenKhachHang,
                    DiaChi = SelectPhieuChi.DiaChi,
                    MaSoThue = SelectPhieuChi.MaSoThue,
                    VatTu = item.DienGiai,
                    Tien = item.PsNo,
                    TienVND = item.PsNoVND,
                    MaThue = item.MaThue,
                    MaThueUd = item.MaThueUd,
                    ThueSuat = item.ThueSuat,
                    Thue = item.Thue,
                    ThueVND = item.ThueVND,
                    MaCt = SystemConstants.LoaiPhieu.GiayBaoNo,
                    MauBC = SystemConstants.MauBC,
                    DieuChinhThueTNDNId = item.DieuChinhThueTNDNId
                }).ToList();
        }  
        SelectPhieuChi.HoaDonGTGT = HoaDonRequests.Count;
    }

    private void DefaultValueChiNhanh(List<ChiNhanhDto> chiNhanhDtos)
    {
        var item = chiNhanhDtos.First();
        SelectPhieuChi.ChiNhanhId = item.Id;
        SelectPhieuChi.ChiNhanhNm = item.ChiNhanhNm;
    }
    private void DefaultValueMaGiaDich(List<DmChungDto> maGiaoDichDtos)
    {
        var item = maGiaoDichDtos.First(x => x.DMChungUd == "4");
        SelectPhieuChi.GiaoDichId = item.Id;
        SelectPhieuChi.GiaoDichNm = item.DMChungNm;
    }

    private void DefaultValueQuyenSo(List<QuyenSoDto> quyenSoDtos)
    {
        var item = quyenSoDtos.FirstOrDefault(x => x.IsUser == true);
        if (item != null)
        {
            SelectPhieuChi.QuyenSoId = item.SoQuyen;
            SelectPhieuChi.SoPhieu = item.SoCtHienTai.HasValue ? (item.SoCtHienTai.Value + 1).ToString("D6") : "0";
        }
        else
        {
            item = quyenSoDtos.First();
            SelectPhieuChi.QuyenSoId = item.SoQuyen;
            SelectPhieuChi.SoPhieu = item.SoCtHienTai.HasValue ? (item.SoCtHienTai.Value + 1).ToString("D6") : "0";
        }
    }
    private void DefaultValueGhiCoTaiKhoan(List<TaiKhoanDto> taiKhoanDtos)
    {
        var item = taiKhoanDtos.First();
        SelectPhieuChi.GhiNoTkId = item.Id;
        SelectPhieuChi.GhiNoTkNm = item.TaiKhoanNm;
    }
    private async Task DefaultValueNgoaiTe(List<NgoaiTeDto> ngoaiTeDtos)
    {
        var ngoaiTe = ngoaiTeDtos.FirstOrDefault(x => x.NgoaiTeUd == "VND");
        if (ngoaiTe != null)
        {
            SelectPhieuChi.NgoaiTeId = ngoaiTe.Id;
            var tyGiaNgoaiTe = await _ngoaiTe.GetByIdAsync(ngoaiTe.Id);
            SelectPhieuChi.TyGia = tyGiaNgoaiTe.TyGiaNgoaiTeDtos?.First().TyGia;
            StateHasChanged();//cập nhật giao diện ngay tức thì
        }
    }

    //Tạo mới trên phiếu
    public void TaoChiNhanh()
    {
        ShowModalTaoMoiCN = true;
    }

    public void TaoKhachHang()
    {
        ShowModalTaoMoiKH = true;
    }

    //[JSInvokable("CloseModal")]
    public async Task CloseModal()
    {
        switch (true)
        {
            case var _ when ShowModalTaoMoiCN:
                var chiNhanhUd = await _localStorage.GetItemAsync<string>("TaoMoiChiNhanhUd");
                if (!chiNhanhUd.IsNullOrEmpty())
                {
                    ChiNhanhDtos = await _chiNhanh.GetListAsync();
                    var item = ChiNhanhDtos.First(x => x.ChiNhanhUd == chiNhanhUd);
                    SelectPhieuChi.ChiNhanhId = item.Id;
                    SelectPhieuChi.ChiNhanhNm = item.ChiNhanhNm;
                    await _localStorage.RemoveItemAsync("TaoMoiChiNhanhUd");
                }
                ShowModalTaoMoiCN = false;
                break;
            case var _ when ShowModalTaoMoiKH:
                var KhachHangUd = await _localStorage.GetItemAsync<string>("TaoMoiKhachHangUd");
                if (!KhachHangUd.IsNullOrEmpty())
                {
                    KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai2);
                    var item = KhachHangDtos.First(x => x.KhachHangUd == KhachHangUd);
                    SelectPhieuChi.KhachHangId = item.Id;
                    SelectPhieuChi.TenKhachHang = item.KhachHangNm;
                    await _localStorage.RemoveItemAsync("TaoMoiKhachHangUd");
                }
                ShowModalTaoMoiKH = false;
                break;
        }
        StateHasChanged();
    }
    // ẩn màn hình
    private void ScreenDisable()
    {
        GridAttributes["disable"] = "yes";
        IsDisabled = true;
        IsSaveDisabled = true;
        IsCancelDisabled = true;
        IsAddDisabled = false;
        IsEditDisabled = false;
        IsDeleteDisabled = false;
        IsPrintDisabled = false;
        IsCopyDisabled = false;
        IsCloseDisabled = false;
        IsNextDisabled = false;
    }
    // Hiện màn hình
    private void ScreenEnabled()
    {
        GridAttributes["disable"] = "no";
        IsDisabled = false;
        IsSaveDisabled = false;
        IsCancelDisabled = false;
        IsAddDisabled = true;
        IsEditDisabled = true;
        IsDeleteDisabled = true;
        IsPrintDisabled = true;
        IsCopyDisabled = true;
        IsCloseDisabled = true;
        IsNextDisabled = true;
    }

    // footer menu
    private void Cancel()
    {
        TextMessage = "Dữ liệu trên form chưa được lưu. Bạn muốn thoát không cần lưu?";
        IsDeleteMessage = false;
        IsConfirmMessage = true;
        CheckMessage = true;
        ShowModalMessage = true;

    }
    private async Task ConfirmCancelAsync()
    {
        ScreenDisable();
        await RefreshAsync();
        if (PhieuChiDtos.Count == 0)
            NavigationManager.NavigateTo($"{SystemConstants.UrlPath.GiayBaoNo}", true);
        else
        {
            await DefaultData(CurrentIndex);
            ShowModalMessage = false;
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
        }
    }
    private void Close()
    {
        NavigationManager.NavigateTo(SystemConstants.UrlPath.GiayBaoNo, true);
    }
    private void Add()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.GiayBaoNo}/create", true);
    }
    private void Edit()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.GiayBaoNo}/edit/{NewId}", true);
    }
    private void Delete()
    {
        TextMessage = $"Xác nhận xóa phiếu có số chứng từ  <span style='color:red'>{SelectPhieuChi.SoPhieu}</span>";
        IsConfirmMessage = false;
        IsDeleteMessage = true;
        ShowModalMessage = true;
    }
    private async Task ConfirmDeleleAsync()
    {
        var result = await _phieuChi.DeleteAsync(int.Parse(NewId != null ? NewId : "0"));
        if (result.IsSuccessed)
        {
            await RefreshAsync();
            if (PhieuChiDtos.Count == 0)
                NavigationManager.NavigateTo($"{SystemConstants.UrlPath.GiayBaoNo}", true);
            else if (CurrentIndex > PhieuChiDtos.Count - 1)            
                CurrentIndex = PhieuChiDtos.Count - 1;          
             await DefaultData(CurrentIndex);
            ShowModalMessage = false;
        }
        else
        {
            ShowModalMessage = true;
            IsDeleteMessage = true;
            IsConfirmMessage = false;
            TextMessage = result.Message;
        }
    }
    private async Task Copy()
    {
        QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.GiayBaoNo);
        if (QuyenSoDtos != null)
            this.DefaultValueQuyenSo(QuyenSoDtos);
        ScreenEnabled();
    }
    private async Task FirstAsync()
    {
        await RefreshAsync();
        CurrentIndex = 0;
        await DefaultData(CurrentIndex);
    }

    private async Task PreviousAsync()
    {
        if (CurrentIndex > 0)
        {
            await RefreshAsync();
            CurrentIndex--;
            await DefaultData(CurrentIndex);
        }
    }

    private async Task NextAsync()
    {
        await RefreshAsync();
        if (CurrentIndex < PhieuChiDtos.Count - 1)
        {
            CurrentIndex++;
            await DefaultData(CurrentIndex);
        }
    }

    private async Task LastAsync()
    {
        await RefreshAsync();
        CurrentIndex = PhieuChiDtos.Count - 1;
        await DefaultData(CurrentIndex);
    }
    // Footer menu end
    private async Task DefaultData(int currentIndex, bool isCheck = false)
    {
        if (currentIndex >= 0 && currentIndex < PhieuChiDtos.Count)
        {
            var id = PhieuChiDtos[currentIndex].Id;
            if (!isCheck)
            {
                NewId = id.ToString();
            }
            var phieuChi = await _phieuChi.GetByIdAsync(NewId != null ? int.Parse(NewId) : id);
            if (phieuChi.Id != null)
            {
                SelectPhieuChi = _objectMapper.Map<PhieuChiDto, PhieuChiRequest>(phieuChi);
                if (NgoaiTeDtos.Count > 0 && NgoaiTeDtos.First(x => x.Id == SelectPhieuChi.NgoaiTeId).NgoaiTeUd != "VND")
                    CheckNgoaiTe = true;
                else
                    CheckNgoaiTe = false;
                if (phieuChi.PhieuChiCTDtos?.Count > 0)
                {
                    CheckEnabledMaGiaoDich = false;
                    PhieuChiCtRequests = _objectMapper.Map<List<PhieuChiCTDto>, List<PhieuChiCTRequest>>(phieuChi.PhieuChiCTDtos);
                }
                switch (SelectPhieuChi.GiaoDichUd)
                {
                    case "1":
                        ShowScreenGiaoDich1 = true;
                        CheckShowSoLuongHD = false;
                        PhieuNhapDtos = await _phieuNhap.GetListByKhachHangIdAsync(SelectPhieuChi.KhachHangId);
                        foreach (var item in PhieuNhapDtos)
                        {
                            var nt = await _ngoaiTe.GetByIdAsync(item.NgoaiTeId);
                            var tk = await _taiKhoan.GetByIdAsync(item.GhiCoTk);
                            item.GhiCoTkUd = tk.TaiKhoanUd;
                            item.NgoaiTeUd = nt.NgoaiTeUd;
                        }
                        ShowScreenGiaoDich2 = false;
                        ShowScreenGiaoDich3 = false;
                        ShowScreenGiaoDich4 = false;
                        PhieuChiCt01Requests = _objectMapper.Map<List<PhieuChiCTRequest>, List<PhieuChiCt01Request>>(PhieuChiCtRequests);
                        break;
                    case "2":
                        ShowScreenGiaoDich2 = true;
                        ShowScreenGiaoDich1 = false;
                        ShowScreenGiaoDich3 = false;
                        ShowScreenGiaoDich4 = false;
                        PhieuChiCt02Requests = _objectMapper.Map<List<PhieuChiCTRequest>, List<PhieuChiCt02Request>>(PhieuChiCtRequests);
                        break;
                    case "3":
                        ShowScreenGiaoDich3 = true;
                        ShowScreenGiaoDich1 = false;
                        ShowScreenGiaoDich2 = false;
                        ShowScreenGiaoDich4 = false;         
                        PhieuChiCt03Requests = _objectMapper.Map<List<PhieuChiCTRequest>, List<PhieuChiCt03Request>>(PhieuChiCtRequests);
                        HoaDonRequests = _objectMapper.Map<List<HoaDonGtgtDto>, List<HoaDonRequest>>(phieuChi.HoaDonGTGTDtos ?? new List<HoaDonGtgtDto>());
                        break;
                    case "4":
                        ShowScreenGiaoDich4 = true;
                        ShowScreenGiaoDich1 = false;
                        ShowScreenGiaoDich2 = false;
                        ShowScreenGiaoDich3 = false;  
                        PhieuChiCt04Requests = _objectMapper.Map<List<PhieuChiCTRequest>, List<PhieuChiCt04Request>>(PhieuChiCtRequests);
                        HoaDonRequests = _objectMapper.Map<List<HoaDonGtgtDto>, List<HoaDonRequest>>(phieuChi.HoaDonGTGTDtos ?? new List<HoaDonGtgtDto>());
                        break;
                    default:
                        break;
                }
            }
        }
    }

    private async Task RefreshAsync()
    {
        DateTime? tuNgay = await _localStorage.GetItemAsync<string>("TuNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("TuNgayLamViec")) : null;
        DateTime? denNgay = await _localStorage.GetItemAsync<string>("DenNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("DenNgayLamViec")).AddDays(1) : null;
        if (tuNgay != null && denNgay != null)
        {
            PhieuChiDtos = await _phieuChi.GetListAsync(SystemConstants.LoaiPhieu.GiayBaoNo, tuNgay, denNgay);
            ChiNhanhDtos = await _chiNhanh.GetListAsync();
            MaGiaoDichDtos = await _dmChung.GetListAsync(SystemConstants.DmChung.GiaoDichNo);
            KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai2);
            QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.GiayBaoNo);
            TaiKhoanDtos = await _taiKhoan.GetListAsync();
            NgoaiTeDtos = await _ngoaiTe.GetListAsync();
            DMChungDtos = await _dmChung.GetListAsync(SystemConstants.DmChung.LoaiThue);
            BoPhanHTDtos = await _boPhanHT.GetListAsync();
            //VatTuDtos = await _vatTu.GetListAsync();
            VuViecDtos = await _vuViec.GetListAsync();
            DmMaPhiDtos = await _dmMaPhi.GetListAsync();
            DieuChinhThueTNDnDtos = await _dieuChinhThueTNDN.GetListAsync();
            DmTruongTuDo1Dtos = await _dmTruongTuDo.GetListLoai1Async();
            DmTruongTuDo2Dtos = await _dmTruongTuDo.GetListLoai2Async();
            DmTruongTuDo3Dtos = await _dmTruongTuDo.GetListLoai3Async();
        }
        else
        {
            NavigationManager.NavigateTo(SystemConstants.UrlPath.ThoiGianLamViec, true);
        }
    }

    //Hàm giải phóng bộ nhớ
    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (jsModule is not null)
        {
            await jsModule.DisposeAsync();
        }
    }
}
