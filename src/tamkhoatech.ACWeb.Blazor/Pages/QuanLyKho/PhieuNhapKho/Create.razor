@page "/phieunhapkho/create"
@using Blazored.LocalStorage
@using Syncfusion.Blazor.Data
@using Volo.Abp.ObjectMapping
@using tamkhoatech.ACWeb.Blazor.Pages.Common
@using tamkhoatech.ACWeb.Constants
@using tamkhoatech.ACWeb.Dto
@using tamkhoatech.ACWeb.IService

@inject NavigationManager NavigationManager
@inject ILocalStorageService _localStorage
@inject IObjectMapper _objectMapper
@inject IPhieuNhapKhoService _phieuNhapKho
@inject IChiNhanhService _chiNhanh
@inject IDMChungService _dmChung
@inject IKhachHangService _khachHang
@inject IQuyenSoService _quyenSo
@inject INgoaiTeService _ngoaiTe
@inject IVatTuService _vatTu
@inject IKhoService _kho
@inject ITaiKhoanService _taiKhoan
@inject IBoPhanHTService _boPhanHT
@inject IVuViecService _vuViec
@inject IDmMaPhiService _dmMaPhi

@if (hasRefreshed)
{
    <div @onkeyup="@OnKeyUp" @onblur="FocusOnInput">
        <div class="row title">
            <div class="text-center">
                <div class="row align-items-start">
                    <h4><strong>Thêm mới phiếu nhập kho (nội bộ)</strong></h4>
                </div>
            </div>
        </div>
        <EditForm Model="SelectPhieuNhapKho" Context="EditFormPND" OnValidSubmit="@SaveAsync">
            <DataAnnotationsValidator />
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <div class="row">
                            <div class="col-sm-7">
                                <div class="row">
                                    <div class="col-sm-7">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="ChiNhanhId" class="form-label">Mã chi nhánh <span class="text-danger">*</span></label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-4">
                                                    <SfComboBox @ref="ddCN" @bind-Value="@SelectPhieuNhapKho.ChiNhanhId" DataSource="@ChiNhanhDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="700" PopupHeight="300">
                                                        <ComboBoxEvents TValue="int?" TItem="ChiNhanhDto" Filtering="OnFilteringChiNhanh" ValueChange="OnValueChangeChiNhanh"></ComboBoxEvents>
                                                        <ComboBoxFieldSettings Value="Id" Text="ChiNhanhUd" />
                                                        <ComboBoxTemplates TItem="ChiNhanhDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <thead>
                                                                        <tr>
                                                                            <th style="width:150px">Mã chi nhánh</th>
                                                                            <th>Tên chi nhánh</th>
                                                                            <th>Tên 2</th>
                                                                        </tr>
                                                                    </thead>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td style="width:150px"><span>@((itemContext as ChiNhanhDto).ChiNhanhUd)</span></td>
                                                                            <td><span>@((itemContext as ChiNhanhDto).ChiNhanhNm)</span></td>
                                                                            <td><span>@((itemContext as ChiNhanhDto).ChiNhanhNm2)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                </div>
                                                <div class="col-sm-8">
                                                    <SfTextBox ID="ChiNhanhNm" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.ChiNhanhNm)" Enabled="false"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="GiaoDichId" class="form-label">Loại phiếu nhập <span class="text-danger">*</span></label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-4">
                                                    <SfComboBox @ref="ddGD" @bind-Value="@SelectPhieuNhapKho.GiaoDichId" DataSource="@MaGiaoDichDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="500" PopupHeight="300">
                                                        <ComboBoxEvents TValue="int?" TItem="DmChungDto"  Filtering="OnFilteringMaGiaoDich" ValueChange="OnValueChangeMaGiaoDich"></ComboBoxEvents>
                                                        <ComboBoxFieldSettings Value="Id" Text="DMChungUd" />
                                                        <ComboBoxTemplates TItem="DmChungDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <tr>
                                                                        <th style="width:150px">Mã giao dịch</th>
                                                                        <th>Tên giao dịch</th>
                                                                    </tr>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td style="width:150px"><span>@((itemContext as DmChungDto).DMChungUd)</span></td>
                                                                            <td><span>@((itemContext as DmChungDto).DMChungNm)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                </div>
                                                <div class="col-sm-8">
                                                    <SfTextBox ID="MaGiaoDichNm" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.GiaoDichNm)" Enabled="false"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-5">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgGiaoHang" class="form-label">Người giao hàng</label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="NgGiaoHang" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.NgGiaoHang)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="DienGiai" class="form-label">Diễn giải</label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="DienGiai" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.DienGiai)" Enabled="!IsDisabled"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-7">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="KhachHangId" class="form-label">Mã khách hàng <span class="text-danger">*</span></label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-4">
                                                    <div class="d-flex align-items-center">
                                                        <SfComboBox @ref="ddKH" @bind-Value="@SelectPhieuNhapKho.KhachHangId" DataSource="@KhachHangDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="1000" PopupHeight="300">
                                                            <ComboBoxEvents TValue="int?" TItem="KhachHangDto" Filtering="OnFilteringKhachHang" ValueChange="OnValueChangeKhachHang"></ComboBoxEvents>
                                                            <ComboBoxFieldSettings Text="KhachHangUd" Value="Id"></ComboBoxFieldSettings>
                                                            <ComboBoxTemplates TItem="KhachHangDto">
                                                                <HeaderTemplate>
                                                                    <table class="header-combo">
                                                                        <tr>
                                                                            <th style="width:150px">Mã khách hàng</th>
                                                                            <th>Tên khách</th>
                                                                            <th style="width:150px">Mã số thuế</th>
                                                                            <th style="width:150px">Số dư</th>
                                                                            <th>Địa chỉ</th>
                                                                        </tr>
                                                                    </table>
                                                                </HeaderTemplate>
                                                                <ItemTemplate Context="itemContext">
                                                                    <table>
                                                                        <tbody>
                                                                            <tr>
                                                                                <td style="width:130px"><span>@((itemContext as KhachHangDto).KhachHangUd)</span></td>
                                                                                <td><span>@((itemContext as KhachHangDto).KhachHangNm)</span></td>
                                                                                <td style="width:130px"><span>@((itemContext as KhachHangDto).MaSoThue)</span></td>
                                                                                <td style="width:130px"><span>@((itemContext as KhachHangDto).Sodu?.ToString("N0"))</span></td>
                                                                                <td><span>@((itemContext as KhachHangDto).DiaChi)</span></td>
                                                                            </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ItemTemplate>
                                                            </ComboBoxTemplates>
                                                        </SfComboBox>
                                                    </div>
                                                </div>
                                                <div class="col-sm-8">
                                                    <SfTextBox ID="KhachHangNm" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.KhachHangNm)" Enabled="false"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-5">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="DiaChi" class="form-label">Địa chỉ</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfTextBox ID="DiaChi" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.DiaChi)" Enabled="false"></SfTextBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-5">
                                <div class="row">
                                    <div class="col-sm-8">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <div class="row">
                                                        <div class="col-sm-12">
                                                            <label for="QuyenSo" class="form-label">Quyển sổ</label>
                                                        </div>
                                                        <div class="col-sm-12">
                                                            <SfComboBox @ref="ddQS" @bind-Value="@SelectPhieuNhapKho.QuyenSo" DataSource="@QuyenSoDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="700" PopupHeight="300">
                                                                <ComboBoxEvents TValue="string" TItem="QuyenSoDto" Filtering="OnFilteringQuyenSo" ValueChange="OnValueChangeQuyenSo"></ComboBoxEvents>
                                                                <ComboBoxFieldSettings Text="SoQuyen" Value="SoQuyen"></ComboBoxFieldSettings>
                                                                <ComboBoxTemplates TItem="QuyenSoDto">
                                                                    <HeaderTemplate>
                                                                        <table class="header-combo">
                                                                            <tr>
                                                                                <th>Mã ct</th>
                                                                                <th>Số quyển</th>
                                                                                <th>Số ct hiện tại</th>
                                                                                <th>Số ký tự 0</th>
                                                                                <th>Sử dụng</th>
                                                                            </tr>
                                                                        </table>
                                                                    </HeaderTemplate>
                                                                    <ItemTemplate Context="itemContext">
                                                                        <table>
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td><span>@((itemContext as QuyenSoDto).MaCt)</span></td>
                                                                                    <td><span>@((itemContext as QuyenSoDto).SoQuyen)</span></td>
                                                                                    <td><span>@((itemContext as QuyenSoDto).SoCtHienTai)</span></td>
                                                                                    <td><span>@((itemContext as QuyenSoDto).SoKyTu0)</span></td>
                                                                                    <td><span>@((itemContext as QuyenSoDto).IsUser)</span></td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </ItemTemplate>
                                                                </ComboBoxTemplates>
                                                            </SfComboBox>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <div class="row">
                                                        <div class="col-sm-12">
                                                            <label for="SoCt" class="form-label">Số phiếu nhập<span class="text-danger">*</span></label>
                                                        </div>
                                                        <div class="col-sm-12">
                                                            <SfTextBox ID="SoCt" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.SoCt)" Enabled="!IsDisabled"></SfTextBox>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgoaiTeId" class="form-label">Tỷ giá <span class="text-danger">*</span></label>
                                                </div>
                                                <div class="col-sm-6">
                                                    <SfComboBox @ref="ddNT" @bind-Value="@SelectPhieuNhapKho.NgoaiTeId" DataSource="@NgoaiTeDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" Enabled="!IsDisabled" CssClass="e-multi-column e-small" PopupWidth="350" PopupHeight="300">
                                                        <ComboBoxEvents TValue="int?" TItem="NgoaiTeDto" Filtering="OnFilteringNgoaiTe" ValueChange="OnValueChangeNgoaiTe"></ComboBoxEvents>
                                                        <ComboBoxFieldSettings Text="NgoaiTeUd" Value="Id"></ComboBoxFieldSettings>
                                                        <ComboBoxTemplates TItem="NgoaiTeDto">
                                                            <HeaderTemplate>
                                                                <table class="header-combo">
                                                                    <tr>
                                                                        <th>Mã ngoại tệ</th>
                                                                        <th>Tên ngoại tệ</th>
                                                                        <th>Tên 2</th>
                                                                    </tr>
                                                                </table>
                                                            </HeaderTemplate>
                                                            <ItemTemplate Context="itemContext">
                                                                <table>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td><span>@((itemContext as NgoaiTeDto).NgoaiTeUd)</span></td>
                                                                            <td><span>@((itemContext as NgoaiTeDto).NgoaiTeNm)</span></td>
                                                                            <td><span>@((itemContext as NgoaiTeDto).NgoaiTeNm2)</span></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </ItemTemplate>
                                                        </ComboBoxTemplates>
                                                    </SfComboBox>
                                                </div>
                                                <div class="col-sm-6">
                                                    <SfNumericTextBox ShowSpinButton="false" ID="TyGia" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.TyGia)" Format="N2" Enabled="!CheckNgoaiTe ? CheckNgoaiTe : !IsDisabled"></SfNumericTextBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfCheckBox Label="Nhập theo giá TB cho vật tư tính giá TB" @bind-Checked="SelectPhieuNhapKho.IsNhapGiaTb" Disabled="IsDisabled"></SfCheckBox>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfCheckBox Label="Tạo phiếu xuất nguyên vật liệu" @bind-Checked="SelectPhieuNhapKho.IsTaoPhieuXuatKho" Disabled="IsDisabled"></SfCheckBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgayHt" class="form-label">Ngày hạch toán <span class="text-danger">*</span></label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfDatePicker TValue="DateTime?" CssClass="e-small" ShowClearButton="true" @bind-Value="@(SelectPhieuNhapKho.NgayHT)" Format="dd/MM/yyyy" FullScreen="true" Enabled="!IsDisabled">
                                                        <DatePickerEvents TValue="DateTime?" ValueChange="OnValueChangeNgayht"></DatePickerEvents>
                                                    </SfDatePicker>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <label for="NgayLap" class="form-label">Ngày lập</label>
                                                </div>
                                                <div class="col-sm-12">
                                                    <SfDatePicker ID="NgayLap" CssClass="e-small" @bind-Value="@(SelectPhieuNhapKho.NgayLap)" Format="dd/MM/yyyy" Enabled="false"></SfDatePicker>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-1">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <SfCheckBox Label="Sửa tiền" @bind-Checked="SelectPhieuNhapKho.IsSuaTien" Disabled="IsDisabled"></SfCheckBox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div" @onclick="ClickFocus">
                        <SfTab>
                            <TabItems>
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Chi tiết hạch toán"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <SfGrid @ref="SfGridPhieuNhapKhoCt" @attributes="@GridAttributes" DataSource="@PhieuNhapKhoCtRequests" AllowSorting="true" AllowResizing="true" Height="200">
                                            <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" NewRowPosition="NewRowPosition.Bottom"></GridEditSettings>
                                            <GridEvents OnActionBegin="ActionBeginPhieuNhapKhoCt" OnActionComplete="ActionCompletedPhieuNhapKhoCt" TValue="PhieuNhapKhoCtRequest"></GridEvents>
                                            <GridColumns>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.Id) HeaderText="#" IsPrimaryKey="true" Visible="false" AllowAdding="false" AllowEditing="false" TextAlign="TextAlign.Left" Width="60"></GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.VatTuId)  TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Vật tư <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddVTCt" @bind-Value="@(item.VatTuId)" DataSource="@VatTuDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1100" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="VatTuDto" Created="CreatedVatTuCtHandler"  Filtering="OnFilteringVatTuCt" ValueChange="OnValueChangeVatTuCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="VatTuUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="VatTuDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã vt</th>
                                                                                    <th style="width:300px">Tên vt</th>
                                                                                    <th style="width:150px">Đơn vị tính</th>
                                                                                    <th style="width:150px">Nhóm vt 1</th>
                                                                                    <th style="width:150px">Nhóm vt 2</th>
                                                                                    <th style="width:150px">Nhóm vt 3</th>
                                                                                    @*<th>Vt tồn kho</th>
                                                                        <th>Cách tính giá</th>
                                                                        <th>Tk vt</th>
                                                                        <th>Tk giá vốn</th>
                                                                        <th>Tk doanh thu</th>
                                                                        <th>Tk hàng bán tl</th>
                                                                        <th>Tk sản phẩm dd</th>
                                                                        <th>Tk chênh lệch giá vt</th>
                                                                        <th>Tên 2</th>*@
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as VatTuDto).VatTuUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as VatTuDto).VatTuNm)</span></td>
                                                                                        <td style="width:150px"><span>@((itemContext as VatTuDto).DonViTinh)</span></td>
                                                                                        <td style="width:150px"><span>@((itemContext as VatTuDto).NhomVT1)</span></td>
                                                                                        <td style="width:150px"><span>@((itemContext as VatTuDto).NhomVT2)</span></td>
                                                                                        <td style="width:150px"><span>@((itemContext as VatTuDto).NhomVT3)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).IsTheoDoiTonKho)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).CachTinhGia)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).TkKhoUd)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).TkGiaVonUd)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).TkDoanhThuUd)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).TkHangBiTraUd)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).TkSpDoDangUd)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).TkChenhLechGiaVtUd)</span></td>
                                                                                        <td><span>@((itemContext as VatTuDto).VatTuNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueVatTuCt)
                                                                {
                                                                    item.VatTuUd = SelectVatTuCt.VatTuUd;
                                                                    item.VatTuNm = SelectVatTuCt.VatTuNm;
                                                                    item.DonViTinh = SelectVatTuCt.DonViTinh;
                                                                    CheckOnChangeValueVatTuCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.VatTuUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.VatTuNm) HeaderText="Tên vật tư" TextAlign="TextAlign.Left" Width="300">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfTextBox @bind-Value="@(item.VatTuNm)" Enabled="false"></SfTextBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.DonViTinh) HeaderText="Đơn vị tính" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfTextBox @bind-Value="@(item.DonViTinh)" Enabled="false"></SfTextBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.KhoId) TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Mã kho <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddKCt" @bind-Value="@(item.KhoId)" DataSource="@KhoDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="KhoDto" Filtering="OnFilteringKhoCt" ValueChange="OnValueChangeKhoCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="KhoUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="KhoDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã kho</th>
                                                                                    <th style="width:300px">Tên kho</th>
                                                                                    <th>Tên chi nhánh</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as KhoDto).KhoUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as KhoDto).KhoNm)</span></td>
                                                                                        <td><span>@((itemContext as KhoDto).ChiNhanhUd)</span></td>
                                                                                        <td><span>@((itemContext as KhoDto).KhoNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueKhoCt)
                                                                {
                                                                    item.KhoUd = SelectKhoCt.KhoUd;
                                                                    CheckOnChangeValueKhoCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.KhoUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.SoLuong) HeaderText="Số lượng" TextAlign="TextAlign.Right" Format="N0" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                if (item.SoLuong == null)
                                                                {
                                                                    item.SoLuong = 0;
                                                                }
                                                                <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.SoLuong)" Format="N0"></SfNumericTextBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.Gia) HeaderText="Đơn giá ngoại tệ" Visible="CheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                if (item.Gia == null)
                                                                {
                                                                    item.Gia = 0;
                                                                }
                                                                if (SelectPhieuNhapKho.IsNhapGiaTb == false)
                                                                {
                                                                    <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.Gia)" @onchange="OnValueChangeDonGia" Format="N2"></SfNumericTextBox>
                                                                }
                                                                else
                                                                {
                                                                    //bổ sung chức năng tính giá trung bình
                                                                    <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.Gia)" Enabled="false" Format="N2"></SfNumericTextBox>
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.GiaVND) HeaderText="Đơn giá" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                if (item.GiaVND == null)
                                                                {
                                                                    item.GiaVND = 0;
                                                                }
                                                                if (SelectPhieuNhapKho.IsNhapGiaTb == false)
                                                                {
                                                                    if (CheckNgoaiTe)
                                                                    {
                                                                        item.GiaVND = item.Gia * SelectPhieuNhapKho.TyGia;
                                                                        <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.GiaVND)" Enabled="false" Format="N0"></SfNumericTextBox>
                                                                    }
                                                                    else
                                                                    {
                                                                        <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.GiaVND)" @onchange="OnValueChangeDonGiaVND" Format="N0"></SfNumericTextBox>
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.GiaVND)" Enabled="false" Format="N0"></SfNumericTextBox>
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.Tien) HeaderText="Thành tiền ngoại tệ" Visible="CheckNgoaiTe" TextAlign="TextAlign.Right" Format="N2" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                if (item.Tien == null)
                                                                {
                                                                    item.Tien = 0;
                                                                }
                                                                item.Tien = item.SoLuong * item.Gia;
                                                                <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.Tien)" Format="N2" Enabled="false"></SfNumericTextBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.TienVND) HeaderText="Thành tiền" TextAlign="TextAlign.Right" Format="N0" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                if (item.TienVND == null)
                                                                {
                                                                    item.TienVND = 0;
                                                                }
                                                                item.TienVND = item.SoLuong * item.GiaVND;
                                                                <SfNumericTextBox ShowSpinButton="false" @bind-Value="@(item.TienVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                                            }
                                                        }
                                                    </EditTemplate>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.GhiNoTK) TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Ghi nợ tài khoản <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddTKNCt" @bind-Value="@(item.GhiNoTK)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringGhiNoTaiKhoanCt" ValueChange="OnValueChangeGhiNoTaiKhoanCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã tài khoản</th>
                                                                                    <th>Tên tài khoản</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueGhiNoTaiKoanCt)
                                                                {
                                                                    item.GhiNoTKUd = SelectGhiNoTaiKhoanCt.TaiKhoanUd;
                                                                    CheckOnChangeValueGhiNoTaiKoanCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.GhiNoTKUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.GhiCoTK) TextAlign="TextAlign.Left" Width="150">
                                                    <HeaderTemplate>
                                                        Ghi có tài khoản <span style="color:red">*</span>
                                                    </HeaderTemplate>
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddTKCCt" @bind-Value="@(item.GhiCoTK)" DataSource="@TaiKhoanDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="TaiKhoanDto" Filtering="OnFilteringGhiCoTaiKhoanCt" ValueChange="OnValueChangeGhiCoTaiKhoanCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="TaiKhoanUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="TaiKhoanDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã tài khoản</th>
                                                                                    <th>Tên tài khoản</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as TaiKhoanDto).TaiKhoanUd)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm)</span></td>
                                                                                        <td><span>@((itemContext as TaiKhoanDto).TaiKhoanNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueGhiCoTaiKoanCt)
                                                                {
                                                                    item.GhiCoTKUd = SelectGhiCoTaiKhoanCt.TaiKhoanUd;
                                                                    CheckOnChangeValueGhiCoTaiKoanCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.GhiCoTKUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.BoPhanHTId) HeaderText="Mã bộ phận ht" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddBPHTCt" @bind-Value="@(item.BoPhanHTId)" DataSource="@BoPhanHTDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="BoPhanHTDto" Filtering="OnFilteringBoPhanHtCt" ValueChange="OnValueChangeBoPhanHtCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="BoPhanHtUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="BoPhanHTDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã bộ phận</th>
                                                                                    <th>Tên bộ phận</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as BoPhanHTDto).BoPhanHtUd)</span></td>
                                                                                        <td><span>@((itemContext as BoPhanHTDto).BoPhanHtNm)</span></td>
                                                                                        <td><span>@((itemContext as BoPhanHTDto).BoPhanHtNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueBoPhanHtCt)
                                                                {
                                                                    item.BoPhanHTUd = SelectBoPhanHtCt.BoPhanHtUd;
                                                                    CheckOnChangeValueBoPhanHtCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.BoPhanHTUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.VuViecId) HeaderText="Mã vụ việc" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddVVCt" @bind-Value="@(item.VuViecId)" DataSource="@VuViecDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="1100" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="VuViecDto" Filtering="OnFilteringVuViecCt" ValueChange="OnValueChangeVuViecCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="VuViecUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="VuViecDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã vụ việc</th>
                                                                                    <th style="width:300px">Tên vụ việc</th>
                                                                                    <th>Tên chi nhánh</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as VuViecDto).VuViecUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as VuViecDto).VuViecNm)</span></td>
                                                                                        <td><span>@((itemContext as VuViecDto).VuViecNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueVuViecCt)
                                                                {
                                                                    item.VuViecUd = SelectVuViecCt.VuViecUd;
                                                                    CheckOnChangeValueVuViecCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.VuViecUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Field=@nameof(PhieuNhapKhoCtRequest.MaPhiId) HeaderText="Mã phí" TextAlign="TextAlign.Left" Width="150">
                                                    <EditTemplate>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            if (item != null)
                                                            {
                                                                <SfComboBox @ref="ddMPCt" @bind-Value="@(item.MaPhiId)" DataSource="@DmMaPhiDtos"  AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column" PopupWidth="700" PopupHeight="300">
                                                                    <ComboBoxEvents TValue="int?" TItem="DmMaPhiDto" Filtering="OnFilteringDmMaPhiCt" ValueChange="OnValueChangeDmMaPhiCt"></ComboBoxEvents>
                                                                    <ComboBoxFieldSettings Text="DmMaPhiUd" Value="Id"></ComboBoxFieldSettings>
                                                                    <ComboBoxTemplates TItem="DmMaPhiDto">
                                                                        <HeaderTemplate>
                                                                            <table class="header-combo">
                                                                                <tr>
                                                                                    <th style="width:150px">Mã phí</th>
                                                                                    <th style="width:300px">Tên phí</th>
                                                                                    <th>Tên 2</th>
                                                                                </tr>
                                                                            </table>
                                                                        </HeaderTemplate>
                                                                        <ItemTemplate Context="itemContext">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td style="width:150px"><span>@((itemContext as DmMaPhiDto).DmMaPhiUd)</span></td>
                                                                                        <td style="width:300px"><span>@((itemContext as DmMaPhiDto).DmMaPhiNm)</span></td>
                                                                                        <td><span>@((itemContext as DmMaPhiDto).DmMaPhiNm2)</span></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </ItemTemplate>
                                                                    </ComboBoxTemplates>
                                                                </SfComboBox>
                                                                if (CheckOnChangeValueDmMaPhiCt)
                                                                {
                                                                    item.MaPhiUd = SelectDmMaPhiCt.DmMaPhiUd;
                                                                    CheckOnChangeValueDmMaPhiCt = false;
                                                                }
                                                            }
                                                        }
                                                    </EditTemplate>
                                                    <Template>
                                                        @{
                                                            var item = (context as PhieuNhapKhoCtRequest);
                                                            <div>@item?.MaPhiUd</div>
                                                        }
                                                    </Template>
                                                </GridColumn>
                                            </GridColumns>
                                        </SfGrid>
                                    </ContentTemplate>
                                </TabItem>
                            </TabItems>
                        </SfTab>
                        <div class="d-flex align-items-Left">

                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="AddRowCtAsync" disabled="@IsDisabled">Thêm dòng <b>F4</b></button>

                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="DeleteRowCtAsync" disabled="@IsDisabled">Xóa dòng <b>F8</b> </button>

                            <button type="button" class="btn btn-sm btn-them-xoa m-2" @onclick="CancelCtAsync" disabled="@IsDisabled">Hủy thao tác <b>F9</b></button>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="bordered-div">
                        <div class="row">
                            <div class="col-sm-2">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="KhoXuatNVLId" class="form-label">Mã kho xuất NVL<span class="text-danger">*</span></label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfComboBox @ref="ddK" @bind-Value="@(SelectPhieuNhapKho.KhoXuatNVLId)" DataSource="@KhoDtos" AllowFiltering="true" Autofill="true" AllowCustom="false" CssClass="e-multi-column e-small" Enabled="!IsDisabled" PopupWidth="700" PopupHeight="300">
                                                <ComboBoxEvents TValue="int?" TItem="KhoDto" Filtering="OnFilteringKho"></ComboBoxEvents>
                                                <ComboBoxFieldSettings Text="KhoUd" Value="Id"></ComboBoxFieldSettings>
                                                <ComboBoxTemplates TItem="KhoDto">
                                                    <HeaderTemplate>
                                                        <table class="header-combo">
                                                            <tr>
                                                                <th style="width:150px">Mã kho</th>
                                                                <th style="width:300px">Tên kho</th>
                                                                <th>Tên chi nhánh</th>
                                                                <th>Tên 2</th>
                                                            </tr>
                                                        </table>
                                                    </HeaderTemplate>
                                                    <ItemTemplate Context="itemContext">
                                                        <table>
                                                            <tbody>
                                                                <tr>
                                                                    <td style="width:150px"><span>@((itemContext as KhoDto).KhoUd)</span></td>
                                                                    <td style="width:300px"><span>@((itemContext as KhoDto).KhoNm)</span></td>
                                                                    <td><span>@((itemContext as KhoDto).ChiNhanhUd)</span></td>
                                                                    <td><span>@((itemContext as KhoDto).KhoNm2)</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </ItemTemplate>
                                                </ComboBoxTemplates>
                                            </SfComboBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="SoLuong" class="form-label">Số lượng</label>
                                        </div>
                                        <div class="col-sm-12">
                                            <SfNumericTextBox ShowSpinButton="false" ID="SoLuong" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuNhapKho.SoLuong)" Format="N0" Min="0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="mb-1">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <label for="TongTienVND" class="form-label">Tổng tiền</label>
                                        </div>
                                        <div class="col-sm-6">
                                            <SfNumericTextBox ShowSpinButton="false" ID="TongTienVND" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuNhapKho.TongTienVND)" Format="N0" Enabled="false"></SfNumericTextBox>
                                        </div>
                                        <div class="col-sm-6">
                                            @if (CheckNgoaiTe)
                                            {
                                                <SfNumericTextBox ShowSpinButton="false" ID="TongTien" CssClass="e-small" TValue="decimal?" @bind-Value="@(SelectPhieuNhapKho.TongTien)" Format="N2" Enabled="false"></SfNumericTextBox>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <br />
            <FooterMenu IsSave="true" IsSaveDisabled="IsSaveDisabled" IsCancel="true" IsCancelDisabled="IsCancelDisabled" OnValidSubmitCancel="Cancel"
                        IsAdd="true" IsAddDisabled="IsAddDisabled" OnValidSubmitAdd="Add"
                        IsEdit="true" IsEditDisabled="IsEditDisabled" OnValidSubmitEdit="Edit"
                        IsDelete="true" IsDeleteDisabled="IsDeleteDisabled" OnValidSubmitDelete="Delete"
                        IsPrint="true" IsPrintDisabled="IsPrintDisabled"
                        IsCopy="true" IsCopyDisabled="IsCopyDisabled" OnValidSubmitCopy="Copy"
                        IsClose="true" IsCloseDisabled="IsCloseDisabled" OnValidSubmitClose="Close"
                        IsNextDisabled="IsNextDisabled" IsNext="true" OnValidSubmitFirst="FirstAsync" OnValidSubmitPrevious="PreviousAsync" OnValidSubmitNext="NextAsync" OnValidSubmitLast="LastAsync" />
        </EditForm>
    </div>
    <ModalErrorMessage ShowModalMessage="@ShowModalMessage" CheckMessage="@CheckMessage" TextMessage="@TextMessage" IsDelete="@IsDeleteMessage"
                       OnCloseMessage="CloseModalMessage" OnConfirmDelele="ConfirmDeleleAsync" IsConfirm="@IsConfirmMessage" OnConfirm="ConfirmCancelAsync" />
}
else
{
    <h3>Vui lòng chờ....</h3>
}

<link rel="stylesheet" href="/Css/them-sua-phieu.css">
@code{
    private bool hasRefreshed = false;
    private PhieuNhapKhoRequest SelectPhieuNhapKho = new PhieuNhapKhoRequest()
    {
        NgayHT = DateTime.Now,
        NgayLap = DateTime.Now,
        IsTaoPhieuXuatKho = false,
        IsSuaTien = false,
        IsNhapGiaTb = false,
        SoLuong = 0,
        TongTien = 0,
        TongTienVND = 0
    };
    private List<ChiNhanhDto> ChiNhanhDtos = new List<ChiNhanhDto>();
    private SfComboBox<int?, ChiNhanhDto> ddCN = new SfComboBox<int?, ChiNhanhDto>();
    private List<DmChungDto> MaGiaoDichDtos = new List<DmChungDto>();
    private SfComboBox<int?, DmChungDto> ddGD = new SfComboBox<int?, DmChungDto>();
    private List<KhachHangDto> KhachHangDtos = new List<KhachHangDto>();
    private SfComboBox<int?, KhachHangDto> ddKH = new SfComboBox<int?, KhachHangDto>();
    private bool ShowModalTaoMoiKH = false;
    private List<QuyenSoDto> QuyenSoDtos = new List<QuyenSoDto>();
    private SfComboBox<string?, QuyenSoDto> ddQS = new SfComboBox<string?, QuyenSoDto>();
    private List<NgoaiTeDto> NgoaiTeDtos = new List<NgoaiTeDto>();
    private SfComboBox<int?, NgoaiTeDto> ddNT = new SfComboBox<int?, NgoaiTeDto>();
    private bool CheckNgoaiTe = false;
    private SfGrid<PhieuNhapKhoCtRequest> SfGridPhieuNhapKhoCt = new SfGrid<PhieuNhapKhoCtRequest>();
    private List<PhieuNhapKhoCtRequest> PhieuNhapKhoCtRequests = new List<PhieuNhapKhoCtRequest>();
    private List<VatTuDto> VatTuDtos = new List<VatTuDto>();
    private SfComboBox<int?, VatTuDto> ddVTCt = new SfComboBox<int?, VatTuDto>();
    private VatTuDto SelectVatTuCt = new VatTuDto();
    private bool CheckOnChangeValueVatTuCt = false;

    private List<KhoDto> KhoDtos = new List<KhoDto>();
    private SfComboBox<int?, KhoDto> ddK = new SfComboBox<int?, KhoDto>();
    private SfComboBox<int?, KhoDto> ddKCt = new SfComboBox<int?, KhoDto>();
    private KhoDto SelectKhoCt = new KhoDto();
    private bool CheckOnChangeValueKhoCt = false;
    private List<TaiKhoanDto> TaiKhoanDtos = new List<TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKNCt = new SfComboBox<int?, TaiKhoanDto>();
    private SfComboBox<int?, TaiKhoanDto> ddTKCCt = new SfComboBox<int?, TaiKhoanDto>();
    private TaiKhoanDto SelectGhiNoTaiKhoanCt = new TaiKhoanDto();
    private bool CheckOnChangeValueGhiNoTaiKoanCt = false;
    private TaiKhoanDto SelectGhiCoTaiKhoanCt = new TaiKhoanDto();
    private bool CheckOnChangeValueGhiCoTaiKoanCt = false;
    private List<BoPhanHTDto> BoPhanHTDtos = new List<BoPhanHTDto>();
    private SfComboBox<int?, BoPhanHTDto> ddBPHTCt = new SfComboBox<int?, BoPhanHTDto>();
    private BoPhanHTDto SelectBoPhanHtCt = new BoPhanHTDto();
    private bool CheckOnChangeValueBoPhanHtCt = false;
    private List<VuViecDto> VuViecDtos = new List<VuViecDto>();
    private SfComboBox<int?, VuViecDto> ddVVCt = new SfComboBox<int?, VuViecDto>();
    private VuViecDto SelectVuViecCt = new VuViecDto();
    private bool CheckOnChangeValueVuViecCt = false;
    private List<DmMaPhiDto> DmMaPhiDtos = new List<DmMaPhiDto>();
    private SfComboBox<int?, DmMaPhiDto> ddMPCt = new SfComboBox<int?, DmMaPhiDto>();
    private DmMaPhiDto SelectDmMaPhiCt = new DmMaPhiDto();
    private bool CheckOnChangeValueDmMaPhiCt = false;
    // Thông báo message
    private bool ShowModalMessage = false;
    private bool CheckMessage = false;
    private string? TextMessage { set; get; }
    private bool IsDeleteMessage { set; get; }
    private bool IsConfirmMessage { set; get; }
    // Thông báo message end
    //Footer menu
    public string? NewId { set; get; }
    public bool IsDisabled { set; get; } = false;
    public bool IsSaveDisabled { set; get; }
    public bool IsCancelDisabled { set; get; }
    public bool IsAddDisabled { set; get; } = true;
    public bool IsEditDisabled { set; get; } = true;
    public bool IsDeleteDisabled { set; get; } = true;
    public bool IsPrintDisabled { set; get; } = true;
    public bool IsCopyDisabled { set; get; } = true;
    public bool IsCloseDisabled { set; get; } = true;
    public bool IsNextDisabled { set; get; } = true;
    private Dictionary<string, object> GridAttributes { get; set; } = new Dictionary<string, object>();
    public List<PhieuNhapKhoDto> PhieuNhapKhoDtos = new List<PhieuNhapKhoDto>();
    private int CurrentIndex = 0;
    //Footer menu end

    protected override async Task OnInitializedAsync()
    {
        if (!hasRefreshed)
        {
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);

            if (queryParams["copyId"] != null)
            {
                NewId = queryParams["copyId"];
            }
            if (NewId != null)
            {
                await RefreshAsync();
                await DefaultData(CurrentIndex, true);
                if (QuyenSoDtos.Count > 0)
                    this.DefaultValueQuyenSo(QuyenSoDtos);
            }
            else
            {
                ChiNhanhDtos = await _chiNhanh.GetListAsync();
                if (ChiNhanhDtos.Count > 0)
                    this.DefaultValueChiNhanh(ChiNhanhDtos);
                MaGiaoDichDtos = await _dmChung.GetListAsync(SystemConstants.DmChung.GiaoDichNhapKho);
                if (MaGiaoDichDtos.Count > 0)
                    this.DefaultValueMaGiaDich(MaGiaoDichDtos);
                KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai0);
                QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.PhieuNhapKho);
                if (QuyenSoDtos.Count > 0)
                    this.DefaultValueQuyenSo(QuyenSoDtos);
                NgoaiTeDtos = await _ngoaiTe.GetListAsync();
                if (NgoaiTeDtos.Count > 0)
                    await this.DefaultValueNgoaiTe(NgoaiTeDtos);
                VatTuDtos = await _vatTu.GetListAsync(string.Empty);
                KhoDtos = await _kho.GetListAsync();
                this.DefaultValueKhoXuatNVL(KhoDtos);
                TaiKhoanDtos = await _taiKhoan.GetListAsync();
                BoPhanHTDtos = await _boPhanHT.GetListAsync();
                VuViecDtos = await _vuViec.GetListAsync();
                DmMaPhiDtos = await _dmMaPhi.GetListAsync();
            }
            hasRefreshed = true;
        }
    }
    private async Task OnKeyUp(KeyboardEventArgs args)
    {
        if (args.Key == "F4")
        {
            await this.SfGridPhieuNhapKhoCt.AddRecordAsync();

        }
        else if (args.Key == "F8")
        {
            await this.SfGridPhieuNhapKhoCt.DeleteRecordAsync();
            await ddKH.FocusAsync();
        }
        else if (args.Key == "F9")
        {
            await this.SfGridPhieuNhapKhoCt.CloseEditAsync();
            await ddKH.FocusAsync();
        }

    }
    private async Task FocusOnInput()
    {
        await ddKH.FocusAsync();
    }
    private async Task ClickFocus()
    {
        await ddKH.FocusAsync();
    }
    private async Task AddRowCtAsync()
    {
        await this.SfGridPhieuNhapKhoCt.AddRecordAsync();
    }
    private async Task DeleteRowCtAsync()
    {
        await this.SfGridPhieuNhapKhoCt.DeleteRecordAsync();
    }
    private async Task CancelCtAsync()
    {
        await this.SfGridPhieuNhapKhoCt.CloseEditAsync();
    }
    public async Task OnFilteringChiNhanh(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "ChiNhanhUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "ChiNhanhNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddCN.FilterAsync(ChiNhanhDtos, query);
    }
    private void OnValueChangeChiNhanh(ChangeEventArgs<int?, ChiNhanhDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuNhapKho.ChiNhanhNm = args.ItemData.ChiNhanhNm;
        }

    }
    public async Task OnFilteringMaGiaoDich(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "DMChungUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "DMChungNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddGD.FilterAsync(MaGiaoDichDtos, query);
    }
    private void OnValueChangeMaGiaoDich(ChangeEventArgs<int?, DmChungDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuNhapKho.GiaoDichNm = args.ItemData.DMChungNm;
        }
    }
    public async Task OnFilteringKhachHang(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhachHangUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhachHangNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKH.FilterAsync(KhachHangDtos, query);
    }
    private void OnValueChangeKhachHang(ChangeEventArgs<int?, KhachHangDto> args)
    {
        if (args.ItemData != null)
        {
            SelectPhieuNhapKho.DiaChi = args.ItemData.DiaChi;
            SelectPhieuNhapKho.KhachHangNm = args.ItemData.KhachHangNm;
        }
    }
    public async Task OnFilteringQuyenSo(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "MaCt", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "SoQuyen", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddQS.FilterAsync(QuyenSoDtos, query);
    }
    private void OnValueChangeQuyenSo(ChangeEventArgs<string, QuyenSoDto> args)
    {
        if (args.ItemData != null)
        {
            string sokiTu0 = args.ItemData.SoKyTu0.HasValue ? "D" + args.ItemData.SoKyTu0.ToString() : "D0";
            SelectPhieuNhapKho.SoCt = args.ItemData.SoCtHienTai.HasValue ? (args.ItemData.SoCtHienTai.Value + 1).ToString(sokiTu0) : "0";
        }
    }
    public async Task OnFilteringNgoaiTe(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "NgoaiTeUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "NgoaiTeNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddNT.FilterAsync(NgoaiTeDtos, query);
    }
    private async void OnValueChangeNgoaiTe(ChangeEventArgs<int?, NgoaiTeDto> args)
    {
        if (args.ItemData != null)
        {
            if (args.ItemData.NgoaiTeUd != "VND")
            {
                CheckNgoaiTe = true;
            }
            else
            {
                CheckNgoaiTe = false;
            }
            SelectPhieuNhapKho.NgoaiTeId = args.ItemData.Id;
            var ngoaiTe = await _ngoaiTe.GetByIdAsync(args.ItemData.Id);
            var item = ngoaiTe.TyGiaNgoaiTeDtos?.First();
            SelectPhieuNhapKho.TyGia = item?.TyGia;
            this.SfGridPhieuNhapKhoCt?.Refresh();
            StateHasChanged();
        }
    }
    private async Task OnValueChangeNgayht(ChangedEventArgs<DateTime?> args)
    {
        DateTime? tuNgay = await _localStorage.GetItemAsync<string>("TuNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("TuNgayLamViec")) : null;
        DateTime? denNgay = await _localStorage.GetItemAsync<string>("DenNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("DenNgayLamViec")).AddDays(1) : null;
        if (args.Value.HasValue && args.Value >= tuNgay && args.Value < denNgay)
        {
            SelectPhieuNhapKho.NgayLap = args.Value;
        }
        else
        {
            SelectPhieuNhapKho.NgayHT = null;
            TextMessage = "Ngày hạch toán phải nằm trong thời gian làm việc !";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }
    private async Task SaveAsync()
    {
        await this.SfGridPhieuNhapKhoCt.EndEditAsync();
        List<SoCaiRequest> SoCaiRequests = new List<SoCaiRequest>();
        if (PhieuNhapKhoCtRequests.Count > 0)
        {
            foreach (var item in PhieuNhapKhoCtRequests)
            {
                var soCai1 = new SoCaiRequest()
                    {
                        MaNk = SystemConstants.LoaiPhieu.PhieuNhapKho,
                        MaGd = SelectPhieuNhapKho.GiaoDichId,
                        NgayHt = SelectPhieuNhapKho.NgayHT,
                        NgayLap = SelectPhieuNhapKho.NgayLap,
                        SoCt = SelectPhieuNhapKho.SoCt,
                        KhachHangId = SelectPhieuNhapKho.KhachHangId,
                        DienGiai = SelectPhieuNhapKho.DienGiai,
                        NhomDinhKhoan = SystemConstants.NhomDinhKhoan.Von,
                        Tk = item.GhiNoTK,
                        TkDoiUng = item.GhiCoTK,
                        NgoaiTeId = SelectPhieuNhapKho.NgoaiTeId,
                        TyGia = SelectPhieuNhapKho.TyGia,
                        TyGiaHt = SelectPhieuNhapKho.TyGia,
                        TyGiaHt2 = SelectPhieuNhapKho.TyGia,
                        PhatSinhNo = item.GiaVND,
                        PhatSinhCo = 0,
                        PhatSinhNoVND = item.Gia,
                        PhatSinhCoVND = 0,
                        VuViecId = item.VuViecId,
                        MaPhiId = item.MaPhiId,
                        MaTD01 = item.MaTD01,
                        MaTD02 = item.MaTD02,
                        MaTD03 = item.MaTD03,
                        DieuChinhThueTNDNId = item.DieuChinhThueTNDNId
                    };
                SoCaiRequests.Add(soCai1);
                var soCai2 = new SoCaiRequest()
                    {
                        MaNk = SystemConstants.LoaiPhieu.PhieuNhapKho,
                        MaGd = SelectPhieuNhapKho.GiaoDichId,
                        NgayHt = SelectPhieuNhapKho.NgayHT,
                        NgayLap = SelectPhieuNhapKho.NgayLap,
                        SoCt = SelectPhieuNhapKho.SoCt,
                        KhachHangId = SelectPhieuNhapKho.KhachHangId,
                        DienGiai = SelectPhieuNhapKho.DienGiai,
                        NhomDinhKhoan = SystemConstants.NhomDinhKhoan.Von,
                        Tk = item.GhiCoTK,
                        TkDoiUng = item.GhiNoTK,
                        NgoaiTeId = SelectPhieuNhapKho.NgoaiTeId,
                        TyGia = SelectPhieuNhapKho.TyGia,
                        TyGiaHt = SelectPhieuNhapKho.TyGia,
                        TyGiaHt2 = SelectPhieuNhapKho.TyGia,
                        PhatSinhNo = 0,
                        PhatSinhCo = item.GiaVND,
                        PhatSinhNoVND = 0,
                        PhatSinhCoVND = item.Gia,
                        VuViecId = item.VuViecId,
                        MaPhiId = item.MaPhiId,
                        MaTD01 = item.MaTD01,
                        MaTD02 = item.MaTD02,
                        MaTD03 = item.MaTD03,
                        DieuChinhThueTNDNId = item.DieuChinhThueTNDNId
                    };
                SoCaiRequests.Add(soCai2);
            }
            SelectPhieuNhapKho.PhieuNhapKhoCtRequests = PhieuNhapKhoCtRequests;
            SelectPhieuNhapKho.SoCaiRequests = SoCaiRequests;
            SelectPhieuNhapKho.LoaiPhieu = SystemConstants.LoaiPhieu.PhieuNhapKho;
            var result = await _phieuNhapKho.CreateAsync(SelectPhieuNhapKho);
            if (result.Id.HasValue && result.Id > 0)
            {
                if (SelectPhieuNhapKho.QuyenSo != null && SelectPhieuNhapKho.SoCt != null)
                {
                    await _quyenSo.UpdateSoCTAsync(SystemConstants.LoaiPhieu.PhieuNhapKho, SelectPhieuNhapKho.QuyenSo, SelectPhieuNhapKho.SoCt);
                }
                NewId = result.Id.ToString();
                ScreenDisable();

            }
            else
            {
                TextMessage = result.Message;
                CheckMessage = false;
                IsDeleteMessage = false;
                IsConfirmMessage = false;
                ShowModalMessage = true;
            }
        }
        else
        {
            TextMessage = "Hãy nhập chi tiết hạch toán!";
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
            ShowModalMessage = true;
        }
    }

    private void DefaultValueChiNhanh(List<ChiNhanhDto> chiNhanhDtos)
    {
        var item = chiNhanhDtos.FirstOrDefault();
        SelectPhieuNhapKho.ChiNhanhId = item?.Id;
        SelectPhieuNhapKho.ChiNhanhNm = item?.ChiNhanhNm;
    }
    private void DefaultValueMaGiaDich(List<DmChungDto> maGiaoDichDtos)
    {
        var item = maGiaoDichDtos.FirstOrDefault(x => x.DMChungUd == "4");
        SelectPhieuNhapKho.GiaoDichId = item?.Id;
        SelectPhieuNhapKho.GiaoDichNm = item?.DMChungNm;
    }

    private void DefaultValueQuyenSo(List<QuyenSoDto> quyenSoDtos)
    {
        var item = quyenSoDtos.FirstOrDefault(x => x.IsUser == true);
        if (item != null)
        {
            SelectPhieuNhapKho.QuyenSo = item.SoQuyen;
            string sokiTu0 = item.SoKyTu0.HasValue ? "D" + item.SoKyTu0.ToString() : "D0";
            SelectPhieuNhapKho.SoCt = item.SoCtHienTai.HasValue ? (item.SoCtHienTai.Value + 1).ToString(sokiTu0) : "0";
        }
        else
        {
            item = quyenSoDtos.First();
            SelectPhieuNhapKho.QuyenSo = item.SoQuyen;
            string sokiTu0 = item.SoKyTu0.HasValue ? "D" + item.SoKyTu0.ToString() : "D0";
            SelectPhieuNhapKho.SoCt = item.SoCtHienTai.HasValue ? (item.SoCtHienTai.Value + 1).ToString(sokiTu0) : "0";
        }
    }
    private async Task DefaultValueNgoaiTe(List<NgoaiTeDto> ngoaiTeDtos)
    {
        var ngoaiTe = ngoaiTeDtos.FirstOrDefault(x => x.NgoaiTeUd == "VND");
        if (ngoaiTe != null)
        {
            SelectPhieuNhapKho.NgoaiTeId = ngoaiTe.Id;
            var tyGiaNgoaiTe = await _ngoaiTe.GetByIdAsync(ngoaiTe.Id);
            SelectPhieuNhapKho.TyGia = tyGiaNgoaiTe.TyGiaNgoaiTeDtos?.First().TyGia;
            StateHasChanged();//cập nhật giao diện ngay tức thì
        }
    }
    private void DefaultValueKhoXuatNVL(List<KhoDto> khos)
    {
        var item = khos.FirstOrDefault();
        SelectPhieuNhapKho.KhoXuatNVLId = item?.Id;
        SelectPhieuNhapKho.KhoXuatNVLUd = item?.KhoUd;
    }
    private void ActionBeginPhieuNhapKhoCt(ActionEventArgs<PhieuNhapKhoCtRequest> arg)
    {
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (arg.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            int? maxId = PhieuNhapKhoCtRequests?.Any() == true ? PhieuNhapKhoCtRequests.Max(x => x.Id) : 0;
            arg.Data.Id = maxId + 1; // Tăng giá trị Id lên 1
        }
    }
    private void ActionCompletedPhieuNhapKhoCt(ActionEventArgs<PhieuNhapKhoCtRequest> args)
    {
        if (PhieuNhapKhoCtRequests.Count > 0)
        {
            decimal? soLuong = 0; decimal? tongTienVND = 0; decimal? tongTien = 0;

            foreach (var item in PhieuNhapKhoCtRequests)
            {
                soLuong += item.SoLuong;
                tongTienVND += item.TienVND;
                tongTien += item.Tien;
            }
            SelectPhieuNhapKho.SoLuong = soLuong;
            SelectPhieuNhapKho.TongTien = tongTien;
            SelectPhieuNhapKho.TongTienVND = tongTienVND;
        }
        else
        {
            SelectPhieuNhapKho.SoLuong = 0;
            SelectPhieuNhapKho.TongTien = 0;
            SelectPhieuNhapKho.TongTienVND = 0;
        }
    }
    private async Task CreatedVatTuCtHandler(Object args)
    {
        await ddVTCt.FocusAsync();
    }
    public async Task OnFilteringVatTuCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "VatTuUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "VatTuNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddVTCt.FilterAsync(VatTuDtos, query);
    }
    private void OnValueChangeVatTuCt(ChangeEventArgs<int?, VatTuDto> args)
    {
        CheckOnChangeValueVatTuCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectVatTuCt = args.ItemData;
        }
    }
    public async Task OnFilteringKho(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhoUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhoNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddK.FilterAsync(KhoDtos, query);
    }
    public async Task OnFilteringKhoCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "KhoUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "KhoNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddKCt.FilterAsync(KhoDtos, query);
    }
    private void OnValueChangeKhoCt(ChangeEventArgs<int?, KhoDto> args)
    {
        CheckOnChangeValueKhoCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectKhoCt = args.ItemData;
        }
    }
    private void OnValueChangeDonGiaVND()
    {
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
    }
    private void OnValueChangeDonGia()
    {
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
    }
    public async Task OnFilteringGhiNoTaiKhoanCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKNCt.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeGhiNoTaiKhoanCt(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        CheckOnChangeValueGhiNoTaiKoanCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectGhiNoTaiKhoanCt = args.ItemData;
        }
    }
    public async Task OnFilteringGhiCoTaiKhoanCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "TaiKhoanUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "TaiKhoanNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddTKCCt.FilterAsync(TaiKhoanDtos, query);
    }
    private void OnValueChangeGhiCoTaiKhoanCt(ChangeEventArgs<int?, TaiKhoanDto> args)
    {
        CheckOnChangeValueGhiCoTaiKoanCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectGhiCoTaiKhoanCt = args.ItemData;
        }
    }
    public async Task OnFilteringBoPhanHtCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "BoPhanHtUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "BoPhanHtNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddBPHTCt.FilterAsync(BoPhanHTDtos, query);
    }
    private void OnValueChangeBoPhanHtCt(ChangeEventArgs<int?, BoPhanHTDto> args)
    {
        CheckOnChangeValueBoPhanHtCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectBoPhanHtCt = args.ItemData;
        }
    }
    public async Task OnFilteringVuViecCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "VuViecUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "VuViecNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddVVCt.FilterAsync(VuViecDtos, query);
    }
    private void OnValueChangeVuViecCt(ChangeEventArgs<int?, VuViecDto> args)
    {
        CheckOnChangeValueVuViecCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectVuViecCt = args.ItemData;
        }
    }
    public async Task OnFilteringDmMaPhiCt(Syncfusion.Blazor.DropDowns.FilteringEventArgs args)
    {
        args.PreventDefaultAction = true;
        var orWhere = WhereFilter.Or(new List<WhereFilter> {
            new WhereFilter() { Field = "DmMaPhiUd", Operator = "contains", value = args.Text, IgnoreCase = true },
            new WhereFilter() { Field = "DmMaPhiNm", Operator = "contains", value = args.Text, IgnoreCase = true }
        });
        var query = new Query().Where(orWhere);
        query = !string.IsNullOrEmpty(args.Text) ? query : new Query();
        await ddMPCt.FilterAsync(DmMaPhiDtos, query);
    }
    private void OnValueChangeDmMaPhiCt(ChangeEventArgs<int?, DmMaPhiDto> args)
    {
        CheckOnChangeValueDmMaPhiCt = true;
        this.SfGridPhieuNhapKhoCt.PreventRender(false);
        if (args.ItemData != null)
        {
            SelectDmMaPhiCt = args.ItemData;
        }
    }
    // ẩn màn hình
    private void ScreenDisable()
    {
        GridAttributes["disable"] = "yes";
        IsDisabled = true;
        IsSaveDisabled = true;
        IsCancelDisabled = true;
        IsAddDisabled = false;
        IsEditDisabled = false;
        IsDeleteDisabled = false;
        IsPrintDisabled = false;
        IsCopyDisabled = false;
        IsCloseDisabled = false;
        IsNextDisabled = false;
    }
    // Hiện màn hình
    private void ScreenEnabled()
    {
        GridAttributes["disable"] = "no";
        IsDisabled = false;
        IsSaveDisabled = false;
        IsCancelDisabled = false;
        IsAddDisabled = true;
        IsEditDisabled = true;
        IsDeleteDisabled = true;
        IsPrintDisabled = true;
        IsCopyDisabled = true;
        IsCloseDisabled = true;
        IsNextDisabled = true;
    }

    // footer menu
    private void Cancel()
    {

        IsDeleteMessage = false;
        IsConfirmMessage = true;
        CheckMessage = true;
        TextMessage = "Dữ liệu trên form chưa được lưu. Bạn muốn thoát không cần lưu?";
        ShowModalMessage = true;

    }
    private async Task ConfirmCancelAsync()
    {
        ScreenDisable();
        await RefreshAsync();
        if (PhieuNhapKhoDtos.Count == 0)
            NavigationManager.NavigateTo($"{SystemConstants.UrlPath.PhieuNhapKho}", true);
        else
        {
            await DefaultData(CurrentIndex);
            ShowModalMessage = false;
            CheckMessage = false;
            IsDeleteMessage = false;
            IsConfirmMessage = false;
        }
    }
    private void CloseModalMessage()
    {
        ShowModalMessage = false;
    }
    private void Close()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.PhieuNhapKho}", true);
    }
    private void Add()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.PhieuNhapKho}/create", true);
    }
    private void Edit()
    {
        NavigationManager.NavigateTo($"{SystemConstants.UrlPath.PhieuNhapKho}/edit/{NewId}", true);
    }
    private void Delete()
    {
        ShowModalMessage = true;
        IsDeleteMessage = true;
        IsConfirmMessage = false;
        TextMessage = $"Xác nhận xóa phiếu có số chứng từ  <span style='color:red'>{SelectPhieuNhapKho.SoCt}</span>";
    }
    private async Task ConfirmDeleleAsync()
    {
        var result = await _phieuNhapKho.DeleteAsync(int.Parse(NewId != null ? NewId : "0"));
        if (result.IsSuccessed)
        {
            await RefreshAsync();
            if (PhieuNhapKhoDtos.Count == 0)
                NavigationManager.NavigateTo($"{SystemConstants.UrlPath.PhieuNhapKho}", true);
            else if (CurrentIndex > PhieuNhapKhoDtos.Count - 1)
            {
                CurrentIndex = PhieuNhapKhoDtos.Count - 1;
            }
            await DefaultData(CurrentIndex);
            ShowModalMessage = false;
        }
        else
        {
            ShowModalMessage = true;
            IsDeleteMessage = true;
            IsConfirmMessage = false;
            TextMessage = result.Message;
        }
    }
    private async Task Copy()
    {
        QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.PhieuNhapKho);
        if (QuyenSoDtos != null)
            this.DefaultValueQuyenSo(QuyenSoDtos);
        ScreenEnabled();
    }
    private async Task FirstAsync()
    {
        await RefreshAsync();
        CurrentIndex = 0;
        await DefaultData(CurrentIndex);
    }

    private async Task PreviousAsync()
    {
        if (CurrentIndex > 0)
        {
            await RefreshAsync();
            CurrentIndex--;
            await DefaultData(CurrentIndex);
        }
    }

    private async Task NextAsync()
    {
        await RefreshAsync();
        if (CurrentIndex < PhieuNhapKhoDtos.Count - 1)
        {
            CurrentIndex++;
            await DefaultData(CurrentIndex);
        }
    }

    private async Task LastAsync()
    {
        await RefreshAsync();
        CurrentIndex = PhieuNhapKhoDtos.Count - 1;
        await DefaultData(CurrentIndex);
    }
    // Footer menu end
    private async Task DefaultData(int currentIndex, bool isCheck = false)
    {
        if (currentIndex >= 0 && currentIndex < PhieuNhapKhoDtos.Count)
        {
            var id = PhieuNhapKhoDtos[currentIndex].Id;
            if (!isCheck)
            {
                NewId = id.ToString();
            }
            var phieuNhapKho = await _phieuNhapKho.GetByIdAsync(NewId != null ? int.Parse(NewId) : id);
            if (phieuNhapKho.Id != null)
            {
                SelectPhieuNhapKho = _objectMapper.Map<PhieuNhapKhoDto, PhieuNhapKhoRequest>(phieuNhapKho);
                if (NgoaiTeDtos.Count > 0 && NgoaiTeDtos.First(x => x.Id == SelectPhieuNhapKho.NgoaiTeId).NgoaiTeUd != "VND")
                    CheckNgoaiTe = true;
                else
                    CheckNgoaiTe = false;
                if (phieuNhapKho.PhieuNhapKhoCtDtos?.Count > 0)
                {
                    PhieuNhapKhoCtRequests = _objectMapper.Map<List<PhieuNhapKhoCtDto>, List<PhieuNhapKhoCtRequest>>(phieuNhapKho.PhieuNhapKhoCtDtos);
                }
            }
            else
            {
                NavigationManager.NavigateTo("error");
            }
        }
    }

    private async Task RefreshAsync()
    {
        DateTime? tuNgay = await _localStorage.GetItemAsync<string>("TuNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("TuNgayLamViec")) : null;
        DateTime? denNgay = await _localStorage.GetItemAsync<string>("DenNgayLamViec") != null ? DateTime.Parse(await _localStorage.GetItemAsync<string>("DenNgayLamViec")).AddDays(1) : null;
        if (tuNgay != null && denNgay != null)
        {
            PhieuNhapKhoDtos = await _phieuNhapKho.GetListAsync(tuNgay, denNgay);
            ChiNhanhDtos = await _chiNhanh.GetListAsync();
            MaGiaoDichDtos = await _dmChung.GetListAsync(SystemConstants.DmChung.GiaoDichNhapKho);
            KhachHangDtos = await _khachHang.GetListAsync(SystemConstants.KhachHang.Loai0);
            QuyenSoDtos = await _quyenSo.GetListAsync(SystemConstants.LoaiPhieu.PhieuNhapKho);
            NgoaiTeDtos = await _ngoaiTe.GetListAsync();
            VatTuDtos = await _vatTu.GetListAsync(string.Empty);
            KhoDtos = await _kho.GetListAsync();
            TaiKhoanDtos = await _taiKhoan.GetListAsync();
            BoPhanHTDtos = await _boPhanHT.GetListAsync();
            VuViecDtos = await _vuViec.GetListAsync();
            DmMaPhiDtos = await _dmMaPhi.GetListAsync();
        }
        else
        {
            NavigationManager.NavigateTo(SystemConstants.UrlPath.ThoiGianLamViec, true);
        }
    }
}